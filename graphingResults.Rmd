---
title: "graphingResults"
author: "Isolde Lane Shaw"
date: "2023-04-28"
output: html_document
---
#SINGLE STUDY AREA

# SETUP

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(conflicted)
library(sna)
#library(rgdal)
library(terra)
library(SpaDES)
library(data.table)
library(ggplot2) 
library(readr)
library(reshape2)
library(scales)
library(tidyr)
library(RColorBrewer)
library(dplyr)
library(forcats)
library(hrbrthemes)
library(viridis)
library(naniar)
library(raster)
library(rasterVis)
library(ggh4x)
library(egg)
library(cowplot)
 library(dplyr)
library(tidyr)
library(ggspatial)
library(paletteer)
library(tidyterra)
library(gt)
library(tidyverse)
library(COINr)

options(digits=3) #limit number of digits displayed

birdList <- sort(c("ALFL", "BBWA", "BCCH", "BOCH", "BRCR", "CMWA", "COYE", 
                  "DEJU", "GCKI", "GRAJ",  "LEFL", "MOWA", "OVEN", "PAWA",
                 "RBNU", "RCKI", "REVI", "SWTH", "TEWA", "YRWA"))
dev.new()


coloursScale <- scale_colour_paletteer_d("impressionist.colors::la_recolte_des_foins_eragny")
scale_color_paletteer_d("impressionist.colors::la_recolte_des_foins_eragny")
scale_fill_paletteer_d("impressionist.colors::la_recolte_des_foins_eragny")
classPal <- paletteer_d("impressionist.colors::la_recolte_des_foins_eragny")
# classPal <- c( "#56B4E9",  "#0072B2","black", "#F0E442", "#999999", "#CC79A7", "#E69F00","#D55E00",  "#009E73")
# 
# classPal <- c(  "#88CCEE", "#6699CC", "#CC6677",    "#AA4499",   "#882255",   "#888888","#661100", "#DDCC77", "#999933", "#117733","#44AA99","#332288")
# scales::show_col(safe_colorblind_palette)
# classPal <- viridis(12, option = "E")
#classPal <- c("royalblue4", "royalblue3", "royalblue1", "aquamarine4",  "aquamarine3",  "aquamarine1", "darkgoldenrod4", "darkgoldenrod3", "darkgoldenrod1", "darkolivegreen","darkolivegreen4",  "darkolivegreen1")
classPal <- c("#3C6987FF", "#87A5A5FF","#4B3C4BFF","#2D3C5AFF",
              "#D2D2C3FF", "#A5A587FF", "#B4783CFF", "#D2A54BFF",
              "#B4B45AFF", "#78963CFF","#1E4B3CFF","#5A695AFF")  
             
coloursLand <- classPal[1:6]
coloursFor <- classPal[7:12]
coloursAge <- "#A5A587FF"
colours1D2D <- classPal[c(1,10)]
colours2D <- classPal[10]
colours2D_alt <- classPal[12]
coloursAllSame <- c("#A5A587FF", "#A5A587FF", "#A5A587FF",
                    "#A5A587FF", "#A5A587FF", "#A5A587FF")
coloursAllSame2 <- c("#78963CFF", "#78963CFF", "#78963CFF",
                    "#78963CFF", "#78963CFF", "#78963CFF")
 

#                              "landClass_1" = "Water/Ice", - blue 
#                              "landClass_2" = "Wetland", - blue
#                              "landClass_3" = "Anthro/Exposed", - blue
#                              "landClass_4" = "Grass/Crop" , - teal
#                              "landClass_6" = "Bryoid", - teal
#                              "landClass_5" = "Shrub", - teal
#                               "landClass_0" = "Unmanaged Forest", - bright green/grey
#                              "forClass_3" = "Deciduous", - bright green 
#                              "forClass_4" = "Mixed", - bright green
#                              "forClass_5" = "Pine", - dark green
#                              "forClass_6" = "White Spruce")) + - dark green
#                              "forClass_1" = "Black Spruce", - dark green
#                              "forClass_2" = "Black Spruce Wet", - dark green



outputsDir <- checkPath("../../outputs/PSResults", create = TRUE)
inputsDir <- checkPath("../../inputs", create = TRUE)
saveLocation <- checkPath(file.path(outputsDir, "PSFigs"), create= TRUE)
rasterToMatchLocation <- file.path(inputsDir, "LCC2005_V1_4a.tif")
### STUDY AREA ONE DETAILS
studyAreaLocation <- checkPath(file.path(inputsDir, "studyArea/CH1PiecewiseSmoothing/studyArea_AB_BCR6/studyArea_AB_BCR6.shp"))
forClassRasterLocation <- checkPath(file.path(inputsDir, "forestClassRasters/vegTypesRas_AB_BCR6_2011"), create = TRUE)
ageRasterLocation <- checkPath(file.path(inputsDir, "forestClassRasters/ageRas_AB_BCR6_2011"), create = TRUE)
landClassRasterLocation <- checkPath(file.path(inputsDir, "forestClassRasters/landCoverRas_AB_BCR6_2010"), create = TRUE)

.studyAreaName <- "studyArea_AB_BCR6.shp"

spName <- c("Alder Flycatcher", "Bay-breasted Warbler", "Black-capped Chickadee",
             "Boreal Chickadee", "Brown Creeper", "Cape May Warbler", 
             "Common Yellowthroat", "Dark-eyed Junco", "Golden-crowned Kinglet",
             "Canada Jay", "Least Flycatcher", "Mourning Warbler", 
             "Ovenbird", "Palm Warbler", "Red-breasted Nuthatch", 
             "Ruby-crowned Kinglet", "Red-eyed Vireo", "Swainson’s Thrush",
             "Tennessee Warbler", "Yellow-rumped Warbler" )
spCode <- c("ALFL", "BBWA", "BCCH", 
                    "BOCH", "BRCR", "CMWA", 
                    "COYE", "DEJU", "GCKI",
                    "GRAJ",  "LEFL", "MOWA",
                    "OVEN", "PAWA", "RBNU",
                    "RCKI", "REVI", "SWTH", 
                    "TEWA", "YRWA")
spNames <- as.data.frame(spName,spCode)

```



#INPUT STUDY AREA and LANDSCAPE RASTERS

```{r inputLandscapeRasters, echo=TRUE, message=TRUE, warning=TRUE}

#INPUT STUDY AREA and LANDSCAPE RASTERS

#get rasterToMatch
    print("get rasterTomatch from local drive")
    rasterToMatch <- terra::rast(rasterToMatchLocation)
   
    
    #get StudyArea shapefile
    print("get studyArea shapefile from local drive")
    studyArea <- terra::vect(studyAreaLocation)
    
    #postProcess studyArea
    studyArea <- reproducible::postProcess(studyArea,
                                           useTerra = TRUE,
                                           fun = "terra::vect", #use the function vect
                                           targetCRS = crs(rasterToMatch), #make crs same as rasterToMatch
                                           overwrite = TRUE,
                                           verbose = TRUE)
    
    #crop and mask rasterToMatch
    rasterToMatch <- terra::mask(terra::crop(rasterToMatch, studyArea), studyArea) 
    names(rasterToMatch) <- "rasterToMatch"
    clearPlot()
    #(sim$rasterToMatch)
    plot(rasterToMatch, colNA = "grey")
    areaConversion <- 6.25
    studyAreaHa <- length(na.omit(values(rasterToMatch)))*areaConversion
    print(paste("The study area size is ", studyAreaHa, "ha", sep = ""))
    
    # get forest class raster
    print("get forClassRaster from Drive")
    forClassRaster <- terra::rast(forClassRasterLocation)
    forClassRaster <- postProcess(forClassRaster,
                                      destinationPath = getwd(),
                                     #use the function raster
                                     targetCRS = crs(rasterToMatch),
                                     fun = "terra::rast",
                                     useTerra = TRUE,
                                     #use the specified rasterToMatch to reproject to
                                     rasterToMatch = rasterToMatch,
                                     #studyArea = studyArea,
                                     useCache = getOption("reproducible.useCache", TRUE),
                                     overwrite = TRUE,
                                     verbose = TRUE)
    
    names(forClassRaster) <- c("forClassRaster")
    
    forClassRaster[forClassRaster == 0] <- NA
    
      clearPlot()
    # Plot(forClassRaster, na.color= "grey")
    plot(forClassRaster, colNA = "grey")
    #get non forest raster
    print("get landClassRaster from Drive")
    landClassRaster <- terra::rast(landClassRasterLocation)
    landClassRaster <- postProcess(landClassRaster,
                               destinationPath = getwd(),
                               #use the function raster
                               fun = "terra::rast",
                               targetCRS = crs(rasterToMatch),
                               #use the specified rasterToMatch to reproject to
                               rasterToMatch = rasterToMatch,
                               useTerra = TRUE,
                               #studyArea = sim$studyArea,
                               useCache = getOption("reproducible.useCache", TRUE),
                               overwrite = TRUE,
                               verbose = TRUE)
    
    #landClassRaster[landClassRaster == 0] <- NA
    
    names(landClassRaster) <- c("landClassRaster")
    landClassRaster <- terra::mask(landClassRaster, forClassRaster, inverse = TRUE)
    # landClassRaster <- overlay(x = landClassRaster,
    #                         y = forClassRaster,
    #                         fun = function(x, y) {
    #                           x[!is.na(y[])] <- NA
    #                           return(x)
    #                         })
    # 
     clearPlot()
    # Plot(landClassRaster, na.color= "grey")
    plot(landClassRaster, colNA = "grey")
   
     #get age raster
    print("get ageRaster from Drive")
    ageRaster <- terra::rast(ageRasterLocation)
    ageRaster <- postProcess(ageRaster,
                                destinationPath = getwd(),
                                #use the function raster
                                useTerra = TRUE,
                                fun = "terra::rast",
                                #targetCRS = crs(rasterToMatch),
                                #use the specified rasterToMatch to reproject to
                                rasterToMatch = rasterToMatch,
                                #studyArea = studyArea,
                                useCache = getOption("reproducible.useCache", TRUE),
                                overwrite = TRUE,
                                verbose = TRUE)
    
    names(ageRaster) <- c("ageRaster")
    plot(ageRaster, colNA = "grey")
# 
# #make landscape raster
#   print("make landscapeRaster")
#   landscapeRaster <- terra::cover(x = forClassRaster, y = landClassRaster)
#   
#   names(landscapeRaster) <- c("landscapeRaster")
#   
#   # clearPlot()
#   # Plot(landscapeRaster, na.color= "grey")
#  plot(landscapeRaster, colNA = "turquoise")
# 
# #create a raster that gives if an area is forest or not 
#   #(0 for non-forest, 1 for forest)
#   #This will allow me to have a value in the birdDataset 
#   #that says if a cell was forested or not
#   print("make FNFRaster")
#   #make forest 1
#   uniqueValsFR <- terra::unique(forClassRaster,incomparables=FALSE)
#   newValsFR <-  as.factor(rep("1", length(uniqueValsFR$forClassRaster))) #make vector that repeats 1 as amy times as there are unique values
#   newValsFR <- cbind(uniqueValsFR$forClassRaster, newValsFR)
#   newValsFR <- na.omit(newValsFR)
#   reclassMatrixFR <- matrix(newValsFR,
#                             ncol=2, byrow = FALSE)
#   rasterFR <- terra::classify(forClassRaster,
#                          reclassMatrixFR)
#   #make nonFor 0
#   #valsNF <- unique(sim$rasterToMatch) #get vector of all the unique values in the forClassRaster
#   uniqueValsNF <- terra::unique(rasterToMatch, incomparables=FALSE)
#   newValsNF <-  rep(0, length(uniqueValsNF$rasterToMatch)) #make vector that repeats 0 as amy times as there are unique values
#   newValsNF <- cbind(uniqueValsNF$rasterToMatch, newValsNF)
#   newValsNF <- na.omit(newValsNF)
#   reclassMatrixNF <- matrix(newValsNF,
#                             ncol=2, byrow = FALSE)
#   rasterNF <- terra::classify(rasterToMatch,
#                          reclassMatrixNF)
#   
#   FNFRaster <- terra::cover(x = rasterFR, y = rasterNF)
#   
#   names(FNFRaster) <- c("FNFRaster")
#   plot(FNFRaster, colNA = "grey")
# 
# allLandRasters <- c( forClassRaster, landClassRaster, landscapeRaster, 
#                      ageRaster, FNFRaster, rasterToMatch)
    
```



##summary landscape plots

```{r singlelandscapeSummaryPlots, echo=FALSE}

 
  
    ## take the values from the rasters and input 
    ## them to a data table called cellValues
    allLandData <- data.table(terra::values(c(forClassRaster, 
                                              landClassRaster, 
                                              ageRaster,
                                              rasterToMatch)))
    allLandData <- setnames(allLandData, c( "forClass", 
                                            "landClass", 
                                            "age",
                                            "LCC05"))
    
    allLandData <- allLandData[, FoLRaster := ifelse(!is.na(landClass) & !is.na(forClass), "forClass", 
                                      ifelse(!is.na(landClass), "landClass",
                                      ifelse(!is.na(forClass), "forClass", NA)))]
    allLandData <- allLandData[!is.na(FoLRaster)] #get rid of cells with no forest or land class data.
 
     #make column giving the land or forest class for each row. 
    allLandData <- allLandData[, landForClass := coalesce(forClass, landClass)]
    #in case there are classes named the same in both rasters, combine the landForClass and FoLRaster data to make sure each class is unique
    allLandData <- unite(allLandData, 
                        landForClass, 
                        c(FoLRaster, 
                          landForClass), 
                        remove=FALSE)
  
    allLandData$foLRaster <- as.factor(allLandData$FoLRaster)
    allLandData$landForClass <- as.factor(allLandData$landForClass)
     allLandData$LCC05 <- as.factor(allLandData$LCC05)
     
     
     #get rid of any rows with NA values
    allLandData <- subset(allLandData, !is.na(landForClass)) 
   #allLandData <- na.omit(allLandData, cols = "ageraster")   
   
    allLandData <- as.data.table(allLandData)
 
 #sort(unique(allLandData$landForClass)) #this shows us that there are nonForestedAreas with no landscapeRaster


 #check that there are no unwanted overlaps for nonForest raster
 nonForDat <- na.omit(allLandData, cols = "landClass")
 unique(nonForDat$forClass)
 sort(unique(nonForDat$landForClass))
  sort(unique(nonForDat$age))
  sort(unique(nonForDat$FoLRaster))
  sort(unique(nonForDat$LCC05) )

   #check that there are no unwanted overlaps for nonForest raster
  forClassDat <- na.omit(allLandData, cols = "forClass")
 unique(forClassDat$landClass)
  sort(unique(forClassDat$landForClass))
  sort(unique(forClassDat$age))
    unique(forClassDat$FoLRaster)
    sort(unique(forClassDat$LCC05))
  
 landDatStats <- allLandData[order(FoLRaster, 
                                         landForClass) 
                                   # order the rows by the land cover class
                                   ][,list(classCount = .N
                                           ),
                                           by = list(FoLRaster, 
                                         landForClass)]
     
     
     landDatStats[ , propArea := classCount/sum(classCount)]
     
###############################################################################################################################################################################################################################################################################################################################################################
    

# make bar chart of different landForClass
    #classDat <- landDatStats[-8,]

#specify class level order
landDatStats$landForClass = factor(landDatStats$landForClass, 
                                             levels = c("landClass_1", 
                                                        "landClass_2", 
                                                        "landClass_3",
                                                        "landClass_4", 
                                                        "landClass_6",
                                                        "landClass_5", 
                                                        "landClass_0",
                                                        "forClass_3",
                                                        "forClass_4",
                                                        "forClass_5",
                                                        "forClass_6",
                                                        "forClass_1", 
                                                        "forClass_2"))
                                                        

    plotClassCounts <- ggplot(data = landDatStats,
                              aes(x = landForClass,
                                  y = propArea,
                                  #fill = landForClass
                                  )) +
       # scale_fill_viridis(option = "E", discrete = TRUE) +
       #scale_fill_manual(values = classPal) +
    geom_bar(stat = "identity",
             position = "dodge",
             width = 0.7, 
             fill = coloursAge) +
    theme_minimal() +
    labs(tag = "(a)") +
      #ggtitle(paste0("Proportional area by cover class")) +
    ylab("Proportion of study area") +
    scale_y_continuous(breaks= pretty_breaks()) +
    #scale_fill_manual(values= "#009E73") +
   scale_x_discrete(labels=c("landClass_0" = "Unmanaged\n Forest", 
                             "landClass_1" = "Water/Ice", 
                             "landClass_2" = "Wetland", 
                             "landClass_3" = "Anthro/\nExposed", 
                             "landClass_4" = "Grass/\nCrop" , 
                             "landClass_5" = "Shrub", 
                             "landClass_6" = "Bryoid", 
                             "forClass_1" = "Black \nSpruce", 
                             "forClass_2" = "  Black  \nSpruce Wet",
                             "forClass_3" = "Deciduous",  
                             "forClass_4" = "Mixed",
                             "forClass_5" = "Pine",
                             "forClass_6" = "White \nSpruce")) +
    theme(title = element_text(size = 11),
        axis.text.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 10),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_blank(),
        plot.margin = margin(0,0.5,0,0.1, "cm"),
        legend.position="NULL")
 plotClassCounts   

 
 
 

  

######################################################################################################################################################################################################################################
  
 

 forClassDat_age <- subset(forClassDat, !is.na(age)) 


 #assign age class column
 ageGrouping <- 10
 maxAgeClass <- 17
 maxAge <- max(forClassDat_age$age) #get age of oldest cell 
 maxAgeClassAge <- maxAgeClass*ageGrouping 
 
     ifelse(maxAge > maxAgeClassAge, age <- c(0:maxAge), age <- c(0:maxAgeClassAge)) #make a vector that counts from 0 to 
  maxAge <-   as.numeric(maxAge)
 noAgeClasses <- maxAge/ageGrouping
 ageClass <- ifelse(noAgeClasses < maxAgeClass, ageClass <- maxAgeClass, ageClass <- noAgeClasses )
    ageClass <- rep(1:ageClass, each = ageGrouping)
    ageClass <- c(1, ageClass)
    if(noAgeClasses > maxAgeClass){
      ageClassDiff <- noAgeClasses - maxAgeClass
      extraClass <- maxAgeClass + (1:ageClassDiff)
      for (x in extraClass) {
        print(x)
        ageClass <- replace(ageClass ,ageClass== x,maxAgeClass)
              } 
    }
 
 ageRefTab <- cbind(age, ageClass) #creates a lookup table of age to age class
 ageRefTab <- as.data.table(ageRefTab)
 ageRefTab$age <- as.integer(ageRefTab$age)
 ageRefTab$ageClass <- as.integer(ageRefTab$ageClass)
 ageRefTab
 #allLandData$ageClass = allLandData$ageRaster #replicate age data in new column
 
 #replace ages with ageClass in ageClass column
 # new <- allLandData
 # new[] <- lapply(allLandData, function(x) ageRefTab$ageClass[match(x, ageRefTab$ageRaster)])
# ageClassTab[] <- ageRefTab$ageClass[match(unlist(allLandData), ageRefTab$ageRaster)]


 forClassDat_age$age <- as.integer(forClassDat_age$age)
 #storeDat <- allLandData
forClassDat_age %>% pivot_longer(cols = "age")
 forClassDat_age <-  forClassDat_age %>% left_join(ageRefTab, by = "age") 
   #allLandData %>% pivot_wider(key = ageRaster, value = ageClass)
  head(forClassDat_age)
 
 forClassStats_age <- forClassDat_age[order(ageClass)
                                  # order the rows by the land cover class
                                  ][,list(classCount = .N
                                          ),
                                          by = ageClass
                                        ]

   forClassStats_age[ , propArea := classCount/sum(classCount)]
   forClassStats_age
  #AB9 <- list( 9, 0, 0)
  # AB10 <- list(10, 0, 0)
  #  forClassStats_age <- rbind(forClassStats_age, AB10)
   #forClassStats_age
  #forClassStats_age <- rbind(forClassStats_age, )
  # 
 # landDatStats_AB <- allLandData_AB[order(FNFRaster, 
  #                                        landForClass) 
  #                                  # order the rows by the land cover class
  #                                  ][,list(classCount = .N
  #                                          ),
  #                                          by = list(FNFRaster, 
  #                                        landForClass)]
  #    
  #    studyArea <- rep("AB", each = nrow(landDatStats_AB))
  #    landDatStats_AB <-cbind(landDatStats_AB, studyArea) 
  #    
  #    landDatStats_BC <- allLandData_BC[order(FNFRaster, 
  #                                        landForClass) 
  #                                  # order the rows by the land cover class
  #                                  ][,list(classCount = .N),
  #                                          by = list(FNFRaster, 
  #                                        landForClass)]
  #    
  #    studyArea <- rep("BC", each = nrow(landDatStats_BC))
  #    landDatStats_BC <-cbind(landDatStats_BC, studyArea) 
  #     
  #   landDatStats <- rbind(landDatStats_AB, landDatStats_BC)
  #   landDatStats[ , propArea := classCount/sum(classCount), by = studyArea]
 
# make histogram of ages
  #landDatNoNAs <- na.omit(allLandData)
#   class.labs <- c("Forested", "Water/Ice", "Wetland", "Anthro/Exposed", "Grass/Crop", "Shrub", "Bryoid", "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce")
# names(class.labs) <- c("0_0", "0_1", "0_2", "0_3", "0_4", "0_5", "0_6", "1_1", "1_2", "1_3", "1_4", "1_5", "1_6", "1_7")


  # ggplot(aes(x = hwy)) +
  # #geom_histogram(aes(y = after_stat(count / sum(count))),binwidth=6) +
  # scale_y_continuous(labels = scales::percent)

  #ageHistDat <- na.omit(allLandData, cols = "forClassRaster")
   
 

 ageDistribution <- ggplot(data = forClassStats_age,
                              aes(x = ageClass,
                                  y = propArea
                                  )) +
    geom_bar(stat = "identity",
             position = "dodge",
             fill = coloursAge,
             width = 0.7) +
   labs(tag = "(b)") +
   #scale_fill_viridis(option = "E",discrete = TRUE) +
   #scale_fill_manual(values = coloursAge) +
    #ggtitle(paste0("Forest age class structure")) +
    xlab("Age (years)") +
    ylab("Proportion of forested area") +
    theme_minimal()+
    scale_x_discrete(labels=c("1" = "0-10", "2" = "", "3" = "21-30", "4"= "",
                              "5"= "41-50", "6"= "", "7"= "61-70", "8" = "",
                              "9" = "81-90", "10" = "", "11" = "101-110", "12" = "",
                              "13" = "121-130", "14"= "", "15"= "141-150", "16"= "",
                              "17"= "161+" ), 
                   limits=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17")) +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme(title = element_text(size = 11),
        strip.text.x = element_text(size = 10),
        strip.text.y = element_text(size = 10),
        strip.background = element_rect(
        color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        legend.title = element_blank(),
        legend.text = element_blank(),
        plot.margin = margin(0,0,0.5,0.3, "cm"),
        legend.position="NULL")
  
    ageDistribution
 
# # examine 0 class
#   class0 <- allLandData[landClassRaster == "0"]
#   class0 <- droplevels(class0)
#   list(unique(class0$LCC05))
#   
#   
#  class0Stats <- class0[order(LCC05)  
#                        ][,list(classCount = .N), 
#                                                                                       by = list(LCC05)]
#     class0Stats
#  class0Stats$LCC05 <- as.factor(class0Stats$LCC05)
#  
#     plot0Class <- ggplot(data = class0Stats,
#                               aes(x = LCC05,
#                                   y = classCount)) +
#     geom_bar(stat = "identity",
#              width = 0.7, 
#              fill = 'goldenrod2') +
#     theme_classic() +
#     ggtitle(paste0("BC - LCC05 class distribution for remaining forest class cells in non-forest raster")) +
#     xlab("LCC05 class") +
#     ylab("Pixel count") 
#   plot0Class
    
    
#     
#   #examine areas that have a 0 for FNFRaster, but NA for landscapeRaster (are in the study area, but have no data from forest raster or non-forest raster)
#   class0_NA <- allLandData[landForClass == "0_NA"]
#   class0_NA <- droplevels(class0_NA)
#   list(unique(class0_NA$LCC05))
#  
#   class0_NAStats <- class0_NA[order(LCC05)  
#                        ][,list(classCount = .N), 
#                                                                                       by = list(LCC05)]
#     class0_NAStats
#  class0_NAStats$LCC05 <- as.factor(class0_NAStats$LCC05)
#  
#     plot0_NAClass <- ggplot(data = class0_NAStats,
#                               aes(x = LCC05,
#                                   y = classCount)) +
#     geom_bar(stat = "identity",
#              width = 0.7, 
#              fill = 'goldenrod2') +
#     theme_classic() +
#     ggtitle(paste0("BC - LCC05 class distribution for areas with 0_NA class (no data from forest or non forest rasters)")) +
#     xlab("LCC05 class") +
#     ylab("Pixel count") 
#   plot0_NAClass
#     
#   plot(landscapeRaster, colNA="red") #it is possible to see a few pixels dotted across the landscapeRaster that do not have values
#   
# 
#   
# #find out LCC05 classes within each of our defined classes
# class.labs <- c("Forested", "Water/Ice", "Wetland", "Anthro/Exposed", "Grass/Crop", "Shrub", "Bryoid", "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce")
# names(class.labs) <- c("0_0", "0_1", "0_2", "0_3", "0_4", "0_5", "0_6", "1_1", "1_2", "1_3", "1_4", "1_5", "1_6", "1_7")
# 
# raster.labs <- c("Not in forest raster", "In forest raster")
# names(raster.labs) <- c("0", "1")
# 
#   histLCC05ByClass   <-  gghistogram(
#     stat = "count",
#   allLandData, x = "LCC05", 
#   fill = "FNFRaster"
#   ) +
#     facet_nested( FNFRaster + landForClass ~. ,
#                  labeller = labeller(landForClass = class.labs, FNFRaster = raster.labs),
#                   scales = 'free_y'
#                  ) +
#      ggtitle(paste0("AB - Histogram of LCC05 Value by Class")) +
#      xlab("LCC05 value") +
#      ylab("Number of pixels") +
#     theme(title = element_text(size = 16),
#         strip.text.x = element_text(size = 14),
#         strip.text.y = element_text(size = 14),
#         strip.background = element_rect(
#         color="white", fill="white", linewidth =1.5),
#         axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
#         axis.title.y = element_text(size = 14),
#         axis.title.x = element_blank(),
#         legend.title = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.position="bottom",
#         plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))
#  histLCC05ByClass 

 
 ######################################################################################################################################################################################################################################
 
 
 # make bar chart of mean age by landForClass


     ageStats <- forClassDat[order(landForClass) 
                                   # order the rows by the land cover class
                                   ][,list(classCount = .N, 
                                           meanAge = mean(age)),
                                           by = landForClass]
     
 #specify class level order 
  ageStats$landForClass = factor(ageStats$landForClass, 
                                             levels = c("landClass_1", 
                                                        "landClass_2", 
                                                        "landClass_3",
                                                        "landClass_4", 
                                                        "landClass_6",
                                                        "landClass_5", 
                                                        "landClass_0",
                                                        "forClass_3",
                                                        "forClass_4",
                                                        "forClass_5",
                                                        "forClass_6",
                                                        "forClass_1", 
                                                        "forClass_2"))   
 #ageStats <- na.omit(classDat, cols = "meanAge")    
 plotMeanAgeByClass <- ggplot(data = ageStats,
                              aes(x = landForClass,
                                  #fill = landForClass,
                                  y = meanAge)) +
    geom_bar(stat = "identity",
             position = "dodge",
             width = 0.7,
             fill = coloursAge) +
             theme_minimal() +
   # ggtitle(paste0("Mean age by forest class")) +
   labs(tag = "(c)") +
    xlab("Forest class") +
   # scale_fill_viridis(option = "E", discrete = TRUE) +
   #scale_fill_manual(values = coloursFor) +
    ylab("Mean Age (years)") +
    scale_x_discrete(labels=c("forClass_1" = "Black \nSpruce", 
                             "forClass_2" = "  Black  \nSpruce Wet",
                             "forClass_3" = "Deciduous",  
                             "forClass_4" = "Mixed",
                             "forClass_5" = "Pine",
                             "forClass_6" = "White \nSpruce")) +
  theme(title = element_text(size = 11),
        strip.text.x = element_text(size = 10),
        strip.text.y = element_text(size = 10),
        strip.background = element_rect(
        color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 10),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        plot.margin = margin(0,0.5,0,0, "cm"),
        legend.position="none")
  plotMeanAgeByClass 
  
######################################################################################################################################################################################################################################

# put landscape plots together

lay <- rbind(c(1,1), c(2,3))
landscapeSummary <- gridExtra::grid.arrange(plotClassCounts,  
                                            ageDistribution, 
                                            plotMeanAgeByClass, 
                                            layout_matrix = lay
                                               )

ggsave(file.path(saveLocation,"landscapeSummary.jpeg"), landscapeSummary, width = 16, height = 12, units = "cm")


  #    
  # allMatrixPlot <- ggarrange( plotClassCounts +
  #                             theme(title = element_blank())
  #                          ,
  #                          ageDistribution +
  #                             theme(title = element_blank())
  #                          ,
  #                          plotMeanAgeByClass+
  #                             theme(title = element_blank()),
  #                            widths = c(2, 1, 1), 
  #                            #heights = c(1, 1, 1),
  #                          #layout_matrix = lay,
  #                           nrow = 2,
  #                           #ncol = 2,
  #                          labels = c("A", "B", "C"),
  #                          label.args = list(gp=gpar(font=4, fontsize = 16), x=unit(1,"line"), hjust=1)
  #                           ) 
  
  
#   library(gridExtra)
# grid.arrange(bp, dp, vp, sc, ncol=2, nrow =2)
```


## landscape rasters maps


```{r singleStudyAreaLandscapeRasterMaps, echo=FALSE}


   #reclassify to Class Names
   fcrValue <- c(1, 2, 3, 4, 5, 6)
   fcrLabel <- c("1", "2", "3", "4", "5", "6")
   fcrLabelReclass <- c( "Black Spruce", "Black Spruce Wet", "Deciduous", "Mixed", "Pine", "White Spruce")
   fcrReclassified <- data.frame( fcrValue, fcrLabel, fcrLabelReclass)
   fcrReclassified$fcrLabelReclass <- as.factor(fcrReclassified$fcrLabelReclass)
   print(fcrReclassified)
   str(fcrReclassified)
 
  forClassRaster <- categories(forClassRaster, value=fcrReclassified, active = 2)

    
     # clearPlot()
    # Plot(forClassRaster, na.color= "grey")
    #plot(AB_forClassRaster, colNA = "grey")
    #get non forest raster
    # print("get landClassRaster from Drive")
    # landClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/landClassRaster_AB_202305.tif"))
    # landClassRaster <- postProcess(landClassRaster,
    #                            destinationPath = getwd(),
    #                            #use the function raster
    #                            fun = "terra::rast",
    #                            targetCRS = crs(rasterToMatch),
    #                            #use the specified rasterToMatch to reproject to
    #                            rasterToMatch = rasterToMatch,
    #                            useTerra = TRUE,
    #                            #studyArea = sim$studyArea,
    #                            useCache = getOption("reproducible.useCache", TRUE),
    #                            overwrite = TRUE,
    #                            verbose = TRUE)
   #reclassify to Class Names
   lcrValue <- c(0, 1, 2, 3, 4, 5, 6)
   lcrLabel <- c("0", "1", "2", "3", "4", "5", "6")
   lcrLabelReclass <- c("Unmanaged Forest", "Water/Ice", "Wetland", "Anthro/Explosed Land", "Grass/Cropland", "Shrub", "Bryoid")
   lcrReclassified <- data.frame( lcrValue, lcrLabel, lcrLabelReclass)
   lcrReclassified$lcrLabelReclass <- as.factor(lcrReclassified$lcrLabelReclass)
   print(lcrReclassified)
   str(lcrReclassified)
 
  landClassRaster <- categories(landClassRaster, value=lcrReclassified, active = 2)

    
    names(landClassRaster) <- c("landClassRaster")
    landClassRaster <- terra::mask(landClassRaster, forClassRaster, inverse = TRUE)
    # landClassRaster <- overlay(x = landClassRaster,
    #                         y = forClassRaster,
    #                         fun = function(x, y) {
    #                           x[!is.na(y[])] <- NA
    #                           return(x)
    #                         })
    # 
    # clearPlot()
    # Plot(landClassRaster, na.color= "grey")
    #plot(AB_landClassRaster, colNA = "grey")
   
    #  #get age raster
    # print("get ageRaster from Drive")
    # ageRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/ageRas_ABNew_0722.tif"))
    # ageRaster <- postProcess(ageRaster,
    #                             destinationPath = getwd(),
    #                             #use the function raster
    #                             useTerra = TRUE,
    #                             fun = "terra::rast",
    #                             #targetCRS = crs(rasterToMatch),
    #                             #use the specified rasterToMatch to reproject to
    #                             rasterToMatch = rasterToMatch,
    #                             #studyArea = studyArea,
    #                             useCache = getOption("reproducible.useCache", TRUE),
    #                             overwrite = TRUE,
    #                             verbose = TRUE)
    # 
    # names(ageRaster) <- c("ageRaster")
    # #plot(AB_ageRaster, colNA = "grey")

#make landscape raster
  print("make landscapeRaster")
  landscapeRaster <- terra::cover(x = forClassRaster, y = landClassRaster)

  names(landscapeRaster) <- c("landscapeRaster")



 plot(landscapeRaster, main = "Landscape raster", legend = TRUE, colNA = "white", axes = FALSE, box = FALSE)

studyArea <- terra::project(studyArea, y = "+proj=longlat +datum=WGS84")
forClassRaster <- terra::project(forClassRaster, y = "+proj=longlat +datum=WGS84")
forClassRaster <- crop(forClassRaster, studyArea)
 
cbPalette2 <-  c( "#56B4E9",  "#0072B2","#009E73", "#E69F00", "#999999","black")
plot(forClassRaster, main = 'Forest Class Raster', legend = TRUE, col = cbPalette2, colNA="white", axes=FALSE, box=FALSE)
# legend("bottomright", legend = c( "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce"), fill = cbPalette)

#landClassRaster
#plot(landClassRaster,colNA="grey70")
# customizing the legend

landClassRaster <- terra::project(landClassRaster, y = "+proj=longlat +datum=WGS84")
landClassRaster <- crop(landClassRaster, studyArea)

plot(landClassRaster, main = 'Land-Cover Class Raster', legend = TRUE, col = cbPalette2, colNA="white", axes=FALSE, box=FALSE)
#nf.legend <- legend("right", legend = c("0" = "Unmanaged Forest", "1" = "Water/Ice", "2" = "Wetland", "3" = "Anthro/Exposed Land", "4" = "Grass/Cropland", "5" = "Shrub", "6" = "Bryoid"), fill = cbPalette)



#ageRaster
# min_ = min(min(terra::unique(AB_ageRaster)), min(terra::unique(BC_ageRaster)))
# max_ = max(max(terra::unique(AB_ageRaster)), max(terra::unique(BC_ageRaster)))
# r.range = c(min_, max_)



ageRaster <- terra::project(ageRaster, y = "+proj=longlat +datum=WGS84")
ageRaster <- crop(ageRaster, studyArea)

plot(ageRaster, main = 'Age Raster', colNA="white", axes=FALSE, box = FALSE) 



  

```


## MAKE TABLES WITH SP AND CLASS INFO

### Sp Info Table
```{r spInfo, echo=FALSE}

commonName <- c("Alder Flycatcher", "Bay-breasted Warbler", "Black-capped Chickadee", "Boreal Chickadee", "Brown Creeper", "Cape May Warbler", "Common Yellowthroat", "Dark-eyed Junco", "Golden-crowned Kinglet", "Canada Jay", "Least Flycatcher", "Mourning Warbler", "Ovenbird", "Palm Warbler", "Red-breasted Nuthatch", "Ruby-crowned Kinglet", "Red-eyed Vireo", "Swainson’s Thrush", "Tennessee Warbler", "Yellow-rumped Warbler")

scientificName <- c("Empidonax alnorum", "Setophaga castanea", "Poecile atricapillus", "Poecile hudsonicus", "Certhia americana", "Setophaga tigrina", "Geothlypis trichas",
"Junco hyemalis", "Regulus satrapa", "Perisoreus canadensis", "Empidonax minimus", "Geothlypis philadelphia", "Seiurus aurocapilla", "Setophaga palmarum", "Sitta canadensis", "Regulus calendula", "Vireo olivaceus", "Catharus ustulatus", "Leiothlypis peregrina", "Setophaga coronata")

spInfo <- data.frame(commonName, scientificName)
names(spInfo) <- c("Common Name", "Scientific Name")

spInfoTab <- gt::gt(spInfo) |>
  tab_style(
    locations = list(
        cells_body(
        columns = "Scientific Name", rows = c(1:20)
      )
    ),
    style = list(
        cell_text(style = "italic"))
    )
 
  #tab_options(table.border.right.width = 50) |> 
 gtsave(spInfoTab, "spInfoTab.png", path = saveLocation)

```



### Class Info Table
```{r classInfo, echo=FALSE}

Class <- c("Water/Ice",
           "Wetland",
           "Anthropogenic/Exposed Land",
           "Grass/Cropland",
           "Shrubland",
           "Bryoid",
           "Unmanaged Forest",
           "Deciduous", 
           "Mixedwood",
           "Pine", 
           "White Spruce",
           "Black Spruce",
           "Black Spruce Wetland"
                     )


Description <- c("Lakes and rivers, or consistent snow/ice cover throughout the year.", 
                 "Areas of poor drainage, with vegetation but less than 5% tree cover.", 
                 "Non-forested land, no cover of any type, including rock and urban environments.", 
                 "Non-forested land. Herbaceous grassland or herbaceous cover.", 
                 "Non-forested land. Open shrubs or closed shrubs.", 
                 "Non-forested land. Bryoid cover.",
                 "Miscellaneous forest areas that are considered forest on the land cover class raster, but not the forest class raster. This class is additional to those described in Lane-Shaw, Raymundo and Cumming (2020).",
                 "Stands where combined trembling aspen, balsam poplar and white birch comprise more than 80%.", 
                 "Stands where deciduous species comprise more than 20% and combined conifer species (jack pine, lodgepole pine, white spruce, balsam fir, and black spruce) more than 20%.",
                 "Stands where combined jack pine and lodgepole pine are the leading species and deciduous species comprise less than 20%",
                 "Stands where combined white spruce and balsam fir comprise more than 80%.",
                 "Stands where black spruce is the leading species and larch = 0%, or stands where black spruce is the leading species and the combined species trembling aspen + balsam poplar + balsam fir + jack pine comprise more than 0%.",
                 "Stands where black spruce is the leading species, or stands where black spruce is the leading species and larch comprises more than 0%, or stands where black spruce is the leading species and the combined species trembling aspen + balsam poplar + balsam fir + jack pine = 0." )

classInfo <- data.frame(Class, Description)


classInfoTab <- gt::gt(classInfo) |>      
     tab_row_group(
    label = "Forest Classes",
    rows = c(8:13)
  ) |> tab_row_group(
    label = "Land Cover Classes",
    rows = c(1:7)
  ) 

classInfoTab
gtsave(classInfoTab, "classInfoTab.png", path = saveLocation, expand = 2000)

```


## PLOT MAIN 1D PREDICTION RESULTS

###make plot of 1D mean density by cover class 


```{r meanDensity1D, echo=FALSE}
#birdList <- sort(c("OVEN", "TEWA", "LEFL"))
#make plot of 1D mean density by cover class
birdPreds1D <- lapply(birdList, FUN= function(bird){

  birdPreds1D <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_", bird, "_birdPreds1D.csv", sep = "")))
  birdPreds1D$landForClass <- as.factor(birdPreds1D$landForClass)
  birdPreds1D$FoLRaster <- as.factor(birdPreds1D$FoLRaster)
  birdPreds1D$birdSp <- as.factor(birdPreds1D$birdSp)
  return(birdPreds1D)
})
names(birdPreds1D) <- birdList


 birdPreds1DSingleFrame <- rbindlist(birdPreds1D)

 
sp.labs <- c("Alder Flycatcher", "Bay-breasted Warbler", "Black-capped Chickadee",
             "Boreal Chickadee", "Brown Creeper", "Cape May Warbler", 
             "Common Yellowthroat", "Dark-eyed Junco", "Golden-crowned Kinglet",
             "Canada Jay", "Least Flycatcher", "Mourning Warbler", 
             "Ovenbird", "Palm Warbler", "Red-breasted Nuthatch", 
             "Ruby-crowned Kinglet", "Red-eyed Vireo", "Swainson’s Thrush",
             "Tennessee Warbler", "Yellow-rumped Warbler" )
names(sp.labs) <- c("ALFL", "BBWA", "BCCH", 
                    "BOCH", "BRCR", "CMWA", 
                    "COYE", "DEJU", "GCKI",
                    "GRAJ",  "LEFL", "MOWA",
                    "OVEN", "PAWA", "RBNU",
                    "RCKI", "REVI", "SWTH", 
                    "TEWA", "YRWA")

birdPreds1DSingleFrame <- rbindlist(birdPreds1D[1:20])
#birdPreds1DSingleFrame <- rbindlist(birdPreds1D[19:31])

examine1DPreds <- birdPreds1DSingleFrame[,list(meanDensity = mean(meanBirdDensity),
                                               medianDensity = median(meanBirdDensity),
                                               maxDensity = max(meanBirdDensity),
                                               minDensity = min(meanBirdDensity)
                                           ),
                                           by = birdSp][
                                             order(maxDensity)]



#specify class level order
birdPreds1DSingleFrame$landForClass = factor(birdPreds1DSingleFrame$landForClass, 
                                             levels = c("landClass_1", 
                                                        "landClass_2", 
                                                        "landClass_3",
                                                        "landClass_4", 
                                                        "landClass_6",
                                                        "landClass_5", 
                                                        "landClass_0",
                                                        "forClass_3",
                                                        "forClass_4",
                                                        "forClass_5",
                                                        "forClass_6",
                                                        "forClass_1", 
                                                        "forClass_2"))
                                                        
                             
                             
                                                      

#Make plot
plotMeanBirdDensity <- ggplot(data = birdPreds1DSingleFrame,
                              aes(x = landForClass,
                              y = meanBirdDensity,
                              fill = landForClass)) +
      facet_wrap(~ birdSp,# scales= 'free_y',
                 labeller = labeller(birdSp = sp.labs),
                 ncol = 4) +
     guides(fill=guide_legend(nrow=2, byrow=TRUE)) + 
    #scale_fill_viridis(option = "E", discrete = TRUE)+
     geom_bar(stat = "identity") +
     scale_fill_manual(values = classPal,
                    labels = c("landClass_0" = "Unmanaged \nForest",
                    "landClass_1" = "Water/Ice",
                    "landClass_2" = "Wetland",
                    "landClass_3" = "Anthro/\nExposed",
                    "landClass_4" = "Grass/\nCrop" ,
                    "landClass_5" = "Shrub",
                    "landClass_6" = "Bryoid",
                    "forClass_1" = "Black \nSpruce",
                    "forClass_2" = "Black \nSpruce Wet",
                    "forClass_3" = "Deciduous",
                    "forClass_4" = "Mixed",
                    "forClass_5" = "Pine",
                    "forClass_6" = "White \nSpruce")) +
  geom_errorbar(aes(ymin = meanBirdDensity - seBirdDensity,
                    ymax = meanBirdDensity + seBirdDensity),
                    width = .5) +
  theme_minimal() +
  ggtitle("Mean density predictions by forest or land cover class") +
  xlab("Land or Forest Class") +
  ylab("Mean Predicted Density (males per ha)") +
  scale_y_continuous(breaks= pretty_breaks()) +
  # scale_x_discrete(labels=c(
  #   "forClass_1" = "Black Spruce", 
  #                            "forClass_2" = "Black Spruce Wet",
  #                            "forClass_3" = "Deciduous",  
  #                            "forClass_4" = "Mixed",
  #                            "forClass_5" = "Pine",
  #                            "forClass_6" = "White Spruce",
  #                            "landClass_0" = "Unmanaged Forest", 
  #                            "landClass_1" = "Water/Ice", 
  #                            "landClass_2" = "Wetland", 
  #                            "landClass_3" = "Anthro/Exposed", 
  #                            "landClass_4" = "Grass/Crop" , 
  #                            "landClass_5" = "Shrub", 
  #                            "landClass_6" = "Bryoid", 
  #                            ))+
  theme(title = element_blank(),
        strip.text.x = element_text(
          size = 15),
        strip.text.y = element_text(
          size = 15),
        #legend.key.width = unit(0.5, units = "cm"),
        legend.key.size = unit(0.3, units = "cm"),
        legend.title = element_blank(),
        legend.byrow = TRUE,
        legend.position="bottom",
        legend.text = element_text(size = 12),
        strip.background = element_rect(
          color="white", fill="white", linewidth =0.001),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.title.y = element_text(size = 18),
        axis.title.x = element_text(size = 18),
        plot.margin = margin(0.3,0.2,0.2,0.2, "cm"))


plotMeanBirdDensity

ggsave(file.path(saveLocation,"1DResults.jpeg"), plotMeanBirdDensity, width = 26, height = 37, units = "cm")
#jpeg(paste(plotsLocation, "plotMeanBirdDensity1D.jpg", sep = ""))

```


###make plot of median bird density for 1D bins 

```{r medianDensity1D, echo=FALSE}

# #make plot of median bird density for 1D bins
# birdPreds1D <- lapply(birdList, FUN= function(bird){
#   birdPreds1D <- as.data.frame(read_csv(paste("Results/PS results AB 20 yr age classes boot ras/",bird, " _birdPreds1D.csv", sep = "")))
#   birdPreds1D$landForClass <- as.character(birdPreds1D$landForClass)
#   birdPreds1D$FoLRaster <- as.character(birdPreds1D$FoLRaster)
#   return(birdPreds1D)
# })
# names(birdPreds1D) <- birdList
# 
# #make dataframe of birds you want to include
# birdPreds1DSingleFrame <- rbind(birdPreds1D$BBWA, birdPreds1D$BRCR, birdPreds1D$CAWA, birdPreds1D$OVEN)
# 
# #Make plot
# plotMedianBirdDensity <- ggplot(data = birdPreds1DSingleFrame,
#                               aes(x = landForClass,
#                                   y = medianBirdDensity,
#                                   fill = FoLRaster)) +
#   facet_wrap(~ birdSp, ncol = 1, scales= 'free_y') +
#   geom_bar(stat = "identity",
#            width = 0.7) +
#   geom_errorbar(aes(ymin = medianBirdDensity - seBirdDensity, ymax = medianBirdDensity + seBirdDensity),
#                 width = .20) +
#   theme_classic() +
#   ggtitle("Median density by cover class") +
#   xlab("Cover Class") +
#   ylab("Median Density") +
#   scale_y_continuous(breaks= pretty_breaks()) +
#   scale_x_discrete(labels=c("0_0" = "Forest", "0_1" = "Water/Ice", "0_2" = "Wetland", "0_3" = "Anthro/Exposed", "0_4" = "Grass/Crop" , "0_5" = "Shrub", "0_6" = "Bryoid", "1_1" = "Black Spruce", "1_2" = "Black Spruce Wet", "1_3" = "Conifer Mix", "1_4" = "Deciduous", "1_5" = "Mixed", "1_6" = "Pine", "1_7" = "White Spruce")) +
#   scale_fill_manual(values=c("#56B4E9", "#009E73"),
#                     labels = c("Non-forest raster", "Forest raster")) +
#   theme(title = element_text(size = 14),
#         strip.text.x = element_text(
#           size = 12),
#         legend.title = element_blank(),
#         legend.position="bottom",
#         axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
#         axis.title = element_text(size = 14))
#         
# 
# plotMedianBirdDensity
# #jpeg(paste(plotsLocation, "plotMedianBirdDensity1D.jpg", sep = ""))
# 

```

## PLOT MAIN 2D PREDICTION RESULTS

### make plots of 2D bird density predictions 

```{r plotBirdMatricies, echo=FALSE}


#make plot of 2D bird density predictions

#get matricies
birdMatricies <- lapply(birdList, FUN= function(bird){
  birdMatrix <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))
  return(birdMatrix)
})
names(birdMatricies) <- birdList


matrixAsTables <- lapply(X = birdList, FUN = function(bird){
 #browser()
  matrix <-  eval(parse(text=paste("birdMatricies$", bird, sep = "")))
  matrix <- matrix[2:ncol(matrix)]
  matrix <- data.matrix(matrix)
  tab <- melt(matrix)
  colnames(tab) <- c( "forClass","ageClass", "birdDensityPred")
  birdSp <- rep(paste(bird), nrow(tab))
  maxDensity <- rep(max(tab$birdDensityPred), nrow(tab))
  tab <- cbind(tab, birdSp = birdSp, maxDensity = maxDensity)
  tab$ageClass <- as.integer(tab$ageClass)
  tab$forClass <- as.character(tab$forClass)
  tab$birdSp <- as.character(tab$birdSp)
  tab$birdDensityPred <- as.numeric(tab$birdDensityPred)
  
  print(tab)
  
  return(tab)
})

names(matrixAsTables) <- birdList

dataFrameForGraph <- rbindlist(matrixAsTables)
dataFrameForGraph <- dataFrameForGraph[order(maxDensity)]
birdSpInOrder <- unique(dataFrameForGraph$birdSp)

#make dataframe of birds you want to include
birdsWanted <- c(birdSpInOrder[1:10])
#birdsWanted <- birdSpInOrder[11:20]
dataFrameForGraph <- dataFrameForGraph[dataFrameForGraph[["birdSp"]] %in% birdsWanted]

#specify class level order
dataFrameForGraph$birdSp = factor(dataFrameForGraph$birdSp, 
                                             levels = birdsWanted)
dataFrameForGraph$forClass = factor(dataFrameForGraph$forClass, 
                                             levels = c("3",
                                                        "4",
                                                        "5",
                                                        "6",
                                                        "1", 
                                                        "2"))

#define facet labels for birds
sp.labs <- c("Alder \nFlycatcher", "Bay-breasted\n Warbler", "Black-capped\n Chickadee",
             "Boreal \nChickadee", "Brown \nCreeper", "Cape May\n Warbler", 
             "Common \nYellowthroat", "Dark-eyed\n Junco", "Golden-crowned\n Kinglet",
             "Canada\n Jay", "Least \nFlycatcher", "Mourning\n Warbler", 
             "Ovenbird", "Palm \nWarbler", "Red-breasted\n Nuthatch", 
             "Ruby-crowned\n Kinglet", "Red-eyed\n Vireo", "Swainson’s\n Thrush",
             "Tennessee\n Warbler", "Yellow-rumped\n Warbler" )
names(sp.labs) <- c("ALFL", "BBWA", "BCCH", 
                    "BOCH", "BRCR", "CMWA", 
                    "COYE", "DEJU", "GCKI",
                    "GRAJ",  "LEFL", "MOWA",
                    "OVEN", "PAWA", "RBNU",
                    "RCKI", "REVI", "SWTH", 
                    "TEWA", "YRWA")

# New facet label names for forest classes
class.labs <- c("Black \nSpruce", "Black \nSpruce Wet", "Deciduous", "Mixed", "Pine", "White \nSpruce")
names(class.labs) <- c("1", "2", "3", "4", "5", "6")



plotMeanBirdDensity2D <- ggplot(data = dataFrameForGraph,
                                aes(y= birdDensityPred, x= ageClass, fill= forClass)) + #
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid( birdSp ~ forClass,
              labeller = labeller(forClass = class.labs, birdSp = sp.labs))+
              #scales="free") +
  theme_minimal() +
  scale_fill_manual(values = coloursAllSame) +
  #scale_fill_viridis(option = "E",discrete = TRUE) +
  #ggtitle("a") +
  xlab("Forest Age (years)")  +
   scale_x_discrete(labels=c("1" = "0-10",
                              "5"= "41-50", 
                              "9" = "81-90", 
                              "13" = "121-130", 
                              "17"= "161+" ), 
                   limits=c("1", "2", "3", "4",
                            "5", "6", "7", "8", 
                            "9", "10", "11", "12", 
                            "13", "14", "15", "16", "17"),
                   breaks = c("1", "5", "9", "13", "17")) +
  ylab("Predicted Density (males per ha)") +
  scale_y_continuous(breaks= pretty_breaks(n = 4)) +#, limits=c(0, 1)) +
  #coord_trans(y="log2")+
  #scale_y_log10() +
  theme(title = element_blank(
         ),
        strip.text.x = element_text(
          size = 10),
        strip.text.y = element_text(
          size = 10),
        legend.position="none",
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.1),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        plot.margin = margin(0.2,0.1,0.1,0.1, "cm"))

# facet_bounds <- read.table(header=TRUE,
# text=
# "birdSp ymin ymax     breaks  xmin  xmax
# BBWA       0     0.08   0.02     1    10
# BRCR       0     0.25   0.05     1    10
# OVEN       0     0.25    0.05     1    10",
# stringsAsFactors=FALSE)
# 
# ff <- with(facet_bounds,
#            data.frame(birdDensityPred=c(ymin,ymax),
#                       ageClass=c(xmin,xmax),
#                       birdSp=c(birdSp,birdSp)))
# ff$ageClass <- as.character(ff$ageClass)

 #+ geom_point(data=ff,x=NA)

ggsave(file.path(saveLocation,"2DResults1.jpeg"), plotMeanBirdDensity2D, width = 18, height = 30, units = "cm")
#plotMeanBirdDensity2D#plotMeanBirdDensityforClass2D
#jpeg("plotMeanBirdDensity2D.jpg")
plotMeanBirdDensity2D
```
###### 20 yr age classes

```{r plotBirdMatricies_20, echo=FALSE}


#make plot of 2D bird density predictions

#get matricies
birdMatricies <- lapply(birdList, FUN= function(bird){
  birdMatrix <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))
  return(birdMatrix)
})
names(birdMatricies) <- birdList


matrixAsTables <- lapply(X = birdList, FUN = function(bird){
 #browser()
  matrix <-  eval(parse(text=paste("birdMatricies$", bird, sep = "")))
  matrix <- matrix[2:ncol(matrix)]
  matrix <- data.matrix(matrix)
  tab <- melt(matrix)
  colnames(tab) <- c( "forClass","ageClass", "birdDensityPred")
  birdSp <- rep(paste(bird), nrow(tab))
  maxDensity <- rep(max(tab$birdDensityPred), nrow(tab))
  tab <- cbind(tab, birdSp = birdSp, maxDensity = maxDensity)
  tab$ageClass <- as.integer(tab$ageClass)
  tab$forClass <- as.character(tab$forClass)
  tab$birdSp <- as.character(tab$birdSp)
  tab$birdDensityPred <- as.numeric(tab$birdDensityPred)
  
  print(tab)
  
  return(tab)
})

names(matrixAsTables) <- birdList

dataFrameForGraph <- rbindlist(matrixAsTables)
dataFrameForGraph <- dataFrameForGraph[order(maxDensity)]
birdSpInOrder <- unique(dataFrameForGraph$birdSp)

#make dataframe of birds you want to include
#birdsWanted <- c(birdSpInOrder[1:10])
birdsWanted <- birdSpInOrder[1:10]
dataFrameForGraph <- dataFrameForGraph[dataFrameForGraph[["birdSp"]] %in% birdsWanted]

#specify class level order
dataFrameForGraph$birdSp = factor(dataFrameForGraph$birdSp, 
                                             levels = birdsWanted)
dataFrameForGraph$forClass = factor(dataFrameForGraph$forClass, 
                                             levels = c("3",
                                                        "4",
                                                        "5",
                                                        "6",
                                                        "1", 
                                                        "2"))

#define facet labels for birds
sp.labs <- c("Alder \nFlycatcher", "Bay-breasted\n Warbler", "Black-capped\n Chickadee",
             "Boreal \nChickadee", "Brown \nCreeper", "Cape May\n Warbler", 
             "Common \nYellowthroat", "Dark-eyed\n Junco", "Golden-crowned\n Kinglet",
             "Canada\n Jay", "Least \nFlycatcher", "Mourning\n Warbler", 
             "Ovenbird", "Palm \nWarbler", "Red-breasted\n Nuthatch", 
             "Ruby-crowned\n Kinglet", "Red-eyed\n Vireo", "Swainson’s\n Thrush",
             "Tennessee\n Warbler", "Yellow-rumped\n Warbler" )
names(sp.labs) <- c("ALFL", "BBWA", "BCCH", 
                    "BOCH", "BRCR", "CMWA", 
                    "COYE", "DEJU", "GCKI",
                    "GRAJ",  "LEFL", "MOWA",
                    "OVEN", "PAWA", "RBNU",
                    "RCKI", "REVI", "SWTH", 
                    "TEWA", "YRWA")

# New facet label names for forest classes
class.labs <- c("Black \nSpruce", "Black \nSpruce Wet", "Deciduous", "Mixed", "Pine", "White \nSpruce")
names(class.labs) <- c("1", "2", "3", "4", "5", "6")



plotMeanBirdDensity2D <- ggplot(data = dataFrameForGraph,
                                aes(y= birdDensityPred, x= ageClass, fill= forClass)) + #
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid( birdSp ~ forClass,
              labeller = labeller(forClass = class.labs, birdSp = sp.labs))+
              #scales="free") +
  theme_minimal() +
  scale_fill_manual(values = coloursAllSame) +
  #scale_fill_viridis(option = "E",discrete = TRUE) +
  #ggtitle("a") +
  xlab("Forest Age (years)")  +
   scale_x_discrete(labels=c("1" = "0-20",
                              "3"= "41-60", 
                              "5" = "81-100",
                              "7" = "121-140",
                              "9"= "161+" ), 
                   limits=c("1", "2", "3", "4",
                            "5", "6", "7", "8", 
                            "9"),
                   breaks = c("1", "3", "5", "7", "9")) +
  ylab("Predicted density (male birds per hectare)") +
  scale_y_continuous(breaks= pretty_breaks(n = 4)) +#, limits=c(0, 1)) +
  #coord_trans(y="log2")+
  #scale_y_log10() +
  theme(title = element_blank(
         ),
        strip.text.x = element_text(
          size = 10),
        strip.text.y = element_text(
          size = 10),
        legend.position="none",
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.1),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        plot.margin = margin(0.2,0.1,0.1,0.1, "cm"))

# facet_bounds <- read.table(header=TRUE,
# text=
# "birdSp ymin ymax     breaks  xmin  xmax
# BBWA       0     0.08   0.02     1    10
# BRCR       0     0.25   0.05     1    10
# OVEN       0     0.25    0.05     1    10",
# stringsAsFactors=FALSE)
# 
# ff <- with(facet_bounds,
#            data.frame(birdDensityPred=c(ymin,ymax),
#                       ageClass=c(xmin,xmax),
#                       birdSp=c(birdSp,birdSp)))
# ff$ageClass <- as.character(ff$ageClass)

 #+ geom_point(data=ff,x=NA)

ggsave(file.path(saveLocation,"2DResults.jpeg"), plotMeanBirdDensity2D, width = 18, height = 30, units = "cm")
#plotMeanBirdDensity2D#plotMeanBirdDensityforClass2D
#jpeg("plotMeanBirdDensity2D.jpg")
plotMeanBirdDensity2D
```

###### 40 yr age classes

```{r plotBirdMatricies_40, echo=FALSE}


#make plot of 2D bird density predictions

#get matricies
birdMatricies <- lapply(birdList, FUN= function(bird){
  birdMatrix <- as.data.frame(read_csv(paste(outputsDir, "/5x40yrAgeClasses/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))
  return(birdMatrix)
})
names(birdMatricies) <- birdList


matrixAsTables <- lapply(X = birdList, FUN = function(bird){
 #browser()
  matrix <-  eval(parse(text=paste("birdMatricies$", bird, sep = "")))
  matrix <- matrix[2:ncol(matrix)]
  matrix <- data.matrix(matrix)
  tab <- melt(matrix)
  colnames(tab) <- c( "forClass","ageClass", "birdDensityPred")
  birdSp <- rep(paste(bird), nrow(tab))
  maxDensity <- rep(max(tab$birdDensityPred), nrow(tab))
  tab <- cbind(tab, birdSp = birdSp, maxDensity = maxDensity)
  tab$ageClass <- as.integer(tab$ageClass)
  tab$forClass <- as.character(tab$forClass)
  tab$birdSp <- as.character(tab$birdSp)
  tab$birdDensityPred <- as.numeric(tab$birdDensityPred)
  
  print(tab)
  
  return(tab)
})

names(matrixAsTables) <- birdList

dataFrameForGraph <- rbindlist(matrixAsTables)
dataFrameForGraph <- dataFrameForGraph[order(maxDensity)]
birdSpInOrder <- unique(dataFrameForGraph$birdSp)

#make dataframe of birds you want to include
#birdsWanted <- c(birdSpInOrder[1:10])
birdsWanted <- birdSpInOrder[11:20]
dataFrameForGraph <- dataFrameForGraph[dataFrameForGraph[["birdSp"]] %in% birdsWanted]

#specify class level order
dataFrameForGraph$birdSp = factor(dataFrameForGraph$birdSp, 
                                             levels = birdsWanted)
dataFrameForGraph$forClass = factor(dataFrameForGraph$forClass, 
                                             levels = c("3",
                                                        "4",
                                                        "5",
                                                        "6",
                                                        "1", 
                                                        "2"))

#define facet labels for birds
sp.labs <- c("Alder \nFlycatcher", "Bay-breasted\n Warbler", "Black-capped\n Chickadee",
             "Boreal \nChickadee", "Brown \nCreeper", "Cape May\n Warbler", 
             "Common \nYellowthroat", "Dark-eyed\n Junco", "Golden-crowned\n Kinglet",
             "Canada\n Jay", "Least \nFlycatcher", "Mourning\n Warbler", 
             "Ovenbird", "Palm \nWarbler", "Red-breasted\n Nuthatch", 
             "Ruby-crowned\n Kinglet", "Red-eyed\n Vireo", "Swainson’s\n Thrush",
             "Tennessee\n Warbler", "Yellow-rumped\n Warbler" )
names(sp.labs) <- c("ALFL", "BBWA", "BCCH", 
                    "BOCH", "BRCR", "CMWA", 
                    "COYE", "DEJU", "GCKI",
                    "GRAJ",  "LEFL", "MOWA",
                    "OVEN", "PAWA", "RBNU",
                    "RCKI", "REVI", "SWTH", 
                    "TEWA", "YRWA")

# New facet label names for forest classes
class.labs <- c("Black \nSpruce", "Black \nSpruce Wet", "Deciduous", "Mixed", "Pine", "White \nSpruce")
names(class.labs) <- c("1", "2", "3", "4", "5", "6")



plotMeanBirdDensity2D <- ggplot(data = dataFrameForGraph,
                                aes(y= birdDensityPred, x= ageClass, fill= forClass)) + #
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid( birdSp ~ forClass,
              labeller = labeller(forClass = class.labs, birdSp = sp.labs))+
              #scales="free") +
  theme_minimal() +
  scale_fill_manual(values = coloursAllSame) +
  #scale_fill_viridis(option = "E",discrete = TRUE) +
  #ggtitle("a") +
  xlab("Forest Age (years)")  +
   scale_x_discrete(labels=c("1" = "0-40",
                              "2"= "41-80", 
                              "3" = "81-120",
                              "4" = "121-160",
                              "5"= "161+" ), 
                   limits=c("1", "2", "3", "4", "5"),
                   breaks = c("1", "2", "3", "4", "5")) +
  ylab("Predicted density (male birds per hectare)") +
  scale_y_continuous(breaks= pretty_breaks(n = 4)) +#, limits=c(0, 1)) +
  #coord_trans(y="log2")+
  #scale_y_log10() +
  theme(title = element_blank(
         ),
        strip.text.x = element_text(
          size = 10),
        strip.text.y = element_text(
          size = 10),
        legend.position="none",
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.1),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        plot.margin = margin(0.2,0.1,0.1,0.1, "cm"))

# facet_bounds <- read.table(header=TRUE,
# text=
# "birdSp ymin ymax     breaks  xmin  xmax
# BBWA       0     0.08   0.02     1    10
# BRCR       0     0.25   0.05     1    10
# OVEN       0     0.25    0.05     1    10",
# stringsAsFactors=FALSE)
# 
# ff <- with(facet_bounds,
#            data.frame(birdDensityPred=c(ymin,ymax),
#                       ageClass=c(xmin,xmax),
#                       birdSp=c(birdSp,birdSp)))
# ff$ageClass <- as.character(ff$ageClass)

 #+ geom_point(data=ff,x=NA)

ggsave(file.path(saveLocation,"2DResults_40yrAgeClasses.jpeg"), plotMeanBirdDensity2D, width = 18, height = 30, units = "cm")
#plotMeanBirdDensity2D#plotMeanBirdDensityforClass2D
#jpeg("plotMeanBirdDensity2D.jpg")
plotMeanBirdDensity2D
```


### make nice tables of 2D bird density predictions 

```{r plotBirdMatriciesTables, echo=FALSE}


#make 2D bird density predictions table


#get matricies
gtTabs <- lapply(birdList, FUN= function(bird){
print(bird)  
nameBird <- spNames[bird,]
  
  birdMatrix <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))
 
  names(birdMatrix) <- c("forestClass", "0-10", "11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90", "91-100", "101-110", "111-120", "121-130", "131-140", "141-150", "151-160", "161+")

birdMatrix$forestClass[birdMatrix$forestClass == 1] <- "Black Spruce"
birdMatrix$forestClass[birdMatrix$forestClass == 2] <- "Black Spruce Wet"
birdMatrix$forestClass[birdMatrix$forestClass == 3] <- "Deciduous"
birdMatrix$forestClass[birdMatrix$forestClass == 4] <- "Mixed"
birdMatrix$forestClass[birdMatrix$forestClass == 5] <- "Pine"
birdMatrix$forestClass[birdMatrix$forestClass == 6] <- "White Spruce"


birdMatrix$forestClass <- as.factor(birdMatrix$forestClass)
birdMatrix$forestClass <- factor(birdMatrix$forestClass, levels = c("Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet"))
# Define the new order for the Class column
new_order <- c("Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet")
# Reorder the rows based on the new order
birdMatrix <- birdMatrix[match(new_order, birdMatrix$forestClass), ]


birdMatrix <- COINr::signif_df(birdMatrix, digits = 2) 
names(birdMatrix) <- c("forestClass", "0-10", "11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90", "91-100", "101-110", "111-120", "121-130", "131-140", "141-150", "151-160", "161+") 


gtTab <- gt::gt(birdMatrix, rowname_col = "forestClass") |> #tab_options(table.border.right.width = 50) |> 
  tab_header(title = paste("Two-factor Piecewise Smoothing Predictions (males per ha) for ", nameBird, sep = ""     )) |>
   tab_stubhead(label = "Forest Class")|>
  tab_spanner(
    label = "Forest Age Class (Years)",
    columns = c("0-10", "11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90", "91-100", "101-110", "111-120", "121-130", "131-140", "141-150", "151-160", "161+")
  )
#browser()
gtTab|> gtsave(paste(bird, "_2DMatrix.png", sep = ""), path = saveLocation, expand = 10)

return <- gtTab
   
})

names(gtTabs) <- birdList

# bird <- "ALFL"
# gtsave(gtTabs$ALFL, paste(bird, "_PS2DResults.png", sep= ""), path = saveLocation, expand = 50000000000000)



#lapply(birdList, FUN= function(bird){



#})
# gtTab

# The gt package in R is a powerful tool for creating elegant and customizable tables for data visualization and reporting. It offers a user-friendly way to design and style tables in RMarkdown documents and Shiny applications.

#We’re pleased to announce the release of styler 1.0.0. styler is a source code formatter - a package to format R code according to a style guide. It defaults to our implementation of the tidyverse style guide, but there is plenty of flexibility for a user to specify their own style. A coherent style is important for consistency and legibility. Just as it is important to putspcesbetweenwords

```



###### 20 year age classes

```{r plotBirdMatriciesTables_20, echo=FALSE}


#make 2D bird density predictions table


#get matricies
lapply(birdList, FUN= function(bird){
# bird <- "ALFL" 
print(bird)  
nameBird <- spNames[bird,]
 
  birdMatrix <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))

  names(birdMatrix) <- c("forestClass", "0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+")
  
birdMatrix$forestClass[birdMatrix$forestClass == 3] <- "Deciduous"
birdMatrix$forestClass[birdMatrix$forestClass == 4] <- "Mixed"
birdMatrix$forestClass[birdMatrix$forestClass == 5] <- "Pine"
birdMatrix$forestClass[birdMatrix$forestClass == 6] <- "White Spruce"
birdMatrix$forestClass[birdMatrix$forestClass == 1] <- "Black Spruce"
birdMatrix$forestClass[birdMatrix$forestClass == 2] <- "Black Spruce Wet"

birdMatrix$forestClass <- as.factor(birdMatrix$forestClass)
birdMatrix$forestClass <- factor(birdMatrix$forestClass, levels = c("Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet"))

# Define the new order for the Class column
new_order <- c("Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet")

# Reorder the rows based on the new order
birdMatrix <- birdMatrix[match(new_order, birdMatrix$forestClass), ]

# Check the result
print(birdMatrix)

  
birdMatrix <- COINr::signif_df(birdMatrix, digits = 2) 
names(birdMatrix) <- c("forestClass", "0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+")
#birdMatrix$forestClass <- as.factor(birdMatrix$forestClass)
# birdMatrix$forestClass <- factor(birdMatrix$forestClass, levels = c("3", "4", 
#                                                          "5", 
#                                                          "6",
#                                                          "1",
#                                                          "2"))
#  #browser() 
# birdMatrix %>% 
#   mutate(forestClass = fct_relevel(forestClass, c("3", "4", 
#                                                          "5", 
#                                                          "6",
#                                                          "1",
#                                                          "2"))) %>% 
#   arrange(forestClass) 

# birdMatrix %>%
#     mutate(forestClass = recode(forestClass, "1" = "Black Spruce", "2" = "Black Spruce Wet", "3" =  "Deciduous"))


  


gtTab <- gt::gt(birdMatrix, rowname_col = "forestClass") |> #tab_options(table.border.right.width = 50) |> 
  tab_header(title = paste("2D Piecewise Smoothing Predictions for ", nameBird, sep = ""     )) |>
   tab_stubhead(label = "Forest Class")|>
  tab_spanner(
    label = "Forest Age Class (Years)",
    columns = c("0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+")
  )
#browser()
gtsave(gtTab, paste(bird, "_PS2DResults_20yrAgeClass.png", sep= ""), path = saveLocation) #, expand = 50000000000000)
#return <- gtTab
   
})

#names(gtTabs) <- birdList

# bird <- "ALFL"
# gtsave(gtTabs$ALFL, paste(bird, "_PS2DResults.png", sep= ""), path = saveLocation) #, expand = 50000000000000)



#lapply(birdList, FUN= function(bird){



#})
# gtTab

# The gt package in R is a powerful tool for creating elegant and customizable tables for data visualization and reporting. It offers a user-friendly way to design and style tables in RMarkdown documents and Shiny applications.

#We’re pleased to announce the release of styler 1.0.0. styler is a source code formatter - a package to format R code according to a style guide. It defaults to our implementation of the tidyverse style guide, but there is plenty of flexibility for a user to specify their own style. A coherent style is important for consistency and legibility. Just as it is important to putspcesbetweenwords

```


###### All piecewise smoothing results in a single table

```{r plotBirdMatriciesTables_all, echo=FALSE}


#make 2D bird density predictions table


#get matricies
lapply(birdList, FUN= function(bird){
#browser()  
#bird <- "ALFL"
print(bird)  
nameBird <- spNames[bird,]

birdPreds1D <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_", bird, "_birdPreds1D.csv", sep = "")))
birdPreds1D <- birdPreds1D[birdPreds1D$FoLRaster == "forClass",]
birdPreds1D <- birdPreds1D[, c(3,5)]
birdPreds1D <- pivot_wider(birdPreds1D, names_from = "landForClass", values_from = "meanBirdDensity")
ageClass <- "1D Piecewise Smoothing"
birdPreds1D <- cbind(ageClass, birdPreds1D)
names(birdPreds1D) <- c("ageClass", "1", "2", "3", "4", "5", "6")

birdMatrix_10 <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))
  names(birdMatrix_10) <- c("forestClass", "0-10", "11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90", "91-100", "101-110", "111-120", "121-130", "131-140", "141-150", "151-160", "161+") 
birdMatrix_10$forestClass <- as.factor(birdMatrix_10$forestClass)
birdMatrix_10 <- pivot_longer(birdMatrix_10, 
                             cols = c(2:18),  
               names_to = "ageClass",  # new column for day names
               values_to = "value") 
birdMatrix_10 <-pivot_wider(birdMatrix_10, names_from = "forestClass", values_from = "value") 

  birdMatrix_20 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))  
  names(birdMatrix_20) <- c("forestClass", "0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+")
 birdMatrix_20$forestClass <- as.factor(birdMatrix_20$forestClass)
birdMatrix_20 <- pivot_longer(birdMatrix_20, 
                             cols = c(2:10),  
               names_to = "ageClass",  # new column for day names
               values_to = "value") 
birdMatrix_20 <-pivot_wider(birdMatrix_20, names_from = "forestClass", values_from = "value") 
 
  
  birdMatrix_40 <- as.data.frame(read_csv(paste(outputsDir, "/5x40yrAgeClasses/outputBirdPreds/", .studyAreaName, "_", bird, "_matrix.csv", sep = "")))
    names(birdMatrix_40) <- c("forestClass", "0-40", "41-80", "81-120", "121-160", "161+")
 birdMatrix_40$forestClass <- as.factor(birdMatrix_40$forestClass)
birdMatrix_40 <- pivot_longer(birdMatrix_40, 
                             cols = c(2:6),  
               names_to = "ageClass",  # new column for day names
               values_to = "value") 
birdMatrix_40 <-pivot_wider(birdMatrix_40, names_from = "forestClass", values_from = "value") 
 
    
birdMatrix <- rbind(birdPreds1D, birdMatrix_10, birdMatrix_20, birdMatrix_40)  
names(birdMatrix) <- c("Age Class", "Black Spruce", "Black Spruce Wet", "Deciduous", "Mixed", "Pine", "White Spruce")
birdMatrix <- birdMatrix[, c("Age Class", "Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet")]


birdMatrix <- COINr::signif_df(birdMatrix, digits = 2) 
names(birdMatrix) <- c("Age Class", "Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet")
gtTab <- gt::gt(birdMatrix, rowname_col = "Age Class") |> #tab_options(table.border.right.width = 50) |> 
  tab_header(title = paste("Piecewise Smoothing Predictions for ", nameBird, sep = ""     )) |>
   tab_stubhead(label = " Forest Age (Years)")|>
  tab_spanner(
    label = "Forest Class",
    columns = c("Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet")) |> 
  # tab_row_group(
  #   label = "1D Piecewise Smoothing",
  #   rows = 1
  # ) |>
  tab_row_group(
    label = "2D Piecewise Smoothing with 40 year age classes",
    rows = c(28:32)
  ) |>
   tab_row_group(
    label = "2D Piecewise Smoothing with 20 year age classes",
    rows = c(19:27)
  ) |>
  tab_row_group(
    label = "2D Piecewise Smoothing with 10 year age classes",
    rows = c(2:18)
  ) 
#browser()
gtsave(gtTab, paste(bird, "_PS2DResults_40yrAgeClasses.png", sep= ""), path = saveLocation, expand = 50)

})



# bird <- "ALFL"
# gtsave(gtTabs$ALFL, paste(bird, "_PS2DResults.png", sep= ""), path = saveLocation, expand = 50000000000000)



#lapply(birdList, FUN= function(bird){



#})
# gtTab

# The gt package in R is a powerful tool for creating elegant and customizable tables for data visualization and reporting. It offers a user-friendly way to design and style tables in RMarkdown documents and Shiny applications.

#We’re pleased to announce the release of styler 1.0.0. styler is a source code formatter - a package to format R code according to a style guide. It defaults to our implementation of the tidyverse style guide, but there is plenty of flexibility for a user to specify their own style. A coherent style is important for consistency and legibility. Just as it is important to putspcesbetweenwords

```

## DENSITY PLOTS

### Histograms of 1D class data 

```{r histogram1D, echo=FALSE}


class.labs <- c("Unmanaged Forest", "Water/Ice", "Wetland", "Anthro/Exposed", "Grass/Crop", "Shrub", "Bryoid", "Black Spruce", "Black Spruce Wet", "Deciduous", "Mixed", "Pine", "White Spruce")
names(class.labs) <- c("landClass_0", "landClass_1", "landClass_2", "landClass_3", "landClass_4", "landClass_5", "landClass_6", "forClass_1", "forClass_2", "forClass_3", "forClass_4", "forClass_5", "forClass_6")
#get birdDatasets

lapply(birdList, FUN= function(bird){
  #browser()
 # browser()
print(bird)  
nameBird <- spNames[bird,]

  birdDatasets <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_",  bird, "_fullDataset.csv", sep = "")))
  birdDatasets$landForClass <- as.factor(birdDatasets$landForClass)
  #birdDatasets$FoLRaster <- as.factor(birdDatasets$FoLRaster)
  birdDatasets$birdSp <- as.factor(birdDatasets$birdSp)
  birdDatasets$age <- as.integer(birdDatasets$age)
  birdDatasets$landForClass = factor(birdDatasets$landForClass, 
                                             levels = c("landClass_1", 
                                                        "landClass_2", 
                                                        "landClass_3",
                                                        "landClass_4", 
                                                        "landClass_6",
                                                        "landClass_5", 
                                                        "landClass_0",
                                                        "forClass_3",
                                                        "forClass_4",
                                                        "forClass_5",
                                                        "forClass_6",
                                                        "forClass_1", 
                                                        "forClass_2"))
                                                        
  
  birdHistogram <-  ggplot(birdDatasets, aes(x=birdDensity))+ #, fill=factor(landForClass))) +
  geom_histogram(fill = coloursAge) +
   # scale_fill_manual(coloursAge) + #values = classPal) +
    #scale_fill_viridis(option = "E",discrete = TRUE) +
    facet_wrap( ~ landForClass, 
    labeller = labeller(landForClass = class.labs),
    ncol = 4)+
    #scales = "free_y") +
    theme_minimal() +
  ggtitle(paste("Histograms of ", nameBird, " density data \nby forest or land cover class", sep = "")) +
    xlab("BAM predicted density (male birds per hectare)")  +
    scale_x_continuous(breaks= pretty_breaks(n = 5), limits = c(0, NA)) +
    ylab("Count") +
    scale_y_continuous(breaks= pretty_breaks(n = 5)) +
    # scale_fill_manual(values=c("#56B4E9", "#009E73"), labels = c("Non-forest raster", "Forest raster")) +
    theme(title = element_text(size = 14),
          strip.text.x = element_text(
        size = 12),
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.1),
        legend.title = element_blank(),
          legend.position="none",
        axis.text.y = element_text(size = 10),
          axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title = element_text(size = 12))

  ggsave(file.path(saveLocation, paste(bird, "_histogram.jpeg", sep = "")), birdHistogram, width = 17, height = 22, units = "cm")
  
})


```


### (single dataset) Examine the 1D data using a density plot 

Creates a density plot for a single species, selected from the birdDatasets, for each class. 

```{r densityPlot1D, echo=FALSE}


class.labs <- c("Unmanaged Forest", "Water/Ice", "Wetland", "Anthro/Exposed", "Grass/Crop", "Shrub", "Bryoid", "Black Spruce", "Black Spruce Wet", "Deciduous", "Mixed", "Pine", "White Spruce")
names(class.labs) <- c("landClass_0", "landClass_1", "landClass_2", "landClass_3", "landClass_4", "landClass_5", "landClass_6", "forClass_1", "forClass_2", "forClass_3", "forClass_4", "forClass_5", "forClass_6")
#get birdDatasets

lapply(birdList, FUN= function(bird){
  #browser()
 # browser()
print(bird)  
nameBird <- spNames[bird,]

  birdDatasets <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_",  bird, "_fullDataset.csv", sep = "")))
  birdDatasets$landForClass <- as.factor(birdDatasets$landForClass)
  #birdDatasets$FoLRaster <- as.factor(birdDatasets$FoLRaster)
  birdDatasets$birdSp <- as.factor(birdDatasets$birdSp)
  birdDatasets$age <- as.integer(birdDatasets$age)
  birdDatasets$landForClass = factor(birdDatasets$landForClass, 
                                             levels = c("landClass_1", 
                                                        "landClass_2", 
                                                        "landClass_3",
                                                        "landClass_4", 
                                                        "landClass_6",
                                                        "landClass_5", 
                                                        "landClass_0",
                                                        "forClass_3",
                                                        "forClass_4",
                                                        "forClass_5",
                                                        "forClass_6",
                                                        "forClass_1", 
                                                        "forClass_2"))
                                                        
  
  densityPlot <-  ggplot(birdDatasets, aes(x=birdDensity))+ #, fill=factor(landForClass))) +
  geom_density(fill = coloursAge) +
   # scale_fill_manual(coloursAge) + #values = classPal) +
    #scale_fill_viridis(option = "E",discrete = TRUE) +
    facet_wrap( ~ landForClass, 
    labeller = labeller(landForClass = class.labs),
    ncol = 4)+
    #scales = "free_y") +
    theme_minimal() +
  ggtitle(paste("Kernel density plots for ", nameBird, " \nby forest or land cover class", sep = "")) +
    xlab("BAM predicted density (male birds per hectare)")  +
    scale_x_continuous(breaks= pretty_breaks(n = 5), limits = c(0, NA)) +
    ylab("Density") +
    scale_y_continuous(breaks= pretty_breaks(n = 5)) +
    # scale_fill_manual(values=c("#56B4E9", "#009E73"), labels = c("Non-forest raster", "Forest raster")) +
    theme(title = element_text(size = 14),
          strip.text.x = element_text(
        size = 12),
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.1),
        legend.title = element_blank(),
          legend.position="none",
        axis.text.y = element_text(size = 10),
          axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title = element_text(size = 12))

  ggsave(file.path(saveLocation, paste(bird, "_kernelDensity.jpeg", sep = "")), densityPlot, width = 17, height = 17, units = "cm")
  
})


```


### (single dataset) plot density plots for selected 2D bins 

```{r plot2DDensity, echo=FALSE}

# #get birdDatasets
# #get birdDatasets
# birdDatasets <- lapply(birdList, FUN= function(bird){
#   birdDatasets <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_",  bird, "_fullDataset.csv", sep = "")))
#   birdDatasets$landForClass <- as.factor(birdDatasets$landForClass)
#   birdDatasets$FoLRaster <- as.factor(birdDatasets$FoLRaster)
#   birdDatasets$birdSp <- as.factor(birdDatasets$birdSp)
#   birdDatasets$age <- as.integer(birdDatasets$age)
#   return(birdDatasets)
# })
# names(birdDatasets) <- birdList
# 
# 
# #get age class definitions table
# ageClassDefs <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_ageClassDefs", sep = "")))
# 
# #select bird Sp
# forestedDT <- as.data.table(birdDatasets$OVEN)
# 
# #separate out data table rows that are forested from the raw birdDataset 
# forestedDT <- forestedDT[forestedDT$FoLRaster == "forClass"]
# forestedDT <- droplevels(forestedDT)
# 
# #get rid of any rows with NA for age
# forestedDT <- na.omit(forestedDT, cols = "age")
# 
# #get age classes for each row using the ageClassDefs table
# ageClass <- forestedDT[, age]
# ageClass <- as.data.table(ageClass)
# ageClass[] <- lapply(ageClass, function(x) ageClassDefs$ageClasses[match(x, ageClassDefs$allAges)])
# 
# #add the ageClass to the forestedDT 
# birdDataNew <- cbind(forestedDT, ageClass)
# birdDataNew$ageClass <- as.character(birdDataNew$ageClass)
# 
# #create new columns, landAgeClass, giving the uniqueLandClass and ageClass combined and the dataset
# birdDataNew <- as.data.table(unite(birdDataNew, landAgeClass, c(landForClass, ageClass), sep= ".", remove=FALSE))
# dataset <- 
# 
# 
# #make density plot of single land class
# 
# OVEN_forClass_4 <- birdDataNew[landForClass == "forClass_4"]
# OVEN_forClass_4
# 
# densityPlot_OVEN_forClass_4 <-  ggplot(OVEN_forClass_4, aes(x=birdDensity, colour=ageClass)) +
#   geom_density(alpha=.25, ) +
#   #geom_density(color="darkblue", fill="white")
#   # facet_wrap( ~ FoLRaster + landAgeClass,
#   #             labeller = labeller( FoLRaster = raster.labs),
#   #             scales = "free") +
#   theme_classic() +
#   geom_density(linewidth = 1.5)+
#   scale_fill_viridis(option = "E",discrete = TRUE) +
#   # scale_color_manual(values=c("#C7E9C0", "#A1D99B", "#74C476", "#41AB5D", "#238B45", "#005A32"))+
#   ggtitle("Density plot for Ovenbird in deciduous forest, by age class") +
#   scale_fill_viridis(discrete = TRUE) +
#   xlab("Predicted bird density")  +
#   scale_x_continuous(breaks= pretty_breaks()) +
#   ylab("Density of value") +
#   scale_y_continuous(breaks= pretty_breaks()) +
#   theme(title = element_text(size = 14),
#         strip.text = element_text(
#           size = 14),
#         strip.background = element_rect(
#           color="white", fill="white", linewidth =1.5),
#         legend.title = element_blank(),
#         axis.text= element_text(size = 12),
#         axis.title = element_text(size = 14))
# 
# densityPlot_OVEN_forClass_4
# # #jpeg("2DdensityPlot_OVEN_1_3.4.jpg")
# # ggsave("densityPlot_OVEN_1_3.4.jpg",
# #        plot = densityPlot_OVEN_1_3.4,
# #        device = "jpeg")
# 


#make density plot of single land age class

#good example : 1_5.4 (but in an extraploated age class for AB)
#bad example: 1_4.2

OVEN_1_3.4 <- birdDataNew[landAgeClass == "1_3.4"]
OVEN_1_3.4

densityPlot_OVEN_1_3.4 <-  ggplot(OVEN_1_3.4, aes(x=birdDensity)) +
  geom_density(alpha=.25) +
  # facet_wrap( ~ FoLRaster + landAgeClass,
  #             labeller = labeller( FoLRaster = raster.labs),
  #             scales = "free") +
  theme_classic() +
  ggtitle("Density plot for Ovenbird in conifer mixed forest, aged 61-80 yrs") +
  xlab("Predicted bird density")  +
  scale_x_continuous(breaks= pretty_breaks()) +
  ylab("Density of value") +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_fill_manual(values=c("#56B4E9", "#009E73")) +
  theme(title = element_text(size = 14),
        strip.text.x = element_text(
          size = 12),
        strip.background = element_rect(
          color="white", fill="white", linewidth =NA),
        legend.title = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.title = element_text(size = 14))

densityPlot_OVEN_1_3.4
# #jpeg("2DdensityPlot_OVEN_1_3.4.jpg")
# ggsave("densityPlot_OVEN_1_3.4.jpg",
#        plot = densityPlot_OVEN_1_3.4,
#        device = "jpeg")



```

## PLOTS OF NORMALITY AND UNIMODALITY

###for single dataset plot 1D vs 2D normality and unimodality stats by bird

```{r plotNormalityAndUnimodality, echo=FALSE}

assumpTab1D <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/assumpTab1D.csv", sep = "")))
assumpTab2D <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/assumptionsByBird2D.csv", sep = "")))

#get 1D bird assumptions for forested classes only
assumptionsByBird1DFor <- assumpTab1D[FoLRaster == "forClass"]
assumptionsByBird1DFor  <- droplevels(assumptionsByBird1DFor)
assumptionsByBird1DFor <- assumptionsByBird1DFor[order(birdSp)                                                                   ][,list(noClasses = .N,                                                               propClassesNormal = mean(normal),
                                               propClassesUnimodal = mean(unimodal),
                                               binningType = "1DBins"),                                               by = birdSp]
  assumptionsByBird1DFor

  #make into table with 2D assumptions
assumptionsbyBird <- rbind(assumptionsByBird1DFor,assumptionsByBird2D)  

#normality plot
   plotNormality <- ggplot(data = assumptionsbyBird, 
                                aes(fill= binningType, y= propClassesNormal, x= birdSp)) + 
    geom_bar(position = "dodge", stat = "identity") +
    ggtitle("Proportion of Classes Normal for 1D and 2D post-hoc binning by species") +
    xlab("Species")  +
    ylab("Proportion of classes normal (p < 0.05)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values= colours1D2D, 
                      labels = c("1D", "2D")) +
    theme(title = element_text(size = 14),
          legend.title = element_blank(),
          legend.position= "bottom",
          axis.text.x = element_text(size = 10, angle = 45, hjust = 1), 
          axis.title = element_text(size = 12))

   plotNormality

#unimodality plot
   plotUnimodality <- ggplot(data = assumptionsbyBird, 
                                aes(fill= binningType, y= propClassesUnimodal, x= birdSp)) + 
    geom_bar(position = "dodge", stat = "identity") +
    ggtitle("Proportion of classes unimodal for 1D and 2D post-hoc binning by species") +
    xlab("Species")  +
    ylab("Proportion of classes unimodal (p < 0.05)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values= colours1D2D, 
                      labels = c("1D", "2D")) +
    theme(title = element_text(size = 14),
          legend.title = element_blank(),
          legend.position= "bottom",
          axis.text.x = element_text(size = 10, angle = 45, hjust = 1), 
          axis.title = element_text(size = 12))

   plotUnimodality

```

#### Make table of unimodality and normality test results

```{r tabUniAndNormTest, echo=FALSE}

lapply(birdList, FUN= function(bird){

#bird <- "ALFL" 
print(bird)
nameBird <- spNames[bird,]

birdPreds1D <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/", .studyAreaName, "_", bird, "_birdPreds1D.csv", sep = "")))
birdPreds1D <- birdPreds1D[, c(3,9:12)] 

birdPreds1D$landForClass[birdPreds1D$landForClass == "forClass_1"] <- "Black Spruce"
birdPreds1D$landForClass[birdPreds1D$landForClass == "forClass_2"] <- "Black Spruce Wet"
birdPreds1D$landForClass[birdPreds1D$landForClass == "forClass_3"] <- "Deciduous"
birdPreds1D$landForClass[birdPreds1D$landForClass == "forClass_4"] <- "Mixed"
birdPreds1D$landForClass[birdPreds1D$landForClass == "forClass_5"] <- "Pine"
birdPreds1D$landForClass[birdPreds1D$landForClass == "forClass_6"] <- "White Spruce"
birdPreds1D$landForClass[birdPreds1D$landForClass == "landClass_0"] <- "Unmanaged Forest"
birdPreds1D$landForClass[birdPreds1D$landForClass == "landClass_1"] <- "Water/Ice"
birdPreds1D$landForClass[birdPreds1D$landForClass == "landClass_2"] <- "Wetland"
birdPreds1D$landForClass[birdPreds1D$landForClass == "landClass_3"] <- "Anthro/Exposed"
birdPreds1D$landForClass[birdPreds1D$landForClass == "landClass_4"] <- "Crop/Grass"
birdPreds1D$landForClass[birdPreds1D$landForClass == "landClass_5"] <- "Shrub"
 
birdPreds1D$landForClass <- factor(birdPreds1D$landForClass, levels = c("Water/Ice", "Wetland", "Anthro/Exposed", "Crop/Grass", "Shrub", "Unmanaged Forest", "Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet"))
# Define the new order for the Class column
new_order <- c("Water/Ice", "Wetland", "Anthro/Exposed", "Crop/Grass", "Shrub", "Unmanaged Forest", "Deciduous", "Mixed", "Pine", "White Spruce", "Black Spruce", "Black Spruce Wet")
# Reorder the rows based on the new order
birdPreds1D <- birdPreds1D[match(new_order, birdPreds1D$landForClass), ]



 birdPreds1D <- COINr::signif_df(birdPreds1D, digits = 2) 
 names(birdPreds1D) <- c("Class", "D", "p-value ", "Dn", "p-value  ")
 
gtTab <- gt::gt(birdPreds1D, rowname_col = "Class") |> #tab_options(table.border.right.width = 50) |> 
  tab_header(title = paste("Normality and Unimodality Test Results for ", nameBird, sep = ""     )) |>
  tab_spanner(
    label = "Hartigan's Diptest for Unimodality ",
    columns = c(4:5)) |> 
  tab_spanner(
    label = "Anderson-Darling Test for Normality",
    columns = c(2:3)) |> 
  # tab_row_group(
  #   label = "1D Piecewise Smoothing",
  #   rows = 1
  # ) |>
  tab_row_group(
    label = "Forest Classes",
    rows = c(7:12)
  ) |> tab_row_group(
    label = "Land Cover Classes",
    rows = c(1:6)
  ) 
#browser()
gtsave(gtTab, paste(bird, "_NormalityAndUnimodalityTests.png", sep= ""), path = saveLocation, expand = 50)


   
#  return(birdPreds1D)
})
#names(birdPreds1D) <- birdList


```



## PLOTS OF GBM STATS

### Plot relative influence for age and friedman's H statistic

Here a graph of the gbm relative influence for age and cover class is plotted, and the friedman's H statistic for the GBM is plotted per bird.


```{r plotBothRelInfAndFriedmansH, echo=FALSE}

statsGBM <- as.data.table(read_csv(paste(outputsDir,  "/outputBirdPreds/studyArea_AB_BCR6.shp_statsGBM.csv", sep = "")))

statsGBM <- statsGBM[,c(2:4)]
statsGBM <-na.omit(statsGBM)



statsGBM$relInfAge <- statsGBM$relInfAge/100


plotRelInf <- ggplot(data = statsGBM,
                      aes(x= relInfAge, 
                      y= birdSp)) + 
    geom_point()+
    geom_segment( aes( yend = birdSp, xend = 0)) +
    ggtitle("Relative influence of forest age among species") +
    #xlab()  +
    xlab("Relative influence of age (%)") +
    scale_x_continuous(breaks= pretty_breaks()) +
   scale_y_discrete(labels=c("ALFL" = "Alder Flycatcher",
                             "AMGO" = "American Goldfinch", 
                             "AMRO" = "American Robin", 
                             "BARS" = "Barn Swallow", 
                             "BBWA" = "Bay-breasted Warbler", 
                             "BCCH" = "Black-capped Chickadee", 
                             "BHCO" = "Brown-headed Cowbird", 
                             "BOCH" = "Boreal Chickadee",
                             "BRBL" = "Brewer's Blackbird", 
                             "BRCR" = "Brown Creeper", 
                             "CCSP" = "Clay-colored Sparrow", 
                             "CEDW" = "Cedar Waxwing", 
                             "CHSP" = "Chipping Sparrow", 
                             "CLSW" = "Cliff Swallow", 
                             "CMWA" = "Cape May Warbler", 
                             "COYE" = "Common Yellowthroat", 
                             "DEJU" = "Dark-eyed Junco", 
                             "GCKI" = "Golden-crowned Kinglet", 
                             "GRAJ" = "Canada Jay", 
                             "HETH" = "Hermit Thrush", 
                             "HOWR" = "House Wren", 
                             "LEFL" = "Least Flycatcher", 
                             "MOWA" = "Mourning Warbler", 
                             "OVEN" = "Ovenbird", 
                             "PAWA" = "Palm Warbler", 
                             "RBNU" = "Red-breasted Nuthatch", 
                             "RCKI" = "Ruby-crowned Kinglet", 
                             "REVI" = "Red-eyed Vireo", 
                             "SWTH" = "Swainson’s Thrush", 
                             "TEWA" = "Tennessee Warbler", 
                             "YRWA" = "Yellow-rumped Warbler" )) +
    theme_minimal() + 
    #scale_fill_manual(values= colours2D)+ 
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.title.y = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotRelInf
   
   
 
 


plotFrH <- ggplot(data = statsGBM,
                      aes(x= FriedmansHStat, 
                      y= birdSp)) + 
    geom_point()+
    geom_segment( aes( yend = birdSp, xend = 0)) +
    ggtitle("Friedman's H-statistic by species") +
    #xlab()  +
    xlab("Friedman's H-statistic") +
    scale_x_continuous(breaks= pretty_breaks()) +
   scale_y_discrete(labels=c("ALFL" = "Alder Flycatcher",
                             "AMGO" = "American Goldfinch", 
                             "AMRO" = "American Robin", 
                             "BARS" = "Barn Swallow", 
                             "BBWA" = "Bay-breasted Warbler", 
                             "BCCH" = "Black-capped Chickadee", 
                             "BHCO" = "Brown-headed Cowbird", 
                             "BOCH" = "Boreal Chickadee",
                             "BRBL" = "Brewer's Blackbird", 
                             "BRCR" = "Brown Creeper", 
                             "CCSP" = "Clay-colored Sparrow", 
                             "CEDW" = "Cedar Waxwing", 
                             "CHSP" = "Chipping Sparrow", 
                             "CLSW" = "Cliff Swallow", 
                             "CMWA" = "Cape May Warbler", 
                             "COYE" = "Common Yellowthroat", 
                             "DEJU" = "Dark-eyed Junco", 
                             "GCKI" = "Golden-crowned Kinglet", 
                             "GRAJ" = "Canada Jay", 
                             "HETH" = "Hermit Thrush", 
                             "HOWR" = "House Wren", 
                             "LEFL" = "Least Flycatcher", 
                             "MOWA" = "Mourning Warbler", 
                             "OVEN" = "Ovenbird", 
                             "PAWA" = "Palm Warbler", 
                             "RBNU" = "Red-breasted Nuthatch", 
                             "RCKI" = "Ruby-crowned Kinglet", 
                             "REVI" = "Red-eyed Vireo", 
                             "SWTH" = "Swainson’s Thrush", 
                             "TEWA" = "Tennessee Warbler", 
                             "YRWA" = "Yellow-rumped Warbler" ))+
    theme_minimal() + 
    scale_fill_manual(values= colours2D)+ 
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.x = element_text(size = 14),
          axis.title.y = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotFrH
   



#plot_grid(plotRelInf, plotFrH, labels = c('A', 'B'), label_size = 12)
  
  allMatrixPlot <- ggarrange(plotRelInf +
                             theme(title = element_blank()),
                             plotFrH +
                             theme(axis.text.y = element_blank(),
                                   axis.title.y = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none"),
                           ncol = 2,
                           labels = c("a", "b"),
                           label.args = list(gp=gpar(font=4, fontsize = 16), x=unit(1,"line"), hjust=1)
                            ) 
  test <- statsGBM %>% 
    rowwise() %>% 
    arrange(relInfAge) %>% 
    mutate(birdSp = factor(birdSp, birdSp))
    

 plotGBM <- ggplot(test) +
  geom_segment( aes(y=FriedmansHStat, yend=relInfAge, x=birdSp, xend=birdSp), color="grey") +
  geom_point( aes(x=birdSp, y=relInfAge, colour = "Proportional Influence of Age"), stroke = 1.5, shape = 1, size=3 ) +
  geom_point( aes(x=birdSp, y=FriedmansHStat, color= "Friedman's H Statistic"),  shape = 16, size=4 ) +
  xlab("") +
 # ylab("Friedman's H Statistic/Proportional Influence of Age") +
   ggtitle("Friedman's H-statistic by species \nand the relative influence of Age") +
    scale_color_manual(values = c(colours2D, colours2D_alt)) +
   scale_x_discrete(labels=c("ALFL" = "Alder Flycatcher",
                             "AMGO" = "American Goldfinch", 
                             "AMRO" = "American Robin", 
                             "BARS" = "Barn Swallow", 
                             "BBWA" = "Bay-breasted Warbler", 
                             "BCCH" = "Black-capped Chickadee", 
                             "BHCO" = "Brown-headed Cowbird", 
                             "BOCH" = "Boreal Chickadee",
                             "BRBL" = "Brewer's Blackbird", 
                             "BRCR" = "Brown Creeper", 
                             "CCSP" = "Clay-colored Sparrow", 
                             "CEDW" = "Cedar Waxwing", 
                             "CHSP" = "Chipping Sparrow", 
                             "CLSW" = "Cliff Swallow", 
                             "CMWA" = "Cape May Warbler", 
                             "COYE" = "Common Yellowthroat", 
                             "DEJU" = "Dark-eyed Junco", 
                             "GCKI" = "Golden-crowned Kinglet", 
                             "GRAJ" = "Canada Jay", 
                             "HETH" = "Hermit Thrush", 
                             "HOWR" = "House Wren", 
                             "LEFL" = "Least Flycatcher", 
                             "MOWA" = "Mourning Warbler", 
                             "OVEN" = "Ovenbird", 
                             "PAWA" = "Palm Warbler", 
                             "RBNU" = "Red-breasted Nuthatch", 
                             "RCKI" = "Ruby-crowned Kinglet", 
                             "REVI" = "Red-eyed Vireo", 
                             "SWTH" = "Swainson’s Thrush", 
                             "TEWA" = "Tennessee Warbler", 
                             "YRWA" = "Yellow-rumped Warbler" ))+
  coord_flip()+
  theme_minimal() +
 theme(title = element_blank(),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =10),
          axis.text.x = element_text(size = 10), 
          axis.text.y = element_text(size = 10),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.margin = margin(0.2,0.2,0.2,0.2, "cm"))
  

  plotGBM
  
   ggsave(file.path(saveLocation,"statsGBM_10yrAgeClasses.jpeg"), plotGBM, width = 18, height = 16, units = "cm")
 
  
```




## PLOTS OF MAP STATS

###spearman Stats 
```{r plotSpearman, echo=FALSE}

spearmanStats <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats) <- c("birdSp", "spearman1D", "spearman2D")

spearmanStats <- spearmanStats %>%
  pivot_longer(
    cols = c(spearman1D, spearman2D),        # Columns to pivot
    names_to = "smoothingType",        # New column for the names of the columns
    values_to = "spearmanStat"        # New column for the values
  )

plotSpearmanStats <- ggplot(data = spearmanStats,
                                aes(y= spearmanStat, 
                                x= smoothingType,
                                fill = smoothingType)) + 
    geom_boxplot() +
    ggtitle("Correlation between BAM national models \nand mapped predictions, across bird species") +
    #xlab()  +
    scale_x_discrete(labels=c("spearman1D" = "1D", "spearman2D" = "2D")) +  
    ylab("Spearman's coefficient (ρ)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values= colours1D2D, 
                      labels = c( "1D", "2D")) +
    theme(title = element_text(size = 15),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

     plotSpearmanStats


```


###autocor Stats and median residual
```{r plotAutocorStats, echo=FALSE}

resStats <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/resStats.csv", sep = "")))
names(resStats) <- c("birdSp", "medianRes1D", "medianRes2D","moran1D", "moran2D")

## moran stats plot 

moranStats <- resStats[,c(1,4:5)]

moranStats <- moranStats %>%
  pivot_longer(
    cols = c(moran1D, moran2D),        # Columns to pivot
    names_to = "smoothingType",        # New column for the names of the columns
    values_to = "MoransI"        # New column for the values
  )

plotAutocorStats <- ggplot(data = moranStats,
                            aes(fill = factor(smoothingType,
                                             levels=c("moran1D", "moran2D")), 
                                y= MoransI, 
                                x= smoothingType)) + 
    geom_boxplot() +
    ggtitle("Spatial autocorrelation of mapped residuals, \nacross bird species") +
    #xlab()  +
    ylab("Moran's I") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("moran1D" = "1D", "moran2D" = "2D")) +       theme_classic() + 
    scale_fill_manual(values= colours1D2D, 
                      labels = c( "moran1D", "moran2D")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotAutocorStats
   
   # median Residual plot
medResStats <- resStats[,c(1:3)]

medResStats <- medResStats %>%
  pivot_longer(
    cols = c(medianRes1D, medianRes2D),        # Columns to pivot
    names_to = "smoothingType",        # New column for the names of the columns
    values_to = "medianRes"        # New column for the values
  )


plotMedRes <- ggplot(data = medResStats,
                            aes(fill = smoothingType, 
                                y= medianRes, 
                                x= smoothingType)) + 
    geom_boxplot() +
    ggtitle("Median value of residuals per bird species") +
    #xlab()  +
    ylab("Median residual value") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("medianRes1D" = "1D", "medianRes2D" = "2D"))  + 
    theme_classic() + 
    scale_fill_manual(values=colours1D2D) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotMedRes
   
   
```


###Combined unimodality, spearman and morans 

```{r plotCombinedUnimodSpearAndMoran, echo=FALSE}

#get data tables needed
assumptionsByClass1D <- as.data.table(read_csv(paste(outputsDir, "/outputBirdPreds/assumptionsByClass1D.csv", sep = "")))
names(assumptionsByClass1D)[names(assumptionsByClass1D) == 'landForClass'] <- 'landAgeClass'
assumptionsByClass1D <- assumptionsByClass1D[1:6]
assumptionsByClass1D  <- droplevels(assumptionsByClass1D)
# assumptionsByClass1D_land <- assumptionsByClass1D[1:6]
# assumptionsByClass1D_land  <- droplevels(assumptionsByClass1D_land)



assumptionsByClass2D <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/assumptionsByClass2D.csv", sep = "")))


assumptionsByClass <- rbind(assumptionsByClass1D, assumptionsByClass2D)
# assumptionsByClass <- unite(assumptionsByClass, dataset, c(smoothingType, ageClasses), remove=FALSE)
assumptionsByClass$smoothingType <- as.factor(assumptionsByClass$smoothingType)
 #normality plot
   plotUnimodality <- ggplot(data = assumptionsByClass, 
                                aes(fill = smoothingType, y= propBirdsUnimodal, x= smoothingType)) + 
    geom_violin(width=1.4) +
     geom_boxplot(width=0.15, color="grey") +
    geom_jitter(color="grey", size=0.4, alpha=0.9) +
    ggtitle("Proportion of bird species per class \nwith a unimodal distribution (p < 0.05)") +
    xlab("Species")  +
    ylab("Proportion of bird \nspecies unimodal") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
     scale_x_discrete(labels=c("1" = "1D", "2" = "2D")) +  
    scale_fill_manual(values=colours1D2D) +
  theme(title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_blank(),
          axis.text.x = element_text(size = 11, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0,0.5, "cm"),
         axis.line.y = element_line(linewidth = 1))

   plotUnimodality

##################################################################
   
#    spearmanStats
   spearmanStats <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats) <- c("birdSp", "spearman1D", "spearman2D")

spearmanStats <- spearmanStats %>%
  pivot_longer(
    cols = c(spearman1D, spearman2D),        # Columns to pivot
    names_to = "smoothingType",        # New column for the names of the columns
    values_to = "spearmanStat"        # New column for the values
  )



plotSpearmanStats <- ggplot(data = spearmanStats,
                                aes(y= spearmanStat, 
                                x= smoothingType,
                                fill = smoothingType)) + 
    geom_violin(width=1.4) +
  geom_boxplot(width=0.15, color="grey") +
    ggtitle("Correlation between BAM national models \nand mapped predictions, across bird species") +
    #xlab()  +
    scale_x_discrete(labels=c("spearman1D" = "1D", "spearman2D" = "2D")) +  
    ylab("Spearman's coefficient (p)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values= colours1D2D, 
                      labels = c( "1D Piecewise\n Smoothing", "2D Piecewise\n Smoothing")) +
    theme(title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_text(size =11),
          axis.text.x = element_text(size = 10, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.title.x = element_blank(),
          plot.margin = margin(0.2,0.2,0.2,0.2, "cm"))

     plotSpearmanStats

   

##################################################################
     
# resStats
     resStats <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/resStats.csv", sep = "")))
names(resStats) <- c("birdSp", "medianRes1D", "medianRes2D","moran1D", "moran2D")

## moran stats plot 

moranStats <- resStats[,c(1,4:5)]

moranStats <- moranStats %>%
  pivot_longer(
    cols = c(moran1D, moran2D),        # Columns to pivot
    names_to = "smoothingType",        # New column for the names of the columns
    values_to = "MoransI"        # New column for the values
  )

plotAutocorStats <- ggplot(data = moranStats,
                            aes(fill = factor(smoothingType,
                                             levels=c("moran1D", "moran2D")), 
                                y= MoransI, 
                                x= smoothingType)) + 
    geom_violin(width=1.4) +
  geom_boxplot(width=0.15, color="grey") +
    ggtitle("Spatial autocorrelation of mapped residuals, \nacross bird species") +
    #xlab()  +
    ylab("Moran's I") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("moran1D" = "1DPS Piecewise\n Smoothing", "moran2D" = "2DPS Piecewise\n Smoothing")) +       theme_classic() + 
    scale_fill_manual(values= colours1D2D, 
                      labels = c( "moran1D", "moran2D")) +
    theme(title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_text(size =11),
          axis.text.x = element_text(size = 10), 
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 11),
          axis.title.x = element_blank(),
          plot.margin = margin(0.2,0.2,0.2,0.2, "cm"))

   plotAutocorStats
     
 #################################################################  

   
     allMatrixPlot <- ggarrange(plotUnimodality +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotSpearmanStats +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotAutocorStats +
                             theme(title = element_blank())
                           ,
                           ncol = 1,
                           labels = c("(a)", "(b)", "(c)"),
                           label.args = list(gp=gpar(font=4, fontsize = 12), x=unit(1,"line"), hjust=1)
                            ) 

   ggsave(file.path(saveLocation,"unimodSpearmanAutocor.jpeg"), allMatrixPlot, width = 10, height = 15, units = "cm")
 

```

### Combined uni, spear, morans - different age classes

```{r plotCombinedUnimodSpearAndMoranAgeClass, echo=FALSE}

#get data tables needed
assumptionsByClass1D <- as.data.table(read_csv(paste(outputsDir, "/17x10yrAgeClasses/outputBirdPreds/assumptionsByClass1D.csv", sep = "")))
names(assumptionsByClass1D)[names(assumptionsByClass1D) == 'landForClass'] <- 'landAgeClass'
assumptionsByClass1D <- assumptionsByClass1D[1:6]
assumptionsByClass1D  <- droplevels(assumptionsByClass1D)
# assumptionsByClass1D_land <- assumptionsByClass1D[1:6]
# assumptionsByClass1D_land  <- droplevels(assumptionsByClass1D_land)



assumptionsByClass2D_10 <- as.data.frame(read_csv(paste(outputsDir, "/17x10yrAgeClasses/outputBirdPreds/assumptionsByClass2D.csv", sep = "")))
assumptionsByClass2D_10[assumptionsByClass2D_10 == '2'] <- '2_10'

assumptionsByClass2D_20 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/assumptionsByClass2D.csv", sep = "")))
assumptionsByClass2D_20[assumptionsByClass2D_20 == '2'] <- '2_20'

assumptionsByClass2D_40 <- as.data.frame(read_csv(paste(outputsDir, "/5x40yrAgeClasses/outputBirdPreds/assumptionsByClass2D.csv", sep = "")))
assumptionsByClass2D_40[assumptionsByClass2D_40 == '2'] <- '2_40'

assumptionsByClass <- rbind(assumptionsByClass1D, 
                            assumptionsByClass2D_10, 
                            assumptionsByClass2D_20, 
                            assumptionsByClass2D_40)
# assumptionsByClass <- unite(assumptionsByClass, dataset, c(smoothingType, ageClasses), remove=FALSE)
assumptionsByClass$smoothingType <- as.factor(assumptionsByClass$smoothingType)
 #normality plot
   plotUnimodality <- ggplot(data = assumptionsByClass, 
                                aes(fill = smoothingType, y= propBirdsUnimodal, x= smoothingType)) + 
    geom_violin(width=0.95) +
     #geom_boxplot(width=0.15, color="grey") +
    #geom_jitter(color="grey", size=0.4, alpha=0.9) +
  # Add counts by group 
  annotate("text",
           x = 1:length(table(assumptionsByClass$smoothingType)),
           y = aggregate(propBirdsUnimodal ~ smoothingType, assumptionsByClass, max)[ , 2],
           label = paste("n = ", table(assumptionsByClass$smoothingType), sep = ""),
           size = 3,
           vjust = -1) +
    ggtitle("Proportion of bird species per class \nwith a unimodal distribution (p < 0.05)") +
    xlab("Species")  +
    ylab("Proportion of bird \nspecies unimodal") +
    scale_y_continuous(breaks= pretty_breaks(), limits = c(NA, 1)) +
    theme_classic() + 
     scale_x_discrete(labels=c("1" = "1DPS", 
                               "2_10" = "2DPS (10-year\n age classes)", 
                               "2_20" = "2DPS (20-year\n age classes)",
                               "2_40" = "2DPS (40-year\n age classes)")) +  
    scale_fill_manual(values=coloursAllSame) +
  theme(title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_blank(),
          axis.text.x = element_text(size = 9, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 9),
          axis.title.y = element_text(size = 10),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0,0.5, "cm"),
         axis.line.y = element_line(linewidth = 1))

   plotUnimodality
   
   
    #normality plot
   plotNormality <- ggplot(data = assumptionsByClass, 
                                aes(fill = smoothingType, y= propBirdsNormal, x= smoothingType)) + 
    geom_violin(width=0.95) +
    # geom_boxplot(width=0.15, color="grey") +
    #geom_jitter(color="grey", size=0.4, alpha=0.9) +
    # Add counts by group 
  annotate("text",
           x = 1:length(table(assumptionsByClass$smoothingType)),
           y = aggregate(propBirdsNormal ~ smoothingType, assumptionsByClass, max)[ , 2],
           label = paste("n = ", table(assumptionsByClass$smoothingType), sep = ""),
           size = 3,
           vjust = -1) +
     ggtitle("Proportion of bird species per class \nwith a normal distribution (p < 0.05)") +
    xlab("Species")  +
    ylab("Proportion of bird \nspecies normal") +
    scale_y_continuous(breaks= pretty_breaks(), limits = c(NA, 0.35)) +
    theme_classic() + 
     scale_x_discrete(labels=c("1" = "1DPS", 
                               "2_10" = "2DPS (10-year\n age classes)", 
                               "2_20" = "2DPS (20-year\n age classes)",
                               "2_40" = "2DPS (40-year\n age classes)")) +  
    scale_fill_manual(values=coloursAllSame) +
  theme(title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_blank(),
          axis.text.x = element_text(size = 9, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 9),
          axis.title.y = element_text(size = 10),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0,0.5, "cm"),
         axis.line.y = element_line(linewidth = 1))

   plotNormality

##################################################################
   
#    spearmanStats
   spearmanStats_10 <- as.data.frame(read_csv(paste(outputsDir, "/17x10yrAgeClasses/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats_10) <- c("birdSp", "spearman1D", "spearman2D_10")

spearmanStats_20 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats_20) <- c("birdSp", "spearman1D", "spearman2D_20")

spearmanStats_40 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats_40) <- c("birdSp", "spearman1D", "spearman2D_40")

spearmanStats <- cbind(spearmanStats_10,
                       spearmanStats_20$spearman2D_20, 
                       spearmanStats_40$spearman2D_40)
names(spearmanStats) <- c("birdSp", "spearman1D", "spearman2D_10", "spearman2D_20", "spearman2D_40")
spearmanStats <- spearmanStats %>%
  pivot_longer(
    cols = c(spearman1D, spearman2D_10, spearman2D_20, spearman2D_40),        # Columns to pivot
    names_to = "smoothingType",        # New column for the names of the columns
    values_to = "spearmanStat"        # New column for the values
  )



plotSpearmanStats <- ggplot(data = spearmanStats,
                                aes(y= spearmanStat, 
                                x= smoothingType,
                                fill = smoothingType)) + 
    geom_violin(width=0.95) +
  geom_boxplot(width=0.15, color="grey") +
    ggtitle("Correlation between BAM national models \nand mapped predictions, across bird species") +
    #xlab()  +
    scale_x_discrete(labels=c("spearman1D" = "1DPS", 
                              "spearman2D_10" = "2DPS (10-year\n age classes)",
                              "spearman2D_20" = "2DPS (20-year\n age classes)",
                              "spearman2D_40" = "2DPS (40-year\n age classes)")) +  
                               ylab("Spearman's \ncoefficient (p)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values= coloursAllSame, 
                      labels = c( "1D Piecewise\n Smoothing", "2D Piecewise\n Smoothing")) +
    theme(title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_text(size =10),
          axis.text.x = element_text(size = 9, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 9),
          axis.title.y = element_text(size = 10),
          axis.title.x = element_blank(),
          plot.margin = margin(0.2,0.2,0.2,0.2, "cm"))

     plotSpearmanStats

   

##################################################################
     
# resStats
     resStats_10 <- as.data.frame(read_csv(paste(outputsDir, "/17x10yrAgeClasses/outputBirdPreds/resStats.csv", sep = "")))
names(resStats_10) <- c("birdSp", "medianRes1D", "medianRes2D_10","moran1D", "moran2D_10")

     resStats_20 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/resStats.csv", sep = "")))
names(resStats_20) <- c("birdSp", "medianRes1D", "medianRes2D_20","moran1D", "moran2D_20")

     resStats_40 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/resStats.csv", sep = "")))
names(resStats_40) <- c("birdSp", "medianRes1D", "medianRes2D_40","moran1D", "moran2D_40")

resStats <- as.data.frame(cbind(resStats_10$birdSp, 
                  resStats_10$moran1D, 
                  resStats_10$moran2D_10, 
                  resStats_20$moran2D_20, 
                  resStats_40$moran2D_40))
names(resStats) <- c("birdSp","moran1D", "moran2D_10", "moran2D_20", "moran2D_40")
resStats$birdSp <- as.factor(resStats$birdSp)
resStats$moran1D <- as.numeric(resStats$moran1D)
resStats$moran2D_10 <- as.numeric(resStats$moran2D_10)
resStats$moran2D_20 <- as.numeric(resStats$moran2D_20)
resStats$moran2D_40 <- as.numeric(resStats$moran2D_40)


## moran stats plot 

moranStats <- resStats %>%
  pivot_longer(
    cols = c(moran1D, moran2D_10, moran2D_20, moran2D_40),        # Columns to pivot
    names_to = "smoothingType",        # New column for the names of the columns
    values_to = "MoransI"        # New column for the values
  )

plotAutocorStats <- ggplot(data = moranStats,
                            aes(fill = factor(smoothingType,
                                             levels=c("moran1D", 
                                                      "moran2D_10", 
                                                      "moran2D_20", 
                                                      "moran2D_40")), 
                                y= MoransI, 
                                x= smoothingType)) + 
    geom_violin(width=0.95) +
  geom_boxplot(width=0.15, color="grey") +
    ggtitle("Spatial autocorrelation of mapped residuals, \nacross bird species") +
    #xlab()  +
    ylab("Moran's I") +
    scale_y_continuous(breaks= pretty_breaks()) +
     scale_x_discrete(labels=c("moran1D" = "1DPS", 
                              "moran2D_10" = "2DPS (10-year\n age classes)",
                              "moran2D_20" = "2DPS (20-year\n age classes)",
                              "moran2D_40" = "2DPS (40-year\n age classes)")) +       
  theme_classic() + 
    scale_fill_manual(values= coloursAllSame, 
                      labels = c( "moran1D", "moran2D")) +
    theme(title = element_text(size = 12),
          legend.title = element_blank(),
          legend.position= "none",
          legend.text = element_text(size =10),
          axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
          axis.text.y = element_text(size = 9),
          axis.title.y = element_text(size = 10),
          axis.title.x = element_blank(),
          plot.margin = margin(0.2,0.2,0.2,0.2, "cm"))

   plotAutocorStats
     
 #################################################################  

   
     allMatrixPlot <- ggarrange(plotUnimodality +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotNormality +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                             ,
                           plotSpearmanStats +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotAutocorStats +
                             theme(title = element_blank())
                           ,
                           ncol = 1,
                           labels = c("(a)", "(b)", "(c)", "(d)"),
                           label.args = list(gp=gpar(font=4, fontsize = 12), x=unit(1,"line"), hjust=1)
                            ) 

   ggsave(file.path(saveLocation,"unimodSpearmanAutocor.jpeg"), allMatrixPlot, width = 14, height = 25, units = "cm")
 
   
   ############################################################################
   
   
    plotUniNorm <- ggarrange(plotUnimodality +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotNormality +
                             theme(title = element_blank())
                           ,
                           ncol = 1,
                           labels = c("(a)", "(b)"),
                           label.args = list(gp=gpar(font=4, fontsize = 12), x=unit(1,"line"), hjust=1)
                            ) 

   ggsave(file.path(saveLocation,"plotUniNorm.jpeg"), plotUniNorm, width = 10, height = 12, units = "cm")
   
   
   #########################################################################################
   
   
      
     plotSpearAuto <- ggarrange(plotSpearmanStats +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotAutocorStats +
                             theme(title = element_blank())
                           ,
                           ncol = 1,
                           labels = c("(a)", "(b)"),
                           label.args = list(gp=gpar(font=4, fontsize = 12), x=unit(1,"line"), hjust=1)
                            ) 

   ggsave(file.path(saveLocation,"plotSpearAuto.jpeg"), plotSpearAuto, width = 10, height = 12, units = "cm")

```




### tables of test stats

```{r tabCombinedUnimodSpearAndMoranAgeClass, echo=FALSE}



#    spearmanStats
   spearmanStats_10 <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats_10) <- c("birdSp", "spearman1D", "spearman2D_10")

spearmanStats_20 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats_20) <- c("birdSp", "spearman1D", "spearman2D_20")

spearmanStats_40 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/spearmanStats.csv", sep = "")))
names(spearmanStats_40) <- c("birdSp", "spearman1D", "spearman2D_40")

spearmanStats <- cbind(spNames$spName, spearmanStats_10,
                       spearmanStats_20$spearman2D_20, 
                       spearmanStats_40$spearman2D_40)

spearmanStats$birdSp <- NULL

names(spearmanStats) <- c("Bird Species", "1D  ", "2D (10 year age classes)", "2D (20 year age classes)", "2D (40 year age classes)")

tabSpearman <- gt::gt(spearmanStats) |> #tab_options(table.border.right.width = 50) |> 
  tab_header(title = "Spearman's Rank Correlation Test Statistic (ρ)") |>
   tab_stubhead(label = "Bird Species")

gtsave(tabSpearman, "spearmanStatsTab.png", path = saveLocation, expand = 50)

   
# resStats
     resStats_10 <- as.data.frame(read_csv(paste(outputsDir, "/outputBirdPreds/resStats.csv", sep = "")))
names(resStats_10) <- c("birdSp", "medianRes1D", "medianRes2D_10","moran1D", "moran2D_10")

     resStats_20 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/resStats.csv", sep = "")))
names(resStats_20) <- c("birdSp", "medianRes1D", "medianRes2D_20","moran1D", "moran2D_20")

     resStats_40 <- as.data.frame(read_csv(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPreds/resStats.csv", sep = "")))
names(resStats_40) <- c("birdSp", "medianRes1D", "medianRes2D_40","moran1D", "moran2D_40")

moranStats <- as.data.frame(cbind(spNames$spName, 
                  resStats_10$birdSp, 
                  resStats_10$moran1D, 
                  resStats_10$moran2D_10, 
                  resStats_20$moran2D_20, 
                  resStats_40$moran2D_40))
names(moranStats) <- c("birdSp", "spCode", "moran1D", "moran2D_10", "moran2D_20", "moran2D_40")
moranStats$birdSp <- as.factor(moranStats$birdSp)
moranStats$spCode <- as.factor(moranStats$spCode)
moranStats$moran1D <- as.numeric(moranStats$moran1D)
moranStats$moran2D_10 <- as.numeric(moranStats$moran2D_10)
moranStats$moran2D_20 <- as.numeric(moranStats$moran2D_20)
moranStats$moran2D_40 <- as.numeric(moranStats$moran2D_40)

moranStats$spCode <- NULL
names(moranStats) <- c("Bird Species", "1D  ", "2D (10 year age classes)", "2D (20 year age classes)", "2D (40 year age classes)")

## moran stats plot 
tabMoran <- gt::gt(moranStats) |> #tab_options(table.border.right.width = 50) |> 
  tab_header(title = "Moran's I") |>
   tab_stubhead(label = "Bird Species")

gtsave(tabMoran, "moranStatsTab.png", path = saveLocation, expand = 50)

   


```



## RASTER VISUALISATION 

###### Single set of three
```{r plotExampleBirdRasters, echo=FALSE}

birdList <- "OVEN"

lapply(birdList, FUN= function(bird){

 # browser()

  print(bird)  
  
nameBird <- spNames[bird,]
nmRas <- terra::rast(paste(inputsDir, "/birdRasterFiles/", bird,"-meanBoot_BCR-60_studyArea_AB_BCR6", sep = ""))
# mapRas <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", .studyAreaName, "_", bird, "-for2DAndLc1DMap", sep = ""))
# resRas <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", bird, "-for2DAndLc1DRes", sep = ""))

mapRas <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", .studyAreaName, "_", bird, "-for2DAndLc1DMap", sep = ""))
resRas <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", bird, "-for2DAndLc1DRes", sep = ""))

allRasters <- c(nmRas, mapRas, resRas)
names(allRasters) <- c("BAM Species Density Raster", "2DPS Prediction \n(10-year age classes)", "Residual")

studyArea <- terra::project(studyArea, y = "+proj=longlat +datum=WGS84")
allRasters <- terra::project(allRasters, y = "+proj=longlat +datum=WGS84")
allRasters <- crop(allRasters, studyArea)

rasterPlot <- ggplot() +
  geom_spatraster(data = allRasters) +
  #coord_sf(crs = 4326) +
  facet_wrap(~lyr, ncol = 3) +
  #scale_colour_paletteer_d("impressionist.colors::la_recolte_des_foins_eragny")+ 
  #scale_fill_viridis(option = "B", na.value="white")+
  scale_fill_gradient2(low = "violetred4", 
                       mid = "white",
                       high = "darkolivegreen", 
                       midpoint = 0,
                       na.value = "white")+
  theme_classic()+
  labs(title = paste(" ", nameBird, " density predictions (males per ha)", sep= ""))+
   theme(title = element_text(size = 14),
        strip.text.x = element_text(
          size = 12),
        strip.text.y = element_text(
          size = 11),
        legend.position="right",
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.key.height = unit(1, "null"),
        strip.background = element_rect(
          color="white", fill="white", linewidth =0.1),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size = 11))

rasterPlot

ggsave(file.path(paste(saveLocation, "/", bird, "_rasterPlots.jpeg", sep = "")), rasterPlot, width = 24, height = 14, units = "cm")


  
})

nmRas <- terra::rast(paste(inputsDir, "/birdRasterFiles/OVEN-meanBoot_BCR-60_studyArea_AB_BCR6", sep = ""))

```



##### All rasters together per species

```{r plotExampleBirdRasters, echo=FALSE}



lapply(birdList, FUN= function(bird){

 # browser()
#bird <- "ALFL"
  print(bird)  
  
nameBird <- spNames[bird,]
nmRas <- terra::rast(paste(inputsDir, "/birdRasterFiles/", bird,"-meanBoot_BCR-60_studyArea_AB_BCR6", sep = ""))
mapRas_1D <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", .studyAreaName, "_", bird, "_for1DAndLc1DMap", sep = ""))
resRas_1D <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", bird, "-for1DAndLc1DRes", sep = ""))

mapRas_2D_10 <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", .studyAreaName, "_", bird, "-for2DAndLc1DMap", sep = ""))
resRas_2D_10 <- terra::rast(paste(outputsDir, "/outputBirdPredsRasters/", bird, "-for2DAndLc1DRes", sep = ""))

mapRas_2D_20 <- terra::rast(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPredsRasters/", .studyAreaName, "_", bird, "-for2DAndLc1DMap", sep = ""))
resRas_2D_20 <- terra::rast(paste(outputsDir, "/9x20yrAgeClasses/outputBirdPredsRasters/", bird, "-for2DAndLc1DRes", sep = ""))

mapRas_2D_40 <- terra::rast(paste(outputsDir, "/5x40yrAgeClasses/outputBirdPredsRasters/", .studyAreaName, "_", bird, "-for2DAndLc1DMap", sep = ""))
resRas_2D_40 <- terra::rast(paste(outputsDir, "/5x40yrAgeClasses/outputBirdPredsRasters/", bird, "-for2DAndLc1DRes", sep = ""))

allRasters <- c(nmRas, mapRas_1D, resRas_1D, mapRas_2D_10, resRas_2D_10, mapRas_2D_20, resRas_2D_20,  mapRas_2D_40, resRas_2D_40 )
names(allRasters) <- c("BAM Model Raster", "1D Smoothing Prediction", "1D Smoothing Residual", 
                       "2D Smoothing Prediction (10-year age classes)", "2D Smoothing Residual (10 year age classes)", 
                       "2D Smoothing Prediction (20-year age classes)", "2D Smoothing Residual (20 year age classes)", 
                       "2D Smoothing Prediction (40-year age classes)", "2D Smoothing Residual (40 year age classes)")

studyArea <- terra::project(studyArea, y = "+proj=longlat +datum=WGS84")
allRasters <- terra::project(allRasters, y = "+proj=longlat +datum=WGS84")
allRasters <- crop(allRasters, studyArea)
#allRasters <- stack(allRasters)
allRasAsDF <- as.data.frame(allRasters, xy = TRUE, cells = TRUE)

allRasAsDF <- pivot_longer(allRasAsDF, 
                             cols = c(4:12),  
               names_to = "RasterName",  # new column for day names
               values_to = "value") 
allRasAsDF <- allRasAsDF %>%
  mutate(rasterType = case_when(
    RasterName == "BAM Model Raster" ~ "BAM Model Raster",
    RasterName == "1D Smoothing Prediction" ~ "Piecewise Smoothing Map",
    RasterName == "2D Smoothing Prediction (10 year age classes)" ~ "Piecewise Smoothing Map",
    RasterName == "2D Smoothing Prediction (20 year age classes)" ~ "Piecewise Smoothing Map",
    RasterName == "2D Smoothing Prediction (40 year age classes)" ~ "Piecewise Smoothing Map",
    RasterName ==  "1D Smoothing Residual" ~ "Residual",
    RasterName ==  "2D Smoothing Residual (10 year age classes)" ~ "Residual",
     RasterName ==  "2D Smoothing Residual (20 year age classes)" ~ "Residual",
     RasterName ==  "2D Smoothing Residual (40 year age classes)" ~ "Residual",
  )) %>%
  mutate(smoothingType = case_when(
    RasterName == "BAM Model Raster" ~ "1D Piecewise Smoothing",
    RasterName == "1D Smoothing Prediction" ~ "1D Piecewise Smoothing",
    RasterName == "2D Smoothing Prediction (10 year age classes)" ~ "2D Piecewise Smoothing \n(10 year age classes)",
    RasterName == "2D Smoothing Prediction (20 year age classes)" ~ "2D Piecewise Smoothing \n(20 year age classes)",
    RasterName == "2D Smoothing Prediction (40 year age classes)" ~ "2D Piecewise Smoothing \n(40 year age classes)",
    RasterName ==  "1D Smoothing Residual" ~ "1D Piecewise Smoothing",
    RasterName ==  "2D Smoothing Residual (10 year age classes)" ~ "2D Piecewise Smoothing \n(10 year age classes)",
    RasterName ==  "2D Smoothing Residual (20 year age classes)" ~ "2D Piecewise Smoothing \n(20 year age classes)",
    RasterName ==  "2D Smoothing Residual (40 year age classes)" ~ "2D Piecewise Smoothing \n(40 year age classes)",
  ))
  #facet_grid(facet_row ~ layer, scales = "free") + # Faceting by layer and facet_row
 
rasterPlot <- ggplot(allRasAsDF) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  #geom_spatraster(data = allRasters) +
  #coord_sf(crs = 4326) +
  facet_grid(smoothingType ~ rasterType) +
  #scale_colour_paletteer_d("impressionist.colors::la_recolte_des_foins_eragny")+ 
  #scale_fill_viridis(option = "B", na.value="white")+
  scale_fill_gradient2(mid = "white",
                       midpoint = 0,
                       low = "violetred4", 
                       high = "darkolivegreen", 
                       na.value = "white")+
  theme_classic()+
  labs(title = paste(" ", nameBird, " density predictions (males/ha)", sep= ""))+
   theme(title = element_text(size = 14),
        strip.text.x = element_text(
          size = 12),
        strip.text.y = element_text(
          size = 11),
        legend.position="right",
        legend.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.key.height = unit(1, "null"),
        strip.background = element_rect(
          color="white", fill="white", linewidth =0.1),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank())

rasterPlot

ggsave(file.path(paste(saveLocation, "/", bird, "_rasterPlots.jpeg", sep = "")), rasterPlot, width = 22, height = 45, units = "cm")


  
})



```




















#TWO STUDY AREAS

## summary landscape plot

```{r landscapeSummaryPlots, echo=FALSE}

 #get rasterToMatch
    print("get rasterTomatch from local drive")
    rasterToMatch <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/LCCProducts/LCC05/LCC2005_V1_4a.tif"))
   
    
    #get StudyArea shapefile
    print("get studyArea shapefile from local drive")
    studyArea <- terra::vect(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/studyAreaAB.shp"))
    
    #postProcess studyArea
    studyArea <- reproducible::postProcess(studyArea,
                                               destinationPath = getwd(),
                                               filename2 = "studyArea", 
                                               useTerra = TRUE,
                                               fun = "terra::vect", #use the function vect
                                               targetCRS = crs(rasterToMatch), #make crs same as rasterToMatch
                                               overwrite = TRUE,
                                               verbose = TRUE)
    
    #crop and mask rasterToMatch
    rasterToMatch <- terra::mask(terra::crop(rasterToMatch, studyArea), studyArea) 
    names(rasterToMatch) <- "rasterToMatch"
    # clearPlot()
    # Plot(sim$rasterToMatch)
    plot(rasterToMatch, colNA = "grey")
    
    # get forest class raster
    print("get forClassRaster from Drive")
    forClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/vegTypesRas_ABNew_0722.tif"))
    forClassRaster <- postProcess(forClassRaster,
                                      destinationPath = getwd(),
                                     #use the function raster
                                     targetCRS = crs(rasterToMatch),
                                     fun = "terra::rast",
                                     useTerra = TRUE,
                                     #use the specified rasterToMatch to reproject to
                                     rasterToMatch = rasterToMatch,
                                     #studyArea = studyArea,
                                     useCache = getOption("reproducible.useCache", TRUE),
                                     overwrite = TRUE,
                                     verbose = TRUE)
    
    names(forClassRaster) <- c("forClassRaster")
    
    forClassRaster[forClassRaster == 0] <- NA
    
     # clearPlot()
    # Plot(forClassRaster, na.color= "grey")
    plot(forClassRaster, colNA = "grey")
    #get non forest raster
    print("get landClassRaster from Drive")
    landClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/landClassRaster_AB_202305.tif"))
    landClassRaster <- postProcess(landClassRaster,
                               destinationPath = getwd(),
                               #use the function raster
                               fun = "terra::rast",
                               targetCRS = crs(rasterToMatch),
                               #use the specified rasterToMatch to reproject to
                               rasterToMatch = rasterToMatch,
                               useTerra = TRUE,
                               #studyArea = sim$studyArea,
                               useCache = getOption("reproducible.useCache", TRUE),
                               overwrite = TRUE,
                               verbose = TRUE)
    
    #landClassRaster[landClassRaster == 0] <- NA
    
    names(landClassRaster) <- c("landClassRaster")
    landClassRaster <- terra::mask(landClassRaster, forClassRaster, inverse = TRUE)
    # landClassRaster <- overlay(x = landClassRaster,
    #                         y = forClassRaster,
    #                         fun = function(x, y) {
    #                           x[!is.na(y[])] <- NA
    #                           return(x)
    #                         })
    # 
    # clearPlot()
    # Plot(landClassRaster, na.color= "grey")
    plot(landClassRaster, colNA = "grey")
   
     #get age raster
    print("get ageRaster from Drive")
    ageRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/ageRas_ABNew_0722.tif"))
    ageRaster <- postProcess(ageRaster,
                                destinationPath = getwd(),
                                #use the function raster
                                useTerra = TRUE,
                                fun = "terra::rast",
                                #targetCRS = crs(rasterToMatch),
                                #use the specified rasterToMatch to reproject to
                                rasterToMatch = rasterToMatch,
                                #studyArea = studyArea,
                                useCache = getOption("reproducible.useCache", TRUE),
                                overwrite = TRUE,
                                verbose = TRUE)
    
    names(ageRaster) <- c("ageRaster")
    plot(ageRaster, colNA = "grey")

#make landscape raster
  print("make landscapeRaster")
  landscapeRaster <- terra::cover(x = forClassRaster, y = landClassRaster)
  
  names(landscapeRaster) <- c("landscapeRaster")
  
  # clearPlot()
  # Plot(landscapeRaster, na.color= "grey")
 plot(landscapeRaster, colNA = "turquoise")
  #create a raster that gives if an area is forest or not 
  #(0 for non-forest, 1 for forest)
  #This will allow me to have a value in the birdDataset 
  #that says if a cell was forested or not
  print("make FNFRaster")
  #make forest 1
  uniqueValsFR <- terra::unique(forClassRaster,incomparables=FALSE)
  newValsFR <-  as.factor(rep("1", length(uniqueValsFR$forClassRaster))) #make vector that repeats 1 as amy times as there are unique values
  newValsFR <- cbind(uniqueValsFR$forClassRaster, newValsFR)
  newValsFR <- na.omit(newValsFR)
  reclassMatrixFR <- matrix(newValsFR,
                            ncol=2, byrow = FALSE)
  rasterFR <- terra::classify(forClassRaster,
                         reclassMatrixFR)
  #make nonFor 0
  #valsNF <- unique(sim$rasterToMatch) #get vector of all the unique values in the forClassRaster
  uniqueValsNF <- terra::unique(rasterToMatch, incomparables=FALSE)
  newValsNF <-  rep(0, length(uniqueValsNF$rasterToMatch)) #make vector that repeats 0 as amy times as there are unique values
  newValsNF <- cbind(uniqueValsNF$rasterToMatch, newValsNF)
  newValsNF <- na.omit(newValsNF)
  reclassMatrixNF <- matrix(newValsNF,
                            ncol=2, byrow = FALSE)
  rasterNF <- terra::classify(rasterToMatch,
                         reclassMatrixNF)
  
  FNFRaster <- terra::cover(x = rasterFR, y = rasterNF)
  
  names(FNFRaster) <- c("FNFRaster")
  plot(FNFRaster, colNA = "grey")

allLandRasters <- c( forClassRaster, landClassRaster, landscapeRaster, 
                     ageRaster, FNFRaster, rasterToMatch)
    
    
    ## take the values from the rasters and input 
    ## them to a data table called cellValues
    allLandData <- data.table(terra::values(allLandRasters))
    allLandData <- setnames(allLandData, c( "forClassRaster", 
                                          "landClassRaster", 
                                          "landscapeRaster", 
                                          "ageRaster",
                                          "FNFRaster",
                                          "LCC05"))
  allLandData <- unite(allLandData, 
                        landForClass, 
                        c(FNFRaster, 
                          landscapeRaster), 
                        remove=FALSE)
  
    allLandData$FNFRaster <- as.factor(allLandData$FNFRaster)
    allLandData$landForClass <- as.factor(allLandData$landForClass)
     allLandData$LCC05 <- as.factor(allLandData$LCC05)
     
     
     studyArea <- rep("AB", each = nrow(allLandData))
     allLandData <- cbind(allLandData, studyArea) 
    
    #get rid of any rows with NA values
    allLandData <- subset(allLandData, !is.na(landscapeRaster)) 
   #allLandData <- na.omit(allLandData, cols = "ageraster")   
   
 allLandData_AB <- as.data.table(allLandData)
 
 #sort(unique(allLandData$landForClass)) #this shows us that there are nonForestedAreas with no landscapeRaster


 # #check that there are no unwanted overlaps for nonForest raster
 # nonForDat <- na.omit(allLandData, cols = "landClassRaster") 
 # unique(nonForDat$forClassRaster)
 # unique(nonForDat$landForClass)
 #  unique(nonForDat$landscapeRaster)
 #  unique(nonForDat$ageRaster)
 #  unique(nonForDat$FNFRaster)
 #  sort(unique(nonForDat$LCC05) ) 
 #  
 #   #check that there are no unwanted overlaps for nonForest raster
 #  forClasDat <- na.omit(allLandData, cols = "forClassRaster") 
 # unique(forClasDat$landClassRaster)
 # sort(unique(forClasDat$landForClass))
 #  sort(unique(forClasDat$landscapeRaster))
 #  sort(unique(forClasDat$ageRaster))
 #    unique(forClasDat$FNFRaster)
 #    sort(unique(forClasDat$LCC05)) 
  
  
     
 
#get BC data
      #get rasterToMatch
    print("get rasterTomatch from local drive")
    rasterToMatch <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/LCCProducts/LCC05/LCC2005_V1_4a.tif"))
   
    
    #get StudyArea shapefile
    print("get studyArea shapefile from local drive")
    studyArea <- terra::vect(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/BCR6_BC.shp"))
    
    #postProcess studyArea
    studyArea <- reproducible::postProcess(studyArea,
                                               destinationPath = getwd(),
                                               filename2 = "studyArea", 
                                               useTerra = TRUE,
                                               fun = "terra::vect", #use the function vect
                                               targetCRS = crs(rasterToMatch), #make crs same as rasterToMatch
                                               overwrite = TRUE,
                                               verbose = TRUE)
    
    #crop and mask rasterToMatch
    rasterToMatch <- terra::mask(terra::crop(rasterToMatch, studyArea), studyArea) 
    names(rasterToMatch) <- "rasterToMatch"
    # clearPlot()
    # Plot(sim$rasterToMatch)
    plot(rasterToMatch, colNA = "grey")
    
    # get forest class raster
    print("get forClassRaster from Drive")
    forClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/vegTypesRas_BC_0722.tif"))
    forClassRaster <- postProcess(forClassRaster,
                                      destinationPath = getwd(),
                                     #use the function raster
                                     targetCRS = crs(rasterToMatch),
                                     fun = "terra::rast",
                                     useTerra = TRUE,
                                     #use the specified rasterToMatch to reproject to
                                     rasterToMatch = rasterToMatch,
                                     #studyArea = studyArea,
                                     useCache = getOption("reproducible.useCache", TRUE),
                                     overwrite = TRUE,
                                     verbose = TRUE)
    
    names(forClassRaster) <- c("forClassRaster")
    
    forClassRaster[forClassRaster == 0] <- NA
    
     # clearPlot()
    # Plot(forClassRaster, na.color= "grey")
    plot(forClassRaster, colNA = "grey")
    #get non forest raster
    print("get landClassRaster from Drive")
    landClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/landClassRaster_BC_202305.tif"))
    landClassRaster <- postProcess(landClassRaster,
                               destinationPath = getwd(),
                               #use the function raster
                               fun = "terra::rast",
                               targetCRS = crs(rasterToMatch),
                               #use the specified rasterToMatch to reproject to
                               rasterToMatch = rasterToMatch,
                               useTerra = TRUE,
                               #studyArea = sim$studyArea,
                               useCache = getOption("reproducible.useCache", TRUE),
                               overwrite = TRUE,
                               verbose = TRUE)
    
    #landClassRaster[landClassRaster == 0] <- NA
    
    names(landClassRaster) <- c("landClassRaster")
    landClassRaster <- terra::mask(landClassRaster, forClassRaster, inverse = TRUE)
    # landClassRaster <- overlay(x = landClassRaster,
    #                         y = forClassRaster,
    #                         fun = function(x, y) {
    #                           x[!is.na(y[])] <- NA
    #                           return(x)
    #                         })
    # 
    # clearPlot()
    # Plot(landClassRaster, na.color= "grey")
    plot(landClassRaster, colNA = "grey")
   
     #get age raster
    print("get ageRaster from Drive")
    ageRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/ageRas_BC_0722.tif"))
    ageRaster <- postProcess(ageRaster,
                                destinationPath = getwd(),
                                #use the function raster
                                useTerra = TRUE,
                                fun = "terra::rast",
                                #targetCRS = crs(rasterToMatch),
                                #use the specified rasterToMatch to reproject to
                                rasterToMatch = rasterToMatch,
                                #studyArea = studyArea,
                                useCache = getOption("reproducible.useCache", TRUE),
                                overwrite = TRUE,
                                verbose = TRUE)
    
    names(ageRaster) <- c("ageRaster")
    plot(ageRaster, colNA = "grey")

#make landscape raster
  print("make landscapeRaster")
  landscapeRaster <- terra::cover(x = forClassRaster, y = landClassRaster)
  
  names(landscapeRaster) <- c("landscapeRaster")
  
  # clearPlot()
  # Plot(landscapeRaster, na.color= "grey")
 plot(landscapeRaster, colNA = "turquoise")
  #create a raster that gives if an area is forest or not 
  #(0 for non-forest, 1 for forest)
  #This will allow me to have a value in the birdDataset 
  #that says if a cell was forested or not
  print("make FNFRaster")
  #make forest 1
  uniqueValsFR <- terra::unique(forClassRaster,incomparables=FALSE)
  newValsFR <-  as.factor(rep("1", length(uniqueValsFR$forClassRaster))) #make vector that repeats 1 as amy times as there are unique values
  newValsFR <- cbind(uniqueValsFR$forClassRaster, newValsFR)
  newValsFR <- na.omit(newValsFR)
  reclassMatrixFR <- matrix(newValsFR,
                            ncol=2, byrow = FALSE)
  rasterFR <- terra::classify(forClassRaster,
                         reclassMatrixFR)
  #make nonFor 0
  #valsNF <- unique(sim$rasterToMatch) #get vector of all the unique values in the forClassRaster
  uniqueValsNF <- terra::unique(rasterToMatch, incomparables=FALSE)
  newValsNF <-  rep(0, length(uniqueValsNF$rasterToMatch)) #make vector that repeats 0 as amy times as there are unique values
  newValsNF <- cbind(uniqueValsNF$rasterToMatch, newValsNF)
  newValsNF <- na.omit(newValsNF)
  reclassMatrixNF <- matrix(newValsNF,
                            ncol=2, byrow = FALSE)
  rasterNF <- terra::classify(rasterToMatch,
                         reclassMatrixNF)
  
  FNFRaster <- terra::cover(x = rasterFR, y = rasterNF)
  
  names(FNFRaster) <- c("FNFRaster")
  plot(FNFRaster, colNA = "grey")

allLandRasters <- c( forClassRaster, landClassRaster, landscapeRaster, 
                     ageRaster, FNFRaster, rasterToMatch)
    
    
    ## take the values from the rasters and input 
    ## them to a data table called cellValues
    allLandData <- data.table(terra::values(allLandRasters))
    allLandData <- setnames(allLandData, c( "forClassRaster", 
                                          "landClassRaster", 
                                          "landscapeRaster", 
                                          "ageRaster",
                                          "FNFRaster",
                                          "LCC05"))
  allLandData <- unite(allLandData, 
                        landForClass, 
                        c(FNFRaster, 
                          landscapeRaster), 
                        remove=FALSE)
  
    allLandData$FNFRaster <- as.factor(allLandData$FNFRaster)
    allLandData$landForClass <- as.factor(allLandData$landForClass)
     allLandData$LCC05 <- as.factor(allLandData$LCC05)
     
     
     studyArea <- rep("BC", each = nrow(allLandData))
     allLandData <- cbind(allLandData, studyArea) 
    
    #get rid of any rows with NA values
    allLandData <- subset(allLandData, !is.na(landscapeRaster)) 
  
 allLandData_BC <- as.data.table(allLandData)
 
 allLandData <- rbind(allLandData_AB,allLandData_BC)
 
 #sort(unique(allLandData$landForClass)) #this shows us that there are nonForestedAreas with no landscapeRaster


 # #check that there are no unwanted overlaps for nonForest raster
 # nonForDat <- na.omit(allLandData, cols = "landClassRaster") 
 # unique(nonForDat$forClassRaster)
 # unique(nonForDat$landForClass)
 #  unique(nonForDat$landscapeRaster)
 #  unique(nonForDat$ageRaster)
 #  unique(nonForDat$FNFRaster)
 #  sort(unique(nonForDat$LCC05) ) 
 #  
 #   #check that there are no unwanted overlaps for nonForest raster
 #  forClasDat <- na.omit(allLandData, cols = "forClassRaster") 
 # unique(forClasDat$landClassRaster)
 # sort(unique(forClasDat$landForClass))
 #  sort(unique(forClasDat$landscapeRaster))
 #  sort(unique(forClasDat$ageRaster))
 #    unique(forClasDat$FNFRaster)
 #    sort(unique(forClasDat$LCC05)) 
  
  
 landDatStats_AB <- allLandData_AB[order(FNFRaster, 
                                         landForClass) 
                                   # order the rows by the land cover class
                                   ][,list(classCount = .N
                                           ),
                                           by = list(FNFRaster, 
                                         landForClass)]
     
     studyArea <- rep("AB", each = nrow(landDatStats_AB))
     landDatStats_AB <-cbind(landDatStats_AB, studyArea) 
     
     landDatStats_BC <- allLandData_BC[order(FNFRaster, 
                                         landForClass) 
                                   # order the rows by the land cover class
                                   ][,list(classCount = .N),
                                           by = list(FNFRaster, 
                                         landForClass)]
     
     studyArea <- rep("BC", each = nrow(landDatStats_BC))
     landDatStats_BC <-cbind(landDatStats_BC, studyArea) 
      
    landDatStats <- rbind(landDatStats_AB, landDatStats_BC)
    landDatStats[ , propArea := classCount/sum(classCount), by = studyArea]
     
###############################################################################################################################################################################################################################################################################################################################################################
    
 ras.labs <- c("Land cover class raster", "Forest class raster")
names(ras.labs) <- c("0", "1")   
    
# make bar chart of different landForClass
    #classDat <- landDatStats[-8,]



    plotClassCounts <- ggplot(data = landDatStats,
                              aes(x = landForClass,
                                  y = propArea,
                                  fill = factor(studyArea, levels=c("BC", "AB")))) +
    geom_bar(stat = "identity",
             position = "dodge",
             width = 0.7) +
      facet_wrap(. ~ FNFRaster, scales = "free", labeller = labeller(FNFRaster= ras.labs))+
    theme_classic() +
    labs(tag = "A") +
      #ggtitle(paste0("Proportional area by cover class")) +
    ylab("Proportion of study area") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
   scale_x_discrete(labels=c("0_0" = "Forest", "0_1" = "Water/Ice", "0_2" = "Wetland", "0_3" = "Anthro/\nExposed", "0_4" = "Grass/\nCrop" , "0_5" = "Shrub", "0_6" = "Bryoid", "1_7" = "White \nSpruce", "1_1" = "Black \nSpruce", "1_2" = "  Black  \nSpruce Wet", "1_6" = "Pine", "1_3" = "Conifer Mix",  "1_5" = "Mixed", "1_4" = "Deciduous"  )) +
    theme(title = element_text(size = 16),
        strip.text.x = element_text(size = 14),
        strip.text.y = element_text(size = 14),
        strip.background = element_rect(
        color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_blank(),
        plot.margin = margin(0,0.5,0,0.1, "cm"),
        legend.position="NULL")
 plotClassCounts   

 
 
 

  

######################################################################################################################################################################################################################################
  
 
 allLandData <- allLandData[allLandData$FNFRaster == 1, ]
 allLandData <- subset(allLandData, !is.na(ageRaster)) 
 allLandData_age <- allLandData

 #assign age class column
 ageGrouping <- 20
 maxAgeClass <- 10
 maxAge <- max(allLandData_age$ageRaster) #get age of oldest cell 
 maxAgeClassAge <- maxAgeClass*ageGrouping 
 
     ifelse(maxAge > maxAgeClassAge, ageRaster <- c(0:maxAge), ageRaster <- c(0:maxAgeClassAge)) #make a vector that counts from 0 to 
  maxAge <-   as.numeric(maxAge)
 noAgeClasses <- maxAge/ageGrouping
 ageClass <- ifelse(noAgeClasses < maxAgeClass, ageClass <- maxAgeClass, ageClass <- noAgeClasses )
    ageClass <- rep(1:ageClass, each = ageGrouping)
    ageClass <- c(1, ageClass)
    if(noAgeClasses > maxAgeClass){
      ageClassDiff <- noAgeClasses - maxAgeClass
      extraClass <- maxAgeClass + (1:ageClassDiff)
      for (x in extraClass) {
        print(x)
        ageClass <- replace(ageClass ,ageClass== x,maxAgeClass)
              } 
    }
 
 ageRefTab <- cbind(ageRaster, ageClass) #creates a lookup table of age to age class
 ageRefTab <- as.data.table(ageRefTab)
 ageRefTab$ageRaster <- as.character(ageRefTab$ageRaster)
 ageRefTab$ageClass <- as.character(ageRefTab$ageClass)
 #allLandData$ageClass = allLandData$ageRaster #replicate age data in new column
 
 #replace ages with ageClass in ageClass column
 # new <- allLandData
 # new[] <- lapply(allLandData, function(x) ageRefTab$ageClass[match(x, ageRefTab$ageRaster)])
# ageClassTab[] <- ageRefTab$ageClass[match(unlist(allLandData), ageRefTab$ageRaster)]

 library(dplyr)
library(tidyr)
 allLandData_age$ageRaster <- as.character(allLandData_age$ageRaster)
 #storeDat <- allLandData
allLandData_age %>% pivot_longer(cols = "ageRaster")
 allLandData_age <-  allLandData_age %>% left_join(ageRefTab, by = "ageRaster") 
   #allLandData %>% pivot_wider(key = ageRaster, value = ageClass)
  allLandData_age
 
 landDatStats_age <- allLandData_age[order(studyArea,
                                        ageClass)
                                  # order the rows by the land cover class
                                  ][,list(classCount = .N
                                          ),
                                          by = list(studyArea, ageClass
                                        )]

   landDatStats_age[ , propArea := classCount/sum(classCount), by = studyArea]
   AB9 <- list("AB", 9, 0, 0)
   AB10 <- list("AB", 10, 0, 0)
   landDatStats_age <- rbind(landDatStats_age, AB9)
   landDatStats_age <- rbind(landDatStats_age, AB10)
 
 # landDatStats_AB <- allLandData_AB[order(FNFRaster, 
  #                                        landForClass) 
  #                                  # order the rows by the land cover class
  #                                  ][,list(classCount = .N
  #                                          ),
  #                                          by = list(FNFRaster, 
  #                                        landForClass)]
  #    
  #    studyArea <- rep("AB", each = nrow(landDatStats_AB))
  #    landDatStats_AB <-cbind(landDatStats_AB, studyArea) 
  #    
  #    landDatStats_BC <- allLandData_BC[order(FNFRaster, 
  #                                        landForClass) 
  #                                  # order the rows by the land cover class
  #                                  ][,list(classCount = .N),
  #                                          by = list(FNFRaster, 
  #                                        landForClass)]
  #    
  #    studyArea <- rep("BC", each = nrow(landDatStats_BC))
  #    landDatStats_BC <-cbind(landDatStats_BC, studyArea) 
  #     
  #   landDatStats <- rbind(landDatStats_AB, landDatStats_BC)
  #   landDatStats[ , propArea := classCount/sum(classCount), by = studyArea]
 
# make histogram of ages
  #landDatNoNAs <- na.omit(allLandData)
#   class.labs <- c("Forested", "Water/Ice", "Wetland", "Anthro/Exposed", "Grass/Crop", "Shrub", "Bryoid", "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce")
# names(class.labs) <- c("0_0", "0_1", "0_2", "0_3", "0_4", "0_5", "0_6", "1_1", "1_2", "1_3", "1_4", "1_5", "1_6", "1_7")


  # ggplot(aes(x = hwy)) +
  # #geom_histogram(aes(y = after_stat(count / sum(count))),binwidth=6) +
  # scale_y_continuous(labels = scales::percent)

  #ageHistDat <- na.omit(allLandData, cols = "forClassRaster")
 ageDistribution <- ggplot(data = landDatStats_age,
                              aes(x = ageClass,
                                  y = propArea,
                                  fill = factor(studyArea, levels=c("BC", "AB")))) +
    geom_bar(stat = "identity",
             position = "dodge",
             width = 0.7) +
   labs(tag = "B") +
    #ggtitle(paste0("Forest age class structure")) +
    xlab("Age (yrs)") +
    ylab("Proportion of study area") +
    theme_classic()+
   scale_x_discrete(labels=c("1" = "0-20","2" = "21-40","3" = "41-60","4"= "61-80","5"= "81-100","6"= "101-120","7"= "121-140", "8" = "141-160","9" = "161-180", "10" = "181+"),
                   limits=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
     theme(title = element_text(size = 16),
        strip.text.x = element_text(size = 14),
        strip.text.y = element_text(size = 14),
        strip.background = element_rect(
        color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_text(size = 12),
        legend.title = element_blank(),
        legend.text = element_blank(),
        plot.margin = margin(0,0,0.5,0.3, "cm"),
        legend.position="NULL")
  ageDistribution
 
# # examine 0 class
#   class0 <- allLandData[landClassRaster == "0"]
#   class0 <- droplevels(class0)
#   list(unique(class0$LCC05))
#   
#   
#  class0Stats <- class0[order(LCC05)  
#                        ][,list(classCount = .N), 
#                                                                                       by = list(LCC05)]
#     class0Stats
#  class0Stats$LCC05 <- as.factor(class0Stats$LCC05)
#  
#     plot0Class <- ggplot(data = class0Stats,
#                               aes(x = LCC05,
#                                   y = classCount)) +
#     geom_bar(stat = "identity",
#              width = 0.7, 
#              fill = 'goldenrod2') +
#     theme_classic() +
#     ggtitle(paste0("BC - LCC05 class distribution for remaining forest class cells in non-forest raster")) +
#     xlab("LCC05 class") +
#     ylab("Pixel count") 
#   plot0Class
    
    
#     
#   #examine areas that have a 0 for FNFRaster, but NA for landscapeRaster (are in the study area, but have no data from forest raster or non-forest raster)
#   class0_NA <- allLandData[landForClass == "0_NA"]
#   class0_NA <- droplevels(class0_NA)
#   list(unique(class0_NA$LCC05))
#  
#   class0_NAStats <- class0_NA[order(LCC05)  
#                        ][,list(classCount = .N), 
#                                                                                       by = list(LCC05)]
#     class0_NAStats
#  class0_NAStats$LCC05 <- as.factor(class0_NAStats$LCC05)
#  
#     plot0_NAClass <- ggplot(data = class0_NAStats,
#                               aes(x = LCC05,
#                                   y = classCount)) +
#     geom_bar(stat = "identity",
#              width = 0.7, 
#              fill = 'goldenrod2') +
#     theme_classic() +
#     ggtitle(paste0("BC - LCC05 class distribution for areas with 0_NA class (no data from forest or non forest rasters)")) +
#     xlab("LCC05 class") +
#     ylab("Pixel count") 
#   plot0_NAClass
#     
#   plot(landscapeRaster, colNA="red") #it is possible to see a few pixels dotted across the landscapeRaster that do not have values
#   
# 
#   
# #find out LCC05 classes within each of our defined classes
# class.labs <- c("Forested", "Water/Ice", "Wetland", "Anthro/Exposed", "Grass/Crop", "Shrub", "Bryoid", "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce")
# names(class.labs) <- c("0_0", "0_1", "0_2", "0_3", "0_4", "0_5", "0_6", "1_1", "1_2", "1_3", "1_4", "1_5", "1_6", "1_7")
# 
# raster.labs <- c("Not in forest raster", "In forest raster")
# names(raster.labs) <- c("0", "1")
# 
#   histLCC05ByClass   <-  gghistogram(
#     stat = "count",
#   allLandData, x = "LCC05", 
#   fill = "FNFRaster"
#   ) +
#     facet_nested( FNFRaster + landForClass ~. ,
#                  labeller = labeller(landForClass = class.labs, FNFRaster = raster.labs),
#                   scales = 'free_y'
#                  ) +
#      ggtitle(paste0("AB - Histogram of LCC05 Value by Class")) +
#      xlab("LCC05 value") +
#      ylab("Number of pixels") +
#     theme(title = element_text(size = 16),
#         strip.text.x = element_text(size = 14),
#         strip.text.y = element_text(size = 14),
#         strip.background = element_rect(
#         color="white", fill="white", linewidth =1.5),
#         axis.text.y = element_text(size = 12),
#         axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
#         axis.title.y = element_text(size = 14),
#         axis.title.x = element_blank(),
#         legend.title = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.position="bottom",
#         plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))
#  histLCC05ByClass 

 
 ######################################################################################################################################################################################################################################
 
 
 # make bar chart of mean age by landForClass


     ageStats <- allLandData[order(studyArea, 
                                         landForClass) 
                                   # order the rows by the land cover class
                                   ][,list(classCount = .N, 
                                           meanAge = mean(ageRaster)),
                                           by = list(studyArea, 
                                         landForClass)]
     
    
 #ageStats <- na.omit(classDat, cols = "meanAge")    
 plotMeanAgeByClass <- ggplot(data = ageStats,
                              aes(x = landForClass,
                                  y = meanAge,
                                  fill = factor(studyArea, levels=c("BC", "AB")))) +
    geom_bar(stat = "identity",
             position = "dodge",
             width = 0.7) +
    theme_classic() +
   # ggtitle(paste0("Mean age by forest class")) +
   labs(tag = "C") +
    xlab("Forest class") +
    ylab("Mean age") +
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
   scale_x_discrete(labels=c("1_1" = "Black \nSpruce", "1_2" = "Black \nSpruce Wet", "1_3" = "Conifer Mix", "1_4" = "Deciduous", "1_5" = "Mixed", "1_6" = "Pine", "1_7" = "White \nSpruce")) +
  theme(title = element_text(size = 16),
        strip.text.x = element_text(size = 14),
        strip.text.y = element_text(size = 14),
        strip.background = element_rect(
        color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.margin = margin(0,0.5,0,0, "cm"),
        legend.position="bottom")
  plotMeanAgeByClass 
  
######################################################################################################################################################################################################################################

# put landscape plots together

lay <- rbind(c(1,1), c(2,3))

landscapeSummary <- gridExtra::grid.arrange(plotClassCounts,  
                                            ageDistribution, 
                                            plotMeanAgeByClass, 
                                            layout_matrix = lay
                                               )

  
  #    
  # allMatrixPlot <- ggarrange( plotClassCounts +
  #                             theme(title = element_blank())
  #                          ,
  #                          ageDistribution +
  #                             theme(title = element_blank())
  #                          ,
  #                          plotMeanAgeByClass+
  #                             theme(title = element_blank()),
  #                            widths = c(2, 1, 1), 
  #                            #heights = c(1, 1, 1),
  #                          #layout_matrix = lay,
  #                           nrow = 2,
  #                           #ncol = 2,
  #                          labels = c("A", "B", "C"),
  #                          label.args = list(gp=gpar(font=4, fontsize = 16), x=unit(1,"line"), hjust=1)
  #                           ) 
  
  
#   library(gridExtra)
# grid.arrange(bp, dp, vp, sc, ncol=2, nrow =2)
```





##landscape rasters maps

```{r landscapeRasterMaps, echo=FALSE}

# GET AB LANDSCAPE RASTERS

 #get rasterToMatch
    print("get rasterTomatch from local drive")
    AB_rasterToMatch <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/LCCProducts/LCC05/LCC2005_V1_4a.tif"))
   
    
    #get StudyArea shapefile
    print("get studyArea shapefile from local drive")
    AB_studyArea <- terra::vect(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/studyAreaAB.shp"))
    
    #postProcess studyArea
    AB_studyArea <- reproducible::postProcess(AB_studyArea,
                                               destinationPath = getwd(),
                                               filename2 = "AB_studyArea", 
                                               useTerra = TRUE,
                                               fun = "terra::vect", #use the function vect
                                               targetCRS = crs(AB_rasterToMatch), #make crs same as rasterToMatch
                                               overwrite = TRUE,
                                               verbose = TRUE)
    
    #crop and mask rasterToMatch
    AB_rasterToMatch <- terra::mask(terra::crop(AB_rasterToMatch, AB_studyArea), AB_studyArea) 
    names(AB_rasterToMatch) <- "AB_rasterToMatch"
    # clearPlot()
    # Plot(sim$rasterToMatch)
    #plot(AB_rasterToMatch, colNA = "grey")
    
    # get forest class raster
    print("get forClassRaster from Drive")
    AB_forClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/vegTypesRas_ABNew_0722.tif"))
    AB_forClassRaster <- postProcess(AB_forClassRaster,
                                      destinationPath = getwd(),
                                     #use the function raster
                                     targetCRS = crs(AB_rasterToMatch),
                                     fun = "terra::rast",
                                     useTerra = TRUE,
                                     #use the specified rasterToMatch to reproject to
                                     rasterToMatch = AB_rasterToMatch,
                                     #studyArea = studyArea,
                                     useCache = getOption("reproducible.useCache", TRUE),
                                     overwrite = TRUE,
                                     verbose = TRUE)
    
    names(AB_forClassRaster) <- c("AB_forClassRaster")
    
    AB_forClassRaster[AB_forClassRaster == 0] <- NA
    
     # clearPlot()
    # Plot(forClassRaster, na.color= "grey")
    #plot(AB_forClassRaster, colNA = "grey")
    #get non forest raster
    print("get landClassRaster from Drive")
    AB_landClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/landClassRaster_AB_202305.tif"))
    AB_landClassRaster <- postProcess(AB_landClassRaster,
                               destinationPath = getwd(),
                               #use the function raster
                               fun = "terra::rast",
                               targetCRS = crs(AB_rasterToMatch),
                               #use the specified rasterToMatch to reproject to
                               rasterToMatch = AB_rasterToMatch,
                               useTerra = TRUE,
                               #studyArea = sim$studyArea,
                               useCache = getOption("reproducible.useCache", TRUE),
                               overwrite = TRUE,
                               verbose = TRUE)
    
    #landClassRaster[landClassRaster == 0] <- NA
    
    names(AB_landClassRaster) <- c("AB_landClassRaster")
    AB_landClassRaster <- terra::mask(AB_landClassRaster, AB_forClassRaster, inverse = TRUE)
    # landClassRaster <- overlay(x = landClassRaster,
    #                         y = forClassRaster,
    #                         fun = function(x, y) {
    #                           x[!is.na(y[])] <- NA
    #                           return(x)
    #                         })
    # 
    # clearPlot()
    # Plot(landClassRaster, na.color= "grey")
    #plot(AB_landClassRaster, colNA = "grey")
   
     #get age raster
    print("get ageRaster from Drive")
    AB_ageRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/studyAreaAB/ageRas_ABNew_0722.tif"))
    AB_ageRaster <- postProcess(AB_ageRaster,
                                destinationPath = getwd(),
                                #use the function raster
                                useTerra = TRUE,
                                fun = "terra::rast",
                                #targetCRS = crs(rasterToMatch),
                                #use the specified rasterToMatch to reproject to
                                rasterToMatch = AB_rasterToMatch,
                                #studyArea = studyArea,
                                useCache = getOption("reproducible.useCache", TRUE),
                                overwrite = TRUE,
                                verbose = TRUE)
    
    names(AB_ageRaster) <- c("AB_ageRaster")
    #plot(AB_ageRaster, colNA = "grey")

#make landscape raster
  print("make landscapeRaster")
  AB_landscapeRaster <- terra::cover(x = AB_forClassRaster, y = AB_landClassRaster)
  
  names(AB_landscapeRaster) <- c("AB_landscapeRaster")
  
  # clearPlot()
  # Plot(landscapeRaster, na.color= "grey")
# plot(AB_landscapeRaster, colNA = "turquoise")
  #create a raster that gives if an area is forest or not 
  #(0 for non-forest, 1 for forest)
  #This will allow me to have a value in the birdDataset 
  #that says if a cell was forested or not
  print("make FNFRaster")
  #make forest 1
  uniqueValsFR <- terra::unique(AB_forClassRaster,incomparables=FALSE)
  newValsFR <-  as.factor(rep("1", length(uniqueValsFR$AB_forClassRaster))) #make vector that repeats 1 as amy times as there are unique values
  newValsFR <- cbind(uniqueValsFR$AB_forClassRaster, newValsFR)
  newValsFR <- na.omit(newValsFR)
  reclassMatrixFR <- matrix(newValsFR,
                            ncol=2, byrow = FALSE)
  rasterFR <- terra::classify(AB_forClassRaster,
                         reclassMatrixFR)
  #make nonFor 0
  #valsNF <- unique(sim$rasterToMatch) #get vector of all the unique values in the forClassRaster
  uniqueValsNF <- terra::unique(AB_rasterToMatch, incomparables=FALSE)
  newValsNF <-  rep(0, length(uniqueValsNF$AB_rasterToMatch)) #make vector that repeats 0 as amy times as there are unique values
  newValsNF <- cbind(uniqueValsNF$AB_rasterToMatch, newValsNF)
  newValsNF <- na.omit(newValsNF)
  reclassMatrixNF <- matrix(newValsNF,
                            ncol=2, byrow = FALSE)
  rasterNF <- terra::classify(AB_rasterToMatch,
                         reclassMatrixNF)
  
  AB_FNFRaster <- terra::cover(x = rasterFR, y = rasterNF)
  
  names(AB_FNFRaster) <- c("AB_FNFRaster")
  #plot(AB_FNFRaster, colNA = "grey")

  
  
  
  
  #GET BC LANDSCAPE RASTERS
  
   #get rasterToMatch
    print("get rasterTomatch from local drive")
    BC_rasterToMatch <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/LCCProducts/LCC05/LCC2005_V1_4a.tif"))
   
    
    #get StudyArea shapefile
    print("get studyArea shapefile from local drive")
    BC_studyArea <- terra::vect(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/BCR6_BC.shp"))
    
    #postProcess studyArea
    BC_studyArea <- reproducible::postProcess(BC_studyArea,
                                               destinationPath = getwd(),
                                               filename2 = "BC_studyArea", 
                                               useTerra = TRUE,
                                               fun = "terra::vect", #use the function vect
                                               targetCRS = crs(BC_rasterToMatch), #make crs same as rasterToMatch
                                               overwrite = TRUE,
                                               verbose = TRUE)
    
    #crop and mask rasterToMatch
    BC_rasterToMatch <- terra::mask(terra::crop(BC_rasterToMatch, BC_studyArea), BC_studyArea) 
    names(BC_rasterToMatch) <- "BC_rasterToMatch"
    # clearPlot()
    # Plot(sim$rasterToMatch)
    #plot(BC_rasterToMatch, colNA = "grey")
    
    # get forest class raster
    print("get forClassRaster from Drive")
    BC_forClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/vegTypesRas_BC_0722.tif"))
    BC_forClassRaster <- postProcess(BC_forClassRaster,
                                      destinationPath = getwd(),
                                     #use the function raster
                                     targetCRS = crs(BC_rasterToMatch),
                                     fun = "terra::rast",
                                     useTerra = TRUE,
                                     #use the specified rasterToMatch to reproject to
                                     rasterToMatch = BC_rasterToMatch,
                                     #studyArea = studyArea,
                                     useCache = getOption("reproducible.useCache", TRUE),
                                     overwrite = TRUE,
                                     verbose = TRUE)
    
    names(BC_forClassRaster) <- c("BC_forClassRaster")
    
    BC_forClassRaster[BC_forClassRaster == 0] <- NA
    
     # clearPlot()
    # Plot(forClassRaster, na.color= "grey")
    #plot(BC_forClassRaster, colNA = "grey")
    #get non forest raster
    print("get landClassRaster from Drive")
    BC_landClassRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/landClassRaster_BC_202305.tif"))
    BC_landClassRaster <- postProcess(BC_landClassRaster,
                               destinationPath = getwd(),
                               #use the function raster
                               fun = "terra::rast",
                               targetCRS = crs(BC_rasterToMatch),
                               #use the specified rasterToMatch to reproject to
                               rasterToMatch = BC_rasterToMatch,
                               useTerra = TRUE,
                               #studyArea = sim$studyArea,
                               useCache = getOption("reproducible.useCache", TRUE),
                               overwrite = TRUE,
                               verbose = TRUE)
    
    #landClassRaster[landClassRaster == 0] <- NA
    
    names(BC_landClassRaster) <- c("BC_landClassRaster")
    BC_landClassRaster <- terra::mask(BC_landClassRaster, BC_forClassRaster, inverse = TRUE)
    # landClassRaster <- overlay(x = landClassRaster,
    #                         y = forClassRaster,
    #                         fun = function(x, y) {
    #                           x[!is.na(y[])] <- NA
    #                           return(x)
    #                         })
    # 
    # clearPlot()
    # Plot(landClassRaster, na.color= "grey")
    #plot(BC_landClassRaster, colNA = "grey")
   
     #get age raster
    print("get ageRaster from Drive")
    BC_ageRaster <- terra::rast(file.path("C:/Users/RALAS6/Documents/Repositories/Data/BCR6-BC/ageRas_BC_0722.tif"))
    BC_ageRaster <- postProcess(BC_ageRaster,
                                destinationPath = getwd(),
                                #use the function raster
                                useTerra = TRUE,
                                fun = "terra::rast",
                                #targetCRS = crs(rasterToMatch),
                                #use the specified rasterToMatch to reproject to
                                rasterToMatch = BC_rasterToMatch,
                                #studyArea = studyArea,
                                useCache = getOption("reproducible.useCache", TRUE),
                                overwrite = TRUE,
                                verbose = TRUE)
    
    names(BC_ageRaster) <- c("BC_ageRaster")
    #plot(BC_ageRaster, colNA = "grey")

#make landscape raster
  print("make landscapeRaster")
  BC_landscapeRaster <- terra::cover(x = BC_forClassRaster, y = BC_landClassRaster)
  
  names(BC_landscapeRaster) <- c("BC_landscapeRaster")
  
  # clearPlot()
  # Plot(landscapeRaster, na.color= "grey")
 #plot(BC_landscapeRaster, colNA = "turquoise")
  #create a raster that gives if an area is forest or not 
  #(0 for non-forest, 1 for forest)
  #This will allow me to have a value in the birdDataset 
  #that says if a cell was forested or not
  print("make FNFRaster")
  #make forest 1
  uniqueValsFR <- terra::unique(BC_forClassRaster,incomparables=FALSE)
  newValsFR <-  as.factor(rep("1", length(uniqueValsFR$BC_forClassRaster))) #make vector that repeats 1 as amy times as there are unique values
  newValsFR <- cbind(uniqueValsFR$BC_forClassRaster, newValsFR)
  newValsFR <- na.omit(newValsFR)
  reclassMatrixFR <- matrix(newValsFR,
                            ncol=2, byrow = FALSE)
  rasterFR <- terra::classify(BC_forClassRaster,
                         reclassMatrixFR)
  #make nonFor 0
  #valsNF <- unique(sim$rasterToMatch) #get vector of all the unique values in the forClassRaster
  uniqueValsNF <- terra::unique(BC_rasterToMatch, incomparables=FALSE)
  newValsNF <-  rep(0, length(uniqueValsNF$BC_rasterToMatch)) #make vector that repeats 0 as amy times as there are unique values
  newValsNF <- cbind(uniqueValsNF$BC_rasterToMatch, newValsNF)
  newValsNF <- na.omit(newValsNF)
  reclassMatrixNF <- matrix(newValsNF,
                            ncol=2, byrow = FALSE)
  rasterNF <- terra::classify(BC_rasterToMatch,
                         reclassMatrixNF)
  
  BC_FNFRaster <- terra::cover(x = rasterFR, y = rasterNF)
  
  names(BC_FNFRaster) <- c("BC_FNFRaster")
  #plot(BC_FNFRaster, colNA = "grey")
  
  


#forClassRaster
#plot(forClassRaster, colNA="grey70")
# customizing the legend
plot(BC_forClassRaster, main = 'British Columbia forest class raster', legend = FALSE, col = cbPalette, colNA="white", axes=FALSE, box=FALSE)
legend("bottom", legend = c( "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce"), fill = cbPalette)

plot(AB_forClassRaster, main = 'Alberta forest class raster', legend = FALSE, col = cbPalette, colNA="white", axes=FALSE, box=FALSE)
legend("bottomright", legend = c( "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce"), fill = cbPalette)

#landClassRaster
#plot(landClassRaster,colNA="grey70")
# customizing the legend
nf.legend <- legend("right", legend = c("Unmanaged Forest", "Water/Ice", "Wetland", "Anthro/Exposed Land", "Grass/Cropland", "Shrub", "Bryoid"), fill = cbPalette)
plot(BC_landClassRaster, main = 'British Columbia land class raster', legend = FALSE, colNA="white", col = cbPalette, axes=FALSE, box=FALSE)
plot(AB_landClassRaster, main = 'Alberta land class raster', legend = nf.legend, col = cbPalette, colNA="white", axes=FALSE, box=FALSE)



#ageRaster
min_ = min(min(terra::unique(AB_ageRaster)), min(terra::unique(BC_ageRaster)))
max_ = max(max(terra::unique(AB_ageRaster)), max(terra::unique(BC_ageRaster)))
r.range = c(min_, max_)

plot(BC_ageRaster, main = 'British Columbia age raster', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box=FALSE) 
plot(AB_ageRaster, main = 'Alberta age raster', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box = FALSE)  
  

# AB_rasters <- c(BC_landClassRaster, BC_forClassRaster, BC_ageRaster)
# 
# plot(AB_rasters, col = cbPalette, colNA="white", axes=FALSE, box = FALSE)
# op <- par(mfrow = c(2,1),
#   oma = c(2,4,0,0) + 0.1,
#   mar = c(5,0,1,1) + 0.1)
# plot( xras, col=rev( rainbow( 99, start=0,end=1 ) ), breaks=seq(min_,max_,length.out=100), legend = FALSE,  axes = FALSE )
# plot( yras, col=rev( rainbow( 99, start=0,end=1 ) ), breaks=seq(min_,max_,length.out=100), legend = FALSE, axes = FALSE )
# 
# plot(xras, col=rev( rainbow( 99, start=0,end=1 ) ), horizontal=TRUE, `breaks=seq(min_,max_,length.out=100), legend.only=TRUE, legend.shrink = 1, legend.width = 3, axis.args = list(at=seq(r.range[1], r.range[2], abs(r.range[1]-r.range[2])/4), labels = round(seq(r.range[1], r.range[2], abs(r.range[1]-r.range[2])/4),2),cex.axis=1), legend.args= list(text='Precipitation (XXX)', side=1, font=3, line = 2, cex=1))
# 
# levelplot(stack(AB_ageRaster, BC_ageRaster), col.regions = rev(rainbow(99, start=0, end=1)), colorkey = list(space = "bottom"))


```




## PLOT MAIN 1D PREDICTION RESULTS

### make plot of 1D mean density by cover class 


```{r meanDensity1D_2datasets, echo=FALSE}
dev.new()
#make plot of 1D mean density by cover class
birdPreds1D <- lapply(birdList, FUN= function(bird){
 
   birdPreds1D <- as.data.frame(read_csv(paste("Results/PS results AB 20 yr age classes boot ras/",bird, " _birdPreds1D.csv", sep = "")))
  birdPreds1D$landForClass <- as.character(birdPreds1D$landForClass)
  birdPreds1D$FoLRaster <- as.character(birdPreds1D$FoLRaster)
  return(birdPreds1D)
})
names(birdPreds1D) <- birdList

#make dataframe of birds you want to include
birdPreds1DSingleFrame_1 <- rbind(birdPreds1D$BBWA, birdPreds1D$BRCR, birdPreds1D$CAWA, birdPreds1D$DEJU, birdPreds1D$OVEN)
dataset <- rep("AB", each = nrow(birdPreds1DSingleFrame_1))
birdPreds1DSingleFrame_1 <- cbind(birdPreds1DSingleFrame_1, dataset)

#make plot of 1D mean density by cover class
birdPreds1D <- lapply(birdList, FUN= function(bird){
  birdPreds1D <- as.data.frame(read_csv(paste("Results/PS results BC 20 yr age classes boot ras/",bird, " _birdPreds1D.csv", sep = "")))
  birdPreds1D$landForClass <- as.character(birdPreds1D$landForClass)
  birdPreds1D$FoLRaster <- as.character(birdPreds1D$FoLRaster)
  return(birdPreds1D)
})
names(birdPreds1D) <- birdList

#make dataframe of birds you want to include
birdPreds1DSingleFrame_2 <- rbind(birdPreds1D$BBWA, birdPreds1D$BRCR, birdPreds1D$CAWA, birdPreds1D$DEJU, birdPreds1D$OVEN)
dataset <- rep("BC", each = nrow(birdPreds1DSingleFrame_2))
birdPreds1DSingleFrame_2 <- cbind(birdPreds1DSingleFrame_2, dataset)

birdPreds1DSingleFrame <- rbind(birdPreds1DSingleFrame_1, birdPreds1DSingleFrame_2)

#define labels
sp.labs <- c("Bay-breasted \nWarbler", "Brown \nCreeper", "Canada \nWarbler", "Dark-eyed \nJunco", "Ovenbird")
names(sp.labs) <- c("BBWA", "BRCR", "CAWA", "DEJU", "OVEN")

ras.labs <- c("Land cover class raster", "Forest class raster")
names(ras.labs) <- c("0", "1")

#Make plot

plotMeanBirdDensity <- ggplot(data = birdPreds1DSingleFrame,
                              aes(x = landForClass,
                                  y = meanBirdDensity,
                                  fill = factor(dataset, levels=c("BC", "AB")))) +
  facet_grid(birdSp  ~ FoLRaster, scales= 'free',
             labeller = labeller(birdSp = sp.labs,FoLRaster = ras.labs)
  ) +
  geom_bar(stat = "identity",
           position = "dodge",
           width = 0.7) +
  # geom_errorbar(aes(ymin = meanBirdDensity - seBirdDensity, ymax = meanBirdDensity + seBirdDensity),
  #               width = .20) +
  theme_classic() +
  ggtitle("Predicted bird density (males/ha) by class") +
  #xlab("Cover Class") +
  ylab("Mean density (males/ha)") +
  labs(fill = "Study area") +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_discrete(labels=c("0_0" = "Unclassified forest", "0_1" = "Water/Ice", "0_2" = "Wetland", "0_3" = "Anthro/Exposed", "0_4" = "Grass/Crop" , "0_5" = "Shrub", "0_6" = "Bryoid", "1_1" = "Black spruce", "1_2" = "Black spruce wet", "1_3" = "Conifer Mix", "1_4" = "Deciduous", "1_5" = "Mixed", "1_6" = "Pine", "1_7" = "White spruce")) +
  scale_fill_manual(values=c("#009E73","#56B4E9"),
                    labels = c( "British Columbia", "Alberta")) +
  theme(title = element_text(size = 14),
        strip.text = element_text(
          size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.position="bottom",
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_blank())

plotMeanBirdDensity
#jpeg(paste(plotsLocation, "plotMeanBirdDensity1D.jpg", sep = ""))

```


### make plot of 1D median density by cover class 


```{r medianDensity1D_2datasets, echo=FALSE}

#make plot of 1D mean density by cover class
birdPreds1D <- lapply(birdList, FUN= function(bird){
  birdPreds1D <- as.data.frame(read_csv(paste("Results/PS results AB 20 yr age classes boot ras/",bird, " _birdPreds1D.csv", sep = "")))
  birdPreds1D$landForClass <- as.character(birdPreds1D$landForClass)
  birdPreds1D$FoLRaster <- as.character(birdPreds1D$FoLRaster)
  return(birdPreds1D)
})
names(birdPreds1D) <- birdList

#make dataframe of birds you want to include
birdPreds1DSingleFrame_1 <- rbind(birdPreds1D$BBWA, birdPreds1D$BRCR, birdPreds1D$CAWA, birdPreds1D$DEJU, birdPreds1D$OVEN)
dataset <- rep("AB", each = nrow(birdPreds1DSingleFrame_1))
birdPreds1DSingleFrame_1 <- cbind(birdPreds1DSingleFrame_1, dataset)

#make plot of 1D mean density by cover class
birdPreds1D <- lapply(birdList, FUN= function(bird){
  birdPreds1D <- as.data.frame(read_csv(paste("Results/PS results BC 20 yr age classes boot ras/",bird, " _birdPreds1D.csv", sep = "")))
  birdPreds1D$landForClass <- as.character(birdPreds1D$landForClass)
  birdPreds1D$FoLRaster <- as.character(birdPreds1D$FoLRaster)
  return(birdPreds1D)
})
names(birdPreds1D) <- birdList

#make dataframe of birds you want to include
birdPreds1DSingleFrame_2 <- rbind(birdPreds1D$BBWA, birdPreds1D$BRCR, birdPreds1D$CAWA, birdPreds1D$DEJU, birdPreds1D$OVEN)
dataset <- rep("BC", each = nrow(birdPreds1DSingleFrame_2))
birdPreds1DSingleFrame_2 <- cbind(birdPreds1DSingleFrame_2, dataset)

birdPreds1DSingleFrame <- rbind(birdPreds1DSingleFrame_1, birdPreds1DSingleFrame_2)

#define labels
sp.labs <- c("Bay-breasted Warbler", "Brown Creeper", "Canada Warbler",  "Dark-eyed Junco","Ovenbird")
names(sp.labs) <- c("BBWA", "BRCR", "CAWA", "DEJU", "OVEN")

#Make plot

plotMedianBirdDensity <- ggplot(data = birdPreds1DSingleFrame,
                              aes(x = landForClass,
                                  y = medianBirdDensity,
                                  fill = factor(dataset, levels=c("BC", "AB")))) +
  facet_grid(birdSp  ~ FoLRaster, scales= 'free',
             labeller = labeller(birdSp = sp.labs,FoLRaster = ras.labs)
  ) +
  geom_bar(stat = "identity",
           position = "dodge",
           width = 0.7) +
  # geom_errorbar(aes(ymin = meanBirdDensity - seBirdDensity, ymax = meanBirdDensity + seBirdDensity),
  #               width = .20) +
  theme_classic() +
  ggtitle("Median bird density (males/ha) by cover class, \nfor two study areas") +
  #xlab("Cover Class") +
  ylab("Median density (males/ha)") +
  labs(fill = "Study area location") +
  scale_y_continuous(breaks= pretty_breaks()) +
  scale_x_discrete(labels=c("0_0" = "Unclassified forest", "0_1" = "Water/Ice", "0_2" = "Wetland", "0_3" = "Anthro/Exposed", "0_4" = "Grass/Crop" , "0_5" = "Shrub", "0_6" = "Bryoid", "1_1" = "Black spruce", "1_2" = "Black spruce wet", "1_3" = "Conifer Mix", "1_4" = "Deciduous", "1_5" = "Mixed", "1_6" = "Pine", "1_7" = "White spruce")) +
  scale_fill_manual(values=c("#009E73","#56B4E9"),
                    labels = c( "British Columbia", "Alberta")) +
  theme(title = element_text(size = 14),
        strip.text = element_text(
          size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.position="bottom",
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_blank())

plotMedianBirdDensity
#jpeg(paste(plotsLocation, "plotMeanBirdDensity1D.jpg", sep = ""))

```



## PLOT MAIN 2D PREDICTION RESULTS

### plot bird matricies

```{r twoDatasetsPlotBirdMatricies, echo=FALSE}

#make plot of 2D bird density predictions

#get matricies
birdMatricies <- lapply(birdList, FUN= function(bird){
  birdMatrix <- as.data.frame(read_csv(paste("Results/PS results AB 20 yr age classes boot ras/",bird, " _matrix.csv", sep = "")))
  return(birdMatrix)
})
names(birdMatricies) <- birdList


AB20_matrixAsTables <- lapply(X = birdList, FUN = function(bird){
 
  matrix <-  eval(parse(text=paste("birdMatricies$", bird, sep = "")))
  matrix <- matrix[2:ncol(matrix)]
  matrix <- data.matrix(matrix)
  tab <- melt(matrix)
  colnames(tab) <- c( "forClass","ageClass", "birdDensityPred")
  birdSp <- rep(paste(bird), nrow(tab))
  tab <- cbind(tab, birdSp = birdSp)
  tab$ageClass <- as.character(tab$ageClass)
  tab$forClass <- as.character(tab$forClass)
  tab$birdSp <- as.character(tab$birdSp)
  tab$birdDensityPred <- as.numeric(tab$birdDensityPred)
  print(tab)
  
  return(tab)
})

names(AB20_matrixAsTables) <- birdList


#make plot of 2D bird density predictions

#get matricies
birdMatricies <- lapply(birdList, FUN= function(bird){
  birdMatrix <- as.data.frame(read_csv(paste("Results/PS results BC 20 yr age classes boot ras/",bird, " _matrix.csv", sep = "")))
  return(birdMatrix)
})
names(birdMatricies) <- birdList

BC20_matrixAsTables <- lapply(X = birdList, FUN = function(bird){
 
  matrix <-  eval(parse(text=paste("birdMatricies$", bird, sep = "")))
  matrix <- matrix[2:ncol(matrix)]
  matrix <- data.matrix(matrix)
  tab <- melt(matrix)
  colnames(tab) <- c( "forClass","ageClass", "birdDensityPred")
  birdSp <- rep(paste(bird), nrow(tab))
  tab <- cbind(tab, birdSp = birdSp)
  tab$ageClass <- as.character(tab$ageClass)
  tab$forClass <- as.character(tab$forClass)
  tab$birdSp <- as.character(tab$birdSp)
  tab$birdDensityPred <- as.numeric(tab$birdDensityPred)
  print(tab)
  
  return(tab)
})

names(BC20_matrixAsTables) <- birdList



# make a plot for each sp

# New facet label names for species, forest classes, and study areas
sp.labs <- c("Bay-breasted \nWarbler", "Brown \nCreeper", "Canada \nWarbler", "Dark-eyed \nJunco", "Ovenbird \n")
names(sp.labs) <- c("BBWA", "BRCR", "CAWA", "DEJU", "OVEN")

class.labs <- c("Black \nSpruce", "Black \nSpruce Wet", "Conifer \nMix", "Deciduous", "Mixed", "Pine", "White \nSpruce")
names(class.labs) <- c("1", "2", "3", "4", "5", "6", "7")

sa.labs <- c("British Columbia", "Alberta")
names(sa.labs) <- c("BC", "AB")

#do not see facet labels for study area
strips <- strip_nested(
  text_y = list(element_blank(), element_text()),
  background_y = list(element_blank(), element_rect()), 
  by_layer_y = TRUE,
  bleed = TRUE
)

plotMeanBirdDensity2D <- lapply(X = birdList, FUN = function(bird){
 
  print(bird)
  
  BC20_matrixAsTables <- eval(parse(text=paste("BC20_matrixAsTables$", bird, sep = "")))
  AB20_matrixAsTables <- eval(parse(text=paste("AB20_matrixAsTables$", bird, sep = "")))
  
  
  #make dataframe of birds you want to include
dataset <- rep("BC", each = nrow(BC20_matrixAsTables))
BC20_matrixAsTables <- cbind(BC20_matrixAsTables, dataset)
dataset <- rep("AB", each = nrow(AB20_matrixAsTables))
AB20_matrixAsTables <- cbind(AB20_matrixAsTables, dataset)

tab <- rbind(BC20_matrixAsTables,  AB20_matrixAsTables)
  
# make ggplot
plotMeanBirdDensity2D <- ggplot(data = tab,
                                aes(fill= dataset, y= birdDensityPred, x= ageClass)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_nested( factor(dataset, levels = c("BC", "AB")) + birdSp ~ forClass,
              labeller = labeller(forClass = class.labs, birdSp = sp.labs),
              strip = strips,
              nest_line = element_line(linetype = 2)) +
  theme_classic() +
  ggtitle("Predicted bird density (males/ha) by forest class and age") +
  xlab("Forest age (yrs)")  +
  scale_x_discrete(labels=c("1" = "0-20","2" = "","3" = "41-60","4"= "","5"= "81-100","6"= "","7"= "", "8" = "141-160","9" = "", "10" = "181+"),
                   limits=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")) +
 scale_fill_manual(values=c("#009E73","#56B4E9"), labels=c("BC" = "British Columbia", "AB" = "Alberta" ),limits = c("BC", "AB")) +
   ylab("Density (males/ha)") +
  scale_y_continuous(breaks= pretty_breaks()) +
  theme(title = element_text(size = 16),
        strip.text.x = element_text(
          size = 14),
        strip.text.y = element_text(
          size = 14),
        legend.position="bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 14),
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.5),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12, angle = 35, hjust = 1),
        axis.title.y = element_text(size = 14),
        axis.line.y = element_line(linewidth = 1),
        axis.title.x = element_text(size = 14))

  return(plotMeanBirdDensity2D)
})

names(plotMeanBirdDensity2D) <- birdList


allMatrixPlot <- ggarrange(plotMeanBirdDensity2D$BBWA +
                             theme(axis.text.x = element_blank(),
                                   #axis.ticks.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   axis.title.y = element_blank(),
                                   legend.position= "none")
                           ,
                           plotMeanBirdDensity2D$BRCR +
                             theme(axis.text.x = element_blank(),
                                   #axis.ticks.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   axis.title.y = element_blank(),
                                   strip.text.x = element_blank(),
                                   legend.position= "none",
                                   title = element_blank()
                                   )
                           ,
                           plotMeanBirdDensity2D$CAWA +
                             theme(axis.text.x = element_blank(),
                                   #axis.ticks.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   strip.text.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotMeanBirdDensity2D$DEJU +
                             theme(axis.text.x = element_blank(),
                                   #axis.ticks.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   axis.title.y = element_blank(),
                                   strip.text.x = element_blank(),
                                   title = element_blank(),
                                   legend.position = "none")
                           ,
                          plotMeanBirdDensity2D$OVEN+
                             theme(axis.title.y = element_blank(),
                                   title = element_blank(),
                                   strip.text.x = element_blank()), 
                         
                           ncol = 1
                            )
dev.new()
allMatrixPlot

```



## DENSITY PLOTS

### (two datasets) Examine the 1D data using a density plot 

Creates a density plot for a single species, selected from the birdDatasets, for each class. 

```{r densityPlot1D_2datasets, echo=FALSE}

#get birdDatasets
birdDatasets_1 <- lapply(birdList, FUN= function(bird){
  birdDatasets <- as.data.frame(read_csv(paste("Results/PS results AB 20 yr age classes boot ras/",bird, " _fullDataset.csv", sep = "")))
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$FoLRaster <- as.character(birdDatasets$FoLRaster)
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$birdSp <- as.character(birdDatasets$birdSp)
  birdDatasets$age <- as.integer(birdDatasets$age)
  return(birdDatasets)
})
names(birdDatasets_1) <- birdList

#get birdDatasets
birdDatasets_2 <- lapply(birdList, FUN= function(bird){
  birdDatasets <- as.data.frame(read_csv(paste("Results/PS results BC 20 yr age classes boot ras/",bird, " _fullDataset.csv", sep = "")))
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$FoLRaster <- as.character(birdDatasets$FoLRaster)
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$birdSp <- as.character(birdDatasets$birdSp)
  birdDatasets$age <- as.integer(birdDatasets$age)
  return(birdDatasets)
})
names(birdDatasets_2) <- birdList

birdData_1 <-birdDatasets_1$OVEN
dataset <- rep("AB", each = nrow(birdData_1))
birdData_1 <- cbind(birdData_1, dataset)

birdData_2 <- birdDatasets_2$OVEN
dataset <- rep("BC", each = nrow(birdData_2))
birdData_2 <- cbind(birdData_2, dataset)

birdData <- rbind(birdData_1, birdData_2)
birdData <- as.data.table(birdData)

class.labs <- c("Forested", "Water/Ice", "Wetland", "Anthro/Exposed", "Grass/Crop", "Shrub", "Bryoid", "Black Spruce", "Black Spruce Wet", "Conifer Mix", "Deciduous", "Mixed", "Pine", "White Spruce")
names(class.labs) <- c("0_0", "0_1", "0_2", "0_3", "0_4", "0_5", "0_6", "1_1", "1_2", "1_3", "1_4", "1_5", "1_6", "1_7")

nfBirdData <- birdData[FoLRaster == "0"]

  nfDensityPlot <-  ggplot(nfBirdData, aes(x=birdDensity, colour= factor(dataset, levels=c("BC", "AB")))) +
  geom_density(linewidth = 1.5) +
    facet_nested_wrap( ~  landForClass,
                       labeller = labeller(landForClass = class.labs),
                       ncol = 6) +
    theme_classic() +
  ggtitle("Density plots of predicted ovenbird density by cover class") +
    xlab("Predicted bird density (males/ha)")  +
    scale_x_continuous(breaks= pretty_breaks()) +
    ylab("Prevalence of value") +
    scale_y_continuous( trans='sqrt', breaks= pretty_breaks()) +
   scale_colour_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          strip.text = element_text(
        size = 14),
           strip.background = element_rect(
          color="white", fill="white", linewidth =1.5),
          legend.title = element_blank(),
          legend.position= "none",
          axis.text.x =  element_text(size = 12, angle = 45, hjust = 1),
          axis.text.y =  element_text(size = 12),
          axis.title = element_text(size = 14),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"),
        axis.line.y = element_line(linewidth = 1))

     nfDensityPlot
   
  forBirdData <- birdData[FoLRaster == "1"]

  forDensityPlot <-  ggplot(forBirdData, aes(x=birdDensity, colour= factor(dataset, levels=c("BC", "AB")))) +
  geom_density(linewidth = 1.5) +
    facet_nested_wrap( ~  landForClass,
                       labeller = labeller(landForClass = class.labs),
                       ncol = 7) +
    theme_classic() +
  ggtitle("Density plots of predicted ovenbird density by cover class") +
    xlab("Predicted bird density (males/ha)")  +
    scale_x_continuous(breaks= pretty_breaks()) +
    ylab("Prevalence of value") +
    scale_y_continuous( trans='sqrt', breaks= pretty_breaks()) +
   scale_colour_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          strip.text = element_text(
        size = 14),
           strip.background = element_rect(
          color="white", fill="white", linewidth =1.5),
          legend.title = element_blank(),
          legend.position= "bottom",
          axis.text.x =  element_text(size = 12, angle = 45, hjust = 1),
          axis.text.y =  element_text(size = 12),
          axis.title = element_text(size = 14),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"),
        axis.line.y = element_line(linewidth = 1))

   forDensityPlot
   
   
   allMatrixPlot <- ggarrange(nfDensityPlot +
                             theme(axis.title.x = element_blank(),
                                   title = element_blank()
                                   )
                           ,
                           forDensityPlot +
                             theme(title = element_blank())
                           ,
                           ncol = 1,
                           labels = c("A", "B"),
                           label.args = list(gp=gpar(font=4, fontsize = 16), x=unit(1,"line"), hjust=1)
                            ) 
#jpeg("densityPlot_OVEN.jpg")

```


### (two datasets) plot density plots for selected 2D bins 

```{r plot2DDensity_2datasets, echo=FALSE}
dev.new()
#get birdDatasets for first set of results
birdDatasets <- lapply(birdList, FUN= function(bird){
  birdDatasets <- as.data.frame(read_csv(paste("Results/PS results AB 20 yr age classes boot ras/",bird, " _fullDataset.csv", sep = "")))
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$FoLRaster <- as.character(birdDatasets$FoLRaster)
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$birdSp <- as.character(birdDatasets$birdSp)
  birdDatasets$age <- as.integer(birdDatasets$age)
  return(birdDatasets)
})
names(birdDatasets) <- birdList

#get age class definitions table
ageClassDefs <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/ageClassDefs"))

#select bird Sp
forestedDT <- as.data.table(birdDatasets$OVEN)

#separate out data table rows that are forested from the raw birdDataset 
forestedDT <- forestedDT[forestedDT$FoLRaster == 1]
forestedDT <- droplevels(forestedDT)

#get rid of any rows with NA for age
forestedDT <- na.omit(forestedDT, cols = "age")

#get age classes for each row using the ageClassDefs table
ageClass <- forestedDT[, age]
ageClass <- as.data.table(ageClass)
ageClass[] <- lapply(ageClass, function(x) ageClassDefs$ageClasses[match(x, ageClassDefs$allAges)])

#add the ageClass to the forestedDT 
birdDataNew <- cbind(forestedDT, ageClass)
birdDataNew$ageClass <- as.character(birdDataNew$ageClass)

#create new column, landAgeClass, giving the uniqueLandClass and ageClass combined
birdDataNew <- as.data.table(unite(birdDataNew, landAgeClass, c(landForClass, ageClass), sep= ".", remove=FALSE))
dataset <- rep("AB", each = nrow(birdDataNew))
birdDataNew_1 <- cbind(birdDataNew, dataset)


#get birdDatasets for second set of results
birdDatasets <- lapply(birdList, FUN= function(bird){
  birdDatasets <- as.data.frame(read_csv(paste("Results/PS results BC 20 yr age classes boot ras/",bird, " _fullDataset.csv", sep = "")))
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$FoLRaster <- as.character(birdDatasets$FoLRaster)
  birdDatasets$landForClass <- as.character(birdDatasets$landForClass)
  birdDatasets$birdSp <- as.character(birdDatasets$birdSp)
  birdDatasets$age <- as.integer(birdDatasets$age)
  return(birdDatasets)
})
names(birdDatasets) <- birdList

#get age class definitions table
ageClassDefs <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/ageClassDefs"))

#select bird Sp
forestedDT <- as.data.table(birdDatasets$OVEN)

#separate out data table rows that are forested from the raw birdDataset 
forestedDT <- forestedDT[forestedDT$FoLRaster == 1]
forestedDT <- droplevels(forestedDT)

#get rid of any rows with NA for age
forestedDT <- na.omit(forestedDT, cols = "age")

#get age classes for each row using the ageClassDefs table
ageClass <- forestedDT[, age]
ageClass <- as.data.table(ageClass)
ageClass[] <- lapply(ageClass, function(x) ageClassDefs$ageClasses[match(x, ageClassDefs$allAges)])

#add the ageClass to the forestedDT 
birdDataNew <- cbind(forestedDT, ageClass)
birdDataNew$ageClass <- as.character(birdDataNew$ageClass)

#create new column, landAgeClass, giving the uniqueLandClass and ageClass combined
birdDataNew <- as.data.table(unite(birdDataNew, landAgeClass, c(landForClass, ageClass), sep= ".", remove=FALSE))
dataset <- rep("BC", each = nrow(birdDataNew))
birdDataNew_2 <- cbind(birdDataNew, dataset)


# birdDataNew <- rbind(birdDataNew_2, birdDataNew_1)

#make density plot of single land class

OVEN_1_4_AB <- birdDataNew_1[landForClass == "1_4"]
OVEN_1_4_AB

OVEN_1_4_BC <- birdDataNew_2[landForClass == "1_4"]
OVEN_1_4_BC

# New facet label names for detase tNames
class.labs <- c( "British Columbia", "Alberta")
names(class.labs) <- c("BC","AB" )

densityPlot_OVEN_1_4_AB <-  ggplot(OVEN_1_4_AB, 
                                aes(x=birdDensity,
                                    colour=ageClass)) +
  geom_density(alpha=.25, ) +
  # #geom_density(color="darkblue", fill="white")
  # #facet_wrap( ~ factor(dataset, labels = c( "British Columbia", "Alberta"), levels = c("BC","AB" )), nrow = 2,
  #             scales = "free_y") +
  scale_colour_manual(name='Age (yrs)',labels=c("0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+"), values = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "black")) +
  # scale_fill_discrete(breaks=c("1", "2", "3", "4", "5", "6", "7", "8", "9"),
  #                     labels=c("0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+")) +
  theme_classic() +
  geom_density(linewidth = 1.5)+
  # scale_color_manual(values=c("#C7E9C0", "#A1D99B", "#74C476", "#41AB5D", "#238B45", "#005A32"))+
  ggtitle("Distribution of ovenbird density values \nin deciduous forest, by age") +
  xlab("Predicted bird density (males/ha)")  +
  scale_x_continuous(breaks= pretty_breaks()) +
  ylab("Density of value") +
  #scale_colour_manual(values = cbPalette) +
  scale_y_continuous(breaks= pretty_breaks()) +
  theme(title = element_text(size = 16),
        strip.text = element_text(
          size = 14),
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.5),
         legend.position= "none",
        legend.title = element_text("Age (yrs)"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm"),
        axis.line.y = element_line(linewidth = 1))


densityPlot_OVEN_1_4_BC <-  ggplot(OVEN_1_4_BC, 
                                aes(x=birdDensity,
                                    colour=ageClass)) +
  geom_density(alpha=.25, ) +
  # #geom_density(color="darkblue", fill="white")
  # #facet_wrap( ~ factor(dataset, labels = c( "British Columbia", "Alberta"), levels = c("BC","AB" )), nrow = 2,
  #             scales = "free_y") +
  scale_colour_manual(name='Age (yrs)',labels=c("0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+"), values = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "black")) +
  # scale_fill_discrete(breaks=c("1", "2", "3", "4", "5", "6", "7", "8", "9"),
  #                     labels=c("0-20", "21-40", "41-60", "61-80", "81-100", "101-120", "121-140", "141-160", "161+")) +
  theme_classic() +
  geom_density(linewidth = 1.5)+
  # scale_color_manual(values=c("#C7E9C0", "#A1D99B", "#74C476", "#41AB5D", "#238B45", "#005A32"))+
  ggtitle("Distribution of ovenbird density values \nin deciduous forest, by age") +
  xlab("Predicted bird density (males/ha)")  +
  scale_x_continuous(breaks= pretty_breaks()) +
  ylab("Density of value") +
  #scale_colour_manual(values = cbPalette) +
  scale_y_continuous(breaks= pretty_breaks()) +
  theme(title = element_text(size = 16),
        strip.text = element_text(
          size = 14),
        strip.background = element_rect(
          color="white", fill="white", linewidth =1.5),
        legend.title = element_text("Age (yrs)"),
        axis.text = element_text(size = 12),
        legend.position= "right",
        axis.title = element_text(size = 14),
        plot.margin = margin(0.5,0.5,0.5,0.5, "cm"),
        axis.line.y = element_line(linewidth = 1))

densityPlot_OVEN_1_4_AB
densityPlot_OVEN_1_4_BC

allMatrixPlot <- plot_grid(densityPlot_OVEN_1_4_BC +
                             theme(axis.title.x = element_blank(),
                                   legend.position="none",
                                   title = element_blank()
                                                                     )
                           ,
                           densityPlot_OVEN_1_4_AB +
                             theme(title = element_blank(),
                                   legend.position="none"
                                   )
                           ,
                           nrow = 2,
                           labels = c("A", "B")
                           # #legend.grob = get_legend(densityPlot_OVEN_1_4_BC),
                           # common.legend = TRUE,
                           # #legend = "bottom",
                            #label.args = list(gp=gpar(font=4, fontsize = 16), x=unit(1,"line"), hjust=1)
                            ) 

legend <- get_legend(
  # create some space to the left of the legend
  densityPlot_OVEN_1_4_BC + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom") 
)

allMatrixPlot <- plot_grid(allMatrixPlot, legend, ncol = 1, rel_heights = c(1, .1))

allMatrixPlot 
# #jpeg("2DdensityPlot_OVEN_1_3.4.jpg")
# ggsave("densityPlot_OVEN_1_3.4.jpg",
#        plot = densityPlot_OVEN_1_3.4,
#        device = "jpeg")





```



## PLOTS OF NORMALITY AND UNIMODALITY

### compare 1D and 2D prop unimodal and normal by class

```{r Unimodal and normal plot, echo=FALSE}

#get data tables needed
assumptionsByClass1D_1 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/assumptionsByClass1D.csv"))
studyArea <- rep("AB", each = nrow(assumptionsByClass1D_1))
ageClasses <- rep("20", each = nrow(assumptionsByClass1D_1))
assumptionsByClass1D_1 <- cbind(assumptionsByClass1D_1, studyArea, ageClasses)
names(assumptionsByClass1D_1)[names(assumptionsByClass1D_1) == 'landForClass'] <- 'landAgeClass'

assumptionsByClass1D_2 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/assumptionsByClass1D.csv"))
studyArea <- rep("BC", each = nrow(assumptionsByClass1D_2))
ageClasses <- rep("20", each = nrow(assumptionsByClass1D_2))
assumptionsByClass1D_2 <- cbind(assumptionsByClass1D_2, studyArea, ageClasses)
names(assumptionsByClass1D_2)[names(assumptionsByClass1D_2) == 'landForClass'] <- 'landAgeClass'

assumptionsByClass2D_1 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/assumptionsByClass2D.csv"))
studyArea <- rep("AB", each = nrow(assumptionsByClass2D_1))
ageClasses <- rep("10", each = nrow(assumptionsByClass2D_1))
assumptionsByClass2D_1 <- cbind(assumptionsByClass2D_1, studyArea, ageClasses)

assumptionsByClass2D_2 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/assumptionsByClass2D.csv"))
studyArea <- rep("AB", each = nrow(assumptionsByClass2D_2))
ageClasses <- rep("20", each = nrow(assumptionsByClass2D_2))
assumptionsByClass2D_2 <- cbind(assumptionsByClass2D_2, studyArea, ageClasses)

assumptionsByClass2D_3 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/assumptionsByClass2D.csv"))
studyArea <- rep("BC", each = nrow(assumptionsByClass2D_3))
ageClasses <- rep("10", each = nrow(assumptionsByClass2D_3))
assumptionsByClass2D_3 <- cbind(assumptionsByClass2D_3, studyArea, ageClasses)

assumptionsByClass2D_4 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/assumptionsByClass2D.csv"))
studyArea <- rep("BC", each = nrow(assumptionsByClass2D_4))
ageClasses <- rep("20", each = nrow(assumptionsByClass2D_4))
assumptionsByClass2D_4 <- cbind(assumptionsByClass2D_4, studyArea, ageClasses)

assumptionsByClass <- rbind(assumptionsByClass1D_1, assumptionsByClass1D_2, assumptionsByClass2D_1, assumptionsByClass2D_2, assumptionsByClass2D_3, assumptionsByClass2D_4)
assumptionsByClass <- unite(assumptionsByClass, dataset, c(binningType, ageClasses), remove=FALSE)

 #normality plot
   plotUnimodality <- ggplot(data = assumptionsByClass, 
                                aes(fill = factor(studyArea, levels=c("BC", "AB")), y= propBirdsUnimodal, x= dataset)) + 
    geom_boxplot() +
    geom_jitter(color="black", size=0.4, alpha=0.9) +
    ggtitle("Proportion of bird species per class \nwith a unimodal distribution (p < 0.05)") +
    xlab("Species")  +
     scale_x_discrete(labels=c("1DBins_20" = "1D", "2DBins_10" = "2D\n(10-yr)", "2DBins_20" = "2D\n(20-yr)"))  + 
    ylab("Proportion of species unimodal") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
  theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotUnimodality


# #normality plot
#    plotNormality <- ggplot(data = assumptionsByClass, 
#                                 aes(fill= dataset, y= propBirdsNormal, x= binningType)) + 
#     geom_boxplot() +
#     geom_jitter(color="black", size=0.4, alpha=0.9) +
#     ggtitle("Proportion of bird species Normal for 1D and 2D post-hoc binning by cover class") +
#     xlab("Species")  +
#     ylab("Proportion of classes normal (p < 0.05)") +
#     scale_y_continuous(breaks= pretty_breaks()) +
#     theme_classic() + 
#     scale_fill_manual(values=c("#56B4E9","#CC79A7", "#009E73", "#999999"), 
#                       labels = c("Alberta, 10 yr age classes", "Alberta, 20 yr age classes", "British Columbia, 10 yr age classes", "British Columbia, 20 yr age classes")) +
#     theme(title = element_text(size = 14),
#           legend.title = element_blank(),
#           legend.position= "bottom",
#           axis.text.x = element_text(size = 10, angle = 45, hjust = 1), 
#           axis.title = element_text(size = 12))
# 
#    plotNormality
   
  
```


## PLOTS OF GBM STATS

## Plot relative influence for age and forest class

Here a graph of the gbm relative influence for age and cover class is plotted.

```{r plotRelInf, echo=FALSE}
dev.new()

statsGBM_AB10 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/statsGBM"))
studyArea <- rep("AB", each = nrow(statsGBM_AB10))
ageClasses <- rep("10", each = nrow(statsGBM_AB10))
statsGBM_AB10 <- cbind(statsGBM_AB10, studyArea, ageClasses)


statsGBM_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/statsGBM"))
studyArea <- rep("AB", each = nrow(statsGBM_AB20))
ageClasses <- rep("20", each = nrow(statsGBM_AB20))
statsGBM_AB20 <- cbind(statsGBM_AB20, studyArea, ageClasses)


statsGBM_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/statsGBM"))
studyArea <- rep("BC", each = nrow(statsGBM_BC10))
ageClasses <- rep("10", each = nrow(statsGBM_BC10))
statsGBM_BC10 <- cbind(statsGBM_BC10, studyArea, ageClasses)


statsGBM_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/statsGBM"))
studyArea <- rep("BC", each = nrow(statsGBM_BC20))
ageClasses <- rep("20", each = nrow(statsGBM_BC20))
statsGBM_BC20 <- cbind(statsGBM_BC20, studyArea, ageClasses)


statsGBM <- rbind(statsGBM_AB10, statsGBM_AB20, statsGBM_BC10, statsGBM_BC20)
#statsGBM$ageClasses <- as.numeric(statsGBM$ageClasses)

# autoCorStats <- gather(data=statsGBM, key="binningType", value="autocorStat", autocor1DRes, autocor2DRes, -studyArea, -ageClasses, -birdSp)
# autoCorStats <- unite(autoCorStats, dataset, c(binningType, ageClasses), remove=FALSE)
statsGBM <- statsGBM[,c(2,5:7)]
statsGBM <-na.omit(statsGBM)

plotRelInf <- ggplot(data = statsGBM,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= relInfAge, 
                                x= ageClasses)) + 
    geom_boxplot() +
    ggtitle("Relative influence of forest age \namong species") +
    #xlab()  +
    ylab("Relative influence of age (%)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("10" = "10-yr age \nclasses", "20" = "20-yr age \nclasses"))  + 
    theme_classic() + 
   scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotRelInf
   
   
```

#plot friedman's h stat

```{r plotFriedmansH, echo=FALSE}
dev.new()

statsGBM_AB10 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/statsGBM"))
studyArea <- rep("AB", each = nrow(statsGBM_AB10))
ageClasses <- rep("10", each = nrow(statsGBM_AB10))
statsGBM_AB10 <- cbind(statsGBM_AB10, studyArea, ageClasses)


statsGBM_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/statsGBM"))
studyArea <- rep("AB", each = nrow(statsGBM_AB20))
ageClasses <- rep("20", each = nrow(statsGBM_AB20))
statsGBM_AB20 <- cbind(statsGBM_AB20, studyArea, ageClasses)


statsGBM_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/statsGBM"))
studyArea <- rep("BC", each = nrow(statsGBM_BC10))
ageClasses <- rep("10", each = nrow(statsGBM_BC10))
statsGBM_BC10 <- cbind(statsGBM_BC10, studyArea, ageClasses)


statsGBM_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/statsGBM"))
studyArea <- rep("BC", each = nrow(statsGBM_BC20))
ageClasses <- rep("20", each = nrow(statsGBM_BC20))
statsGBM_BC20 <- cbind(statsGBM_BC20, studyArea, ageClasses)


statsGBM <- rbind(statsGBM_AB10, statsGBM_AB20, statsGBM_BC10, statsGBM_BC20)
#statsGBM$ageClasses <- as.numeric(statsGBM$ageClasses)

# autoCorStats <- gather(data=statsGBM, key="binningType", value="autocorStat", autocor1DRes, autocor2DRes, -studyArea, -ageClasses, -birdSp)
# autoCorStats <- unite(autoCorStats, dataset, c(binningType, ageClasses), remove=FALSE)
statsGBM <- statsGBM[,c(2,3,6,7)]
statsGBM <-na.omit(statsGBM)

plotFrH <- ggplot(data = statsGBM,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= FriedmansHStat, 
                                x= ageClasses)) + 
    geom_boxplot() +
    ggtitle("Interaction between forest class and age \nacross species") +
    #xlab()  +
    ylab("Friedman's H-statistic") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("10" = "10-yr age \nclasses", "20" = "20-yr age \nclasses"))  + 
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotFrH
   
   
```



## Both rel inf and friedman
```{r plotBothRelInfAndFriedmansH, echo=FALSE}


statsGBM_AB10 <- as.data.frame(read_csv("statsGBM"))
studyArea <- rep("AB", each = nrow(statsGBM_AB10))
ageClasses <- rep("10", each = nrow(statsGBM_AB10))
statsGBM_AB10 <- cbind(statsGBM_AB10, studyArea, ageClasses)


# statsGBM_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/statsGBM"))
# studyArea <- rep("AB", each = nrow(statsGBM_AB20))
# ageClasses <- rep("20", each = nrow(statsGBM_AB20))
# statsGBM_AB20 <- cbind(statsGBM_AB20, studyArea, ageClasses)


# statsGBM_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/statsGBM"))
# studyArea <- rep("BC", each = nrow(statsGBM_BC10))
# ageClasses <- rep("10", each = nrow(statsGBM_BC10))
# statsGBM_BC10 <- cbind(statsGBM_BC10, studyArea, ageClasses)


statsGBM_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/statsGBM"))
studyArea <- rep("BC", each = nrow(statsGBM_BC20))
ageClasses <- rep("20", each = nrow(statsGBM_BC20))
statsGBM_BC20 <- cbind(statsGBM_BC20, studyArea, ageClasses)


statsGBM <- rbind( statsGBM_AB20, statsGBM_BC20)
#statsGBM$ageClasses <- as.numeric(statsGBM$ageClasses)

# autoCorStats <- gather(data=statsGBM, key="binningType", value="autocorStat", autocor1DRes, autocor2DRes, -studyArea, -ageClasses, -birdSp)
# autoCorStats <- unite(autoCorStats, dataset, c(binningType, ageClasses), remove=FALSE)

statsRelInf <- statsGBM[,c(2,5:7)]
statsRelInf <-na.omit(statsRelInf)
# 
plotRelInf <- ggplot(data = statsRelInf,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")),
                                y= relInfAge,
                                x= ageClasses)) +
    geom_boxplot() +
    ggtitle("Relative influence of forest age \namong species") +
    #xlab()  +
    ylab("Relative influence of age (%)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    #scale_x_discrete(labels=c("20" = "20-yr age \nclasses"))  +
    theme_classic() +
   scale_fill_manual(values=c("#009E73", "#56B4E9"),
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.line.y = element_line(linewidth = 1),
          axis.ticks.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"),
          axis.title.x = element_blank()
          )

 plotRelInf 
 
 
statsFriH <- statsGBM[,c(2,3,6,7)]
statsFriH <-na.omit(statsFriH)

plotFrH <- ggplot(data = statsFriH,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= FriedmansHStat, 
                                x= ageClasses)) + 
    geom_boxplot() +
    ggtitle("Interaction between forest class and age \nacross species") +
    #xlab()  +
    ylab("Friedman's H-statistic") +
    scale_y_continuous(breaks= pretty_breaks()) +
    #scale_x_discrete(labels=c("10" = "10-yr age \nclasses", "20" = "20-yr age \nclasses"))  + 
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_blank(), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.line.y = element_line(linewidth = 1),
          axis.ticks.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"),
          axis.title.x = element_blank()
          )

 plotFrH



#plot_grid(plotRelInf, plotFrH, labels = c('A', 'B'), label_size = 12)
  dev.new() 
  allMatrixPlot <- ggarrange(plotFrH +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotRelInf +
                             theme(title = element_blank())
                           ,
                           ncol = 1,
                           labels = c("A", "B"),
                           label.args = list(gp=gpar(font=4, fontsize = 16), x=unit(1,"line"), hjust=1)
                            ) 
  


```




## PLOTS OF MAP STATS

#spearman Stats (all datasets)
```{r plotSpearman, echo=FALSE}

spearmanStats_AB10 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/spearmanStats.csv"))
studyArea <- rep("AB", each = nrow(spearmanStats_AB10))
ageClasses <- rep("10", each = nrow(spearmanStats_AB10))
spearmanStats_AB10 <- cbind(spearmanStats_AB10, studyArea, ageClasses)
spearmanStats_AB10[,2] <- NA

spearmanStats_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/spearmanStats.csv"))
studyArea <- rep("AB", each = nrow(spearmanStats_AB20))
ageClasses <- rep("20", each = nrow(spearmanStats_AB20))
spearmanStats_AB20 <- cbind(spearmanStats_AB20, studyArea, ageClasses)

spearmanStats_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/spearmanStats.csv"))
studyArea <- rep("BC", each = nrow(spearmanStats_BC10))
ageClasses <- rep("10", each = nrow(spearmanStats_BC10))
spearmanStats_BC10 <- cbind(spearmanStats_BC10, studyArea, ageClasses)
spearmanStats_BC10[,2] <- NA

spearmanStats_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/spearmanStats.csv"))
studyArea <- rep("BC", each = nrow(spearmanStats_BC20))
ageClasses <- rep("20", each = nrow(spearmanStats_BC20))
spearmanStats_BC20 <- cbind(spearmanStats_BC20, studyArea, ageClasses)

spearmanStats <- rbind(spearmanStats_AB10, spearmanStats_AB20, spearmanStats_BC10, spearmanStats_BC20)
names(spearmanStats)[names(spearmanStats) == '...1'] <- 'birdSp'
spearmanStats$ageClasses <- as.numeric(spearmanStats$ageClasses)

spearmanStats <- gather(data=spearmanStats, key="binningType", value="spearmanStat", -studyArea, -ageClasses, -birdSp)
spearmanStats <- unite(spearmanStats, dataset, c(binningType, ageClasses), remove=FALSE)
spearmanStats <-na.omit(spearmanStats)

plotSpearmanStats <- ggplot(data = spearmanStats,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= spearmanStat, 
                                x= dataset)) + 
    geom_boxplot() +
    ggtitle("Correlation between BAM national models \nand mapped predictions, across bird species") +
    #xlab()  +
    scale_x_discrete(labels=c("spearman1D_20" = "1D", "spearman2D_10" = "2D \n(10-yr)", "spearman2D_20" = "2D \n(20-yr)"))  + 
    ylab("Spearman's coefficient (ρ)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 15),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

     plotSpearmanStats


```


#autocor Stats (all datasets)
```{r plotAutocorStats, echo=FALSE}

resStats_AB10 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/resStats.csv"))
studyArea <- rep("AB", each = nrow(resStats_AB10))
ageClasses <- rep("10", each = nrow(resStats_AB10))
resStats_AB10 <- cbind(resStats_AB10, studyArea, ageClasses)
resStats_AB10[,4] <- NA
resStats_AB10 <- resStats_AB10[,c(1,4:7)]

resStats_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/resStats.csv"))
studyArea <- rep("AB", each = nrow(resStats_AB20))
ageClasses <- rep("20", each = nrow(resStats_AB20))
resStats_AB20 <- cbind(resStats_AB20, studyArea, ageClasses)
resStats_AB20 <- resStats_AB20[,c(1,4:7)]

resStats_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/resStats.csv"))
studyArea <- rep("BC", each = nrow(resStats_BC10))
ageClasses <- rep("10", each = nrow(resStats_BC10))
resStats_BC10 <- cbind(resStats_BC10, studyArea, ageClasses)
resStats_BC10[,4] <- NA
resStats_BC10 <- resStats_BC10[,c(1,4:7)]

resStats_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/resStats.csv"))
studyArea <- rep("BC", each = nrow(resStats_BC20))
ageClasses <- rep("20", each = nrow(resStats_BC20))
resStats_BC20 <- cbind(resStats_BC20, studyArea, ageClasses)
resStats_BC20 <- resStats_BC20[,c(1,4:7)]

resStats <- rbind(resStats_AB10, resStats_AB20, resStats_BC10, resStats_BC20)
names(resStats)[names(resStats) == '...1'] <- 'birdSp'
resStats$ageClasses <- as.numeric(resStats$ageClasses)

autoCorStats <- gather(data=resStats, key="binningType", value="autocorStat", autocor1DRes, autocor2DRes, -studyArea, -ageClasses, -birdSp)
autoCorStats <- unite(autoCorStats, dataset, c(binningType, ageClasses), remove=FALSE)
autoCorStats <-na.omit(autoCorStats)

plotAutocorStats <- ggplot(data = autoCorStats,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= autocorStat, 
                                x= dataset)) + 
    geom_boxplot() +
    ggtitle("Spatial autocorrelation of mapped residuals, \nacross bird species") +
    #xlab()  +
    ylab("Moran's I") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("autocor1DRes_20" = "1D", "autocor2DRes_10" = "2D \n(10-yr)", "autocor2DRes_20" = "2D \n(20-yr)"))  + 
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotAutocorStats
   
   
```


#median residual Stats (all datasets)
```{r plotMedResStats, echo=FALSE}

resStats_AB10 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/resStats.csv"))
studyArea <- rep("AB", each = nrow(resStats_AB10))
ageClasses <- rep("10", each = nrow(resStats_AB10))
resStats_AB10 <- cbind(resStats_AB10, studyArea, ageClasses)
resStats_AB10[,2] <- NA
resStats_AB10 <- resStats_AB10[,c(1:3,6,7)]

resStats_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/resStats.csv"))
studyArea <- rep("AB", each = nrow(resStats_AB20))
ageClasses <- rep("20", each = nrow(resStats_AB20))
resStats_AB20 <- cbind(resStats_AB20, studyArea, ageClasses)
resStats_AB20 <- resStats_AB20[,c(1:3,6,7)]

resStats_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/resStats.csv"))
studyArea <- rep("BC", each = nrow(resStats_BC10))
ageClasses <- rep("10", each = nrow(resStats_BC10))
resStats_BC10 <- cbind(resStats_BC10, studyArea, ageClasses)
resStats_BC10[,2] <- NA
resStats_BC10 <- resStats_BC10[,c(1:3,6,7)]

resStats_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/resStats.csv"))
studyArea <- rep("BC", each = nrow(resStats_BC20))
ageClasses <- rep("20", each = nrow(resStats_BC20))
resStats_BC20 <- cbind(resStats_BC20, studyArea, ageClasses)
resStats_BC20 <- resStats_BC20[,c(1:3,6,7)]

resStats <- rbind(resStats_AB10, resStats_AB20, resStats_BC10, resStats_BC20)
names(resStats)[names(resStats) == '...1'] <- 'birdSp'
resStats$ageClasses <- as.numeric(resStats$ageClasses)

medResStats <- gather(data=resStats, key="binningType", value= "medianResStat",
median1DRes, median2DRes, -studyArea, -ageClasses, -birdSp)
medResStats <- unite(medResStats, dataset, c(binningType, ageClasses), remove=FALSE)
medResStats <-na.omit(medResStats)

plotMedRes <- ggplot(data = medResStats,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= medianResStat, 
                                x= dataset)) + 
    geom_boxplot() +
    ggtitle("Median value of residuals per bird species") +
    #xlab()  +
    ylab("Median residual value") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("median1DRes_20" = "1D bins", "median2DRes_10" = "2D bins \n(10yr)", "median2DRes_20" = "2D bins \n(20yr)"))  + 
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0.5,0.5, "cm"))

   plotMedRes
   
   




```


#Combined unimodality, spearman and morans 

```{r plotCombinedUnimodSpearAndMoran, echo=FALSE}

#get data tables needed
assumptionsByClass1D_1 <- as.data.table(read_csv("Results/PS results AB 20 yr age classes boot ras/assumptionsByClass1D.csv"))
assumptionsByClass1D_1 <- assumptionsByClass1D_1[7:13]
assumptionsByClass1D_1  <- droplevels(assumptionsByClass1D_1)
studyArea <- rep("AB", each = nrow(assumptionsByClass1D_1))
ageClasses <- rep("20", each = nrow(assumptionsByClass1D_1))
assumptionsByClass1D_1 <- cbind(assumptionsByClass1D_1, studyArea, ageClasses)
names(assumptionsByClass1D_1)[names(assumptionsByClass1D_1) == 'landForClass'] <- 'landAgeClass'

assumptionsByClass1D_2 <- as.data.table(read_csv("Results/PS results BC 20 yr age classes boot ras/assumptionsByClass1D.csv"))
assumptionsByClass1D_2 <- assumptionsByClass1D_2[7:13]
assumptionsByClass1D_2  <- droplevels(assumptionsByClass1D_2)
studyArea <- rep("BC", each = nrow(assumptionsByClass1D_2))
ageClasses <- rep("20", each = nrow(assumptionsByClass1D_2))
assumptionsByClass1D_2 <- cbind(assumptionsByClass1D_2, studyArea, ageClasses)
names(assumptionsByClass1D_2)[names(assumptionsByClass1D_2) == 'landForClass'] <- 'landAgeClass'

# assumptionsByClass2D_1 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/assumptionsByClass2D.csv"))
# studyArea <- rep("AB", each = nrow(assumptionsByClass2D_1))
# ageClasses <- rep("10", each = nrow(assumptionsByClass2D_1))
# assumptionsByClass2D_1 <- cbind(assumptionsByClass2D_1, studyArea, ageClasses)

assumptionsByClass2D_2 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/assumptionsByClass2D.csv"))
studyArea <- rep("AB", each = nrow(assumptionsByClass2D_2))
ageClasses <- rep("20", each = nrow(assumptionsByClass2D_2))
assumptionsByClass2D_2 <- cbind(assumptionsByClass2D_2, studyArea, ageClasses)

# assumptionsByClass2D_3 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/assumptionsByClass2D.csv"))
# studyArea <- rep("BC", each = nrow(assumptionsByClass2D_3))
# ageClasses <- rep("10", each = nrow(assumptionsByClass2D_3))
# assumptionsByClass2D_3 <- cbind(assumptionsByClass2D_3, studyArea, ageClasses)

assumptionsByClass2D_4 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/assumptionsByClass2D.csv"))
studyArea <- rep("BC", each = nrow(assumptionsByClass2D_4))
ageClasses <- rep("20", each = nrow(assumptionsByClass2D_4))
assumptionsByClass2D_4 <- cbind(assumptionsByClass2D_4, studyArea, ageClasses)

assumptionsByClass <- rbind(assumptionsByClass1D_1, assumptionsByClass1D_2, assumptionsByClass2D_2, assumptionsByClass2D_4)
assumptionsByClass <- unite(assumptionsByClass, dataset, c(binningType, ageClasses), remove=FALSE)

 #normality plot
   plotUnimodality <- ggplot(data = assumptionsByClass, 
                                aes(fill = factor(studyArea, levels=c("BC", "AB")), y= propBirdsUnimodal, x= dataset)) + 
    geom_boxplot() +
    geom_jitter(color="black", size=0.4, alpha=0.9) +
    ggtitle("Proportion of bird species per class \nwith a unimodal distribution (p < 0.05)") +
    xlab("Species")  +
     scale_x_discrete(labels=c("1DBins_20" = "1D", "2DBins_20" = "2D"))  + 
    ylab("Proportion of \nspecies unimodal") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
  theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 14, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0,0.5, "cm"),
         axis.line.y = element_line(linewidth = 1))

   plotUnimodality

##################################################################
   
#    spearmanStats_AB10 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/spearmanStats.csv"))
# studyArea <- rep("AB", each = nrow(spearmanStats_AB10))
# ageClasses <- rep("10", each = nrow(spearmanStats_AB10))
# spearmanStats_AB10 <- cbind(spearmanStats_AB10, studyArea, ageClasses)
# spearmanStats_AB10[,2] <- NA

spearmanStats_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/spearmanStats.csv"))
studyArea <- rep("AB", each = nrow(spearmanStats_AB20))
ageClasses <- rep("20", each = nrow(spearmanStats_AB20))
spearmanStats_AB20 <- cbind(spearmanStats_AB20, studyArea, ageClasses)

# spearmanStats_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/spearmanStats.csv"))
# studyArea <- rep("BC", each = nrow(spearmanStats_BC10))
# ageClasses <- rep("10", each = nrow(spearmanStats_BC10))
# spearmanStats_BC10 <- cbind(spearmanStats_BC10, studyArea, ageClasses)
# spearmanStats_BC10[,2] <- NA

spearmanStats_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/spearmanStats.csv"))
studyArea <- rep("BC", each = nrow(spearmanStats_BC20))
ageClasses <- rep("20", each = nrow(spearmanStats_BC20))
spearmanStats_BC20 <- cbind(spearmanStats_BC20, studyArea, ageClasses)

spearmanStats <- rbind( spearmanStats_AB20, spearmanStats_BC20)
names(spearmanStats)[names(spearmanStats) == '...1'] <- 'birdSp'
spearmanStats$ageClasses <- as.numeric(spearmanStats$ageClasses)

spearmanStats <- gather(data=spearmanStats, key="binningType", value="spearmanStat", -studyArea, -ageClasses, -birdSp)
spearmanStats <- unite(spearmanStats, dataset, c(binningType, ageClasses), remove=FALSE)
spearmanStats <-na.omit(spearmanStats)

plotSpearmanStats <- ggplot(data = spearmanStats,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= spearmanStat, 
                                x= dataset)) + 
    geom_boxplot() +
    ggtitle("Correlation between BAM national models \nand mapped predictions, across bird species") +
    #xlab()  +
    scale_x_discrete(labels=c("spearman1D_20" = "1D", "spearman2D_20" = "2D"))  + 
    ylab("Spearman's \ncoefficient (ρ)") +
    scale_y_continuous(breaks= pretty_breaks()) +
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 15),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 12, angle = 45, hjust = 1), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0,0.5, "cm"),
           axis.line.y = element_line(linewidth = 1))

     plotSpearmanStats

##################################################################
     
# resStats_AB10 <- as.data.frame(read_csv("Results/PS results AB 10 yr age classes boot ras/resStats.csv"))
# studyArea <- rep("AB", each = nrow(resStats_AB10))
# ageClasses <- rep("10", each = nrow(resStats_AB10))
# resStats_AB10 <- cbind(resStats_AB10, studyArea, ageClasses)
# resStats_AB10[,4] <- NA
# resStats_AB10 <- resStats_AB10[,c(1,4:7)]

resStats_AB20 <- as.data.frame(read_csv("Results/PS results AB 20 yr age classes boot ras/resStats.csv"))
studyArea <- rep("AB", each = nrow(resStats_AB20))
ageClasses <- rep("20", each = nrow(resStats_AB20))
resStats_AB20 <- cbind(resStats_AB20, studyArea, ageClasses)
resStats_AB20 <- resStats_AB20[,c(1,4:7)]

# resStats_BC10 <- as.data.frame(read_csv("Results/PS results BC 10 yr age classes boot ras/resStats.csv"))
# studyArea <- rep("BC", each = nrow(resStats_BC10))
# ageClasses <- rep("10", each = nrow(resStats_BC10))
# resStats_BC10 <- cbind(resStats_BC10, studyArea, ageClasses)
# resStats_BC10[,4] <- NA
# resStats_BC10 <- resStats_BC10[,c(1,4:7)]

resStats_BC20 <- as.data.frame(read_csv("Results/PS results BC 20 yr age classes boot ras/resStats.csv"))
studyArea <- rep("BC", each = nrow(resStats_BC20))
ageClasses <- rep("20", each = nrow(resStats_BC20))
resStats_BC20 <- cbind(resStats_BC20, studyArea, ageClasses)
resStats_BC20 <- resStats_BC20[,c(1,4:7)]

resStats <- rbind( resStats_AB20,  resStats_BC20)
names(resStats)[names(resStats) == '...1'] <- 'birdSp'
resStats$ageClasses <- as.numeric(resStats$ageClasses)

autoCorStats <- gather(data=resStats, key="binningType", value="autocorStat", autocor1DRes, autocor2DRes, -studyArea, -ageClasses, -birdSp)
autoCorStats <- unite(autoCorStats, dataset, c(binningType, ageClasses), remove=FALSE)
autoCorStats <-na.omit(autoCorStats)

plotAutocorStats <- ggplot(data = autoCorStats,
                            aes(fill = factor(studyArea, levels=c("BC", "AB")), 
                                y= autocorStat, 
                                x= dataset)) + 
    geom_boxplot() +
    ggtitle("Spatial autocorrelation of mapped residuals, \nacross bird species") +
    #xlab()  +
    ylab("Moran's I \n") +
    scale_y_continuous(breaks= pretty_breaks()) +
    scale_x_discrete(labels=c("autocor1DRes_20" = "1D", "autocor2DRes_20" = "2D"))  + 
    theme_classic() + 
    scale_fill_manual(values=c("#009E73", "#56B4E9"), 
                      labels = c( "British Columbia", "Alberta")) +
    theme(title = element_text(size = 16),
          legend.title = element_blank(),
          legend.position= "bottom",
          legend.text = element_text(size =14),
          axis.text.x = element_text(size = 14), 
          axis.text.y = element_text(size = 12),
          axis.title.y = element_text(size = 14),
          axis.title.x = element_blank(),
          plot.margin = margin(0.5,0.5,0,0.5, "cm"),
           axis.line.y = element_line(linewidth = 1))

   plotAutocorStats

 #################################################################  
   dev.new()
   
     allMatrixPlot <- ggarrange(plotUnimodality +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotSpearmanStats +
                             theme(axis.text.x = element_blank(),
                                   axis.title.x = element_blank(),
                                   title = element_blank(),
                                   legend.position= "none")
                           ,
                           plotAutocorStats +
                             theme(title = element_blank())
                           ,
                           ncol = 1,
                           labels = c("A", "B", "C"),
                           label.args = list(gp=gpar(font=4, fontsize = 16), x=unit(1,"line"), hjust=1)
                            ) 

```

## RASTER VISUALISATION 


```{r plotExampleBirdRasters, echo=FALSE}



#for BC

bird <- "OVEN"

nmRas <- terra::rast(paste0("Results/PS results BC 20 yr age classes boot ras/", bird,"-meanBoot_60"))
mapRas <- terra::rast(paste0("Results/PS results BC 20 yr age classes boot ras/", bird, "-for2DAndNf1DMap"))
resRas <- terra::rast(paste0("Results/PS results BC 20 yr age classes boot ras/", bird, "-for2DAndNf1DRes"))

#ageRaster
min_ = min(min(terra::unique(nmRas)), min(terra::unique(mapRas)), min(terra::unique(resRas)))
max_ = max(max(terra::unique(nmRas)), max(terra::unique(mapRas)), max(terra::unique(resRas)))
r.range = c(min_, max_)
#colours <- colourRamp(colors = cbPalette, bias = 2)
layout(matrix(c(1,2,3), 2, 3, byrow = TRUE),
   widths=c(1,1,1.1), heights=c(1,3) )
#nmRasBC <- plot(nmRas, main = 'National Model', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box=FALSE, breaks = c(-0.05, 0, 0.025, 0.05, 0.075, 0.1, 0.125, 0.15, 0.2, 0.25 )) 
#mapRasBC <- plot(mapRas, main = 'Mapped Predictions', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box = FALSE,breaks = c(-0.05, 0, 0.025, 0.05, 0.075, 0.1, 0.125, 0.15, 0.2, 0.25 ))  
nmRasBC <- plot(nmRas, main = 'National Model', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box=FALSE, legend = FALSE, cex.main = 1.5 ) 
mapRasBC <- plot(mapRas, main = 'Mapped Predictions', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box = FALSE, legend = FALSE, cex.main = 1.5)
resRasBC <- plot(resRas, main = 'Residuals', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box = FALSE, cex.main = 1.5, plg=list( cex = 1.25 # Legend text size
            ))


 
#for alberta

bird <- "OVEN"

nmRas <- terra::rast(paste0("Results/PS results AB 20 yr age classes boot ras/", bird,"-meanBoot_60"))
mapRas <- terra::rast(paste0("Results/PS results AB 20 yr age classes boot ras/", bird, "-for2DAndNf1DMap"))
resRas <- terra::rast(paste0("Results/PS results AB 20 yr age classes boot ras/", bird, "-for2DAndNf1DRes"))

#ageRaster
min_ = min(min(terra::unique(nmRas)), min(terra::unique(mapRas)), min(terra::unique(resRas)))
max_ = max(max(terra::unique(nmRas)), max(terra::unique(mapRas)), max(terra::unique(resRas)))
r.range = c(min_, max_)

layout(matrix(c(1,2,3), 2, 3, byrow = TRUE),
   widths=c(1,1,1.1), heights=c(1,3) )

plot(nmRas, main = 'National Model', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box=FALSE, legend = FALSE, cex.main = 1.5 ) 
plot(mapRas, main = 'Mapped Predictions', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box = FALSE, legend = FALSE, cex.main = 1.5)
plot(resRas, main = 'Residuals', colNA="white", range = r.range, col = cbPalette, axes=FALSE, box = FALSE, cex.main = 1.5, plg=list( cex = 1.25 # Legend text size
            ))

```